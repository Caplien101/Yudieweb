<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stock Opname Bean Spot</title>
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f8f9fa; padding: 20px; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .row-baris { margin-bottom: 10px; }
        .label-input { font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; }
        input[type="number"], input[type="text"] { width: 100%; font-size: 16px; } /* Prevent iOS zoom */
        .category-section { 
            background-color: #e9ecef; 
            padding: 10px; 
            margin: -16px -16px 10px -16px; /* Full-width grey background */
            border-top-left-radius: 0.375rem; /* Match card border radius */
            border-top-right-radius: 0.375rem;
        }
        #search-container {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: #f8f9fa;
            padding: 10px 10px 20px 10px;
            margin-bottom: 20px;
        }
        #search { 
        margin-bottom: 0;
        border-color: #0041C7;
        text-color: #e9ecef;
        }
        #updateBtn { 
            margin: 20px auto; 
            display: block; /* Center button horizontally */
        }
        .loading-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 9999; 
            justify-content: center; 
            align-items: center; 
        }
        .spinner-border { width: 3rem; height: 3rem; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
    </style>
</head>
<body>
    <div class="container">
        <div id="search-container">
            <input type="text" id="search" class="form-control text-secondary" placeholder="Cari Category,Description,Plu..">
        </div>
        <h2 class="mb-4 text-primary text-center">Stock Opname Bean Spot</h2>
        <div id="dataContainer" class="row"></div>
        <button id="updateBtn" class="btn btn-success">Update Data</button>
    </div>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <!-- Toast Container -->
    <div class="toast-container">
        <div class="toast" id="successToast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                Data updated successfully!
            </div>
        </div>
    </div>

    <!-- Bootstrap JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // Replace these with your actual Google Apps Script web app URLs
        const getUrl = 'https://script.google.com/macros/s/AKfycbw3-YmHcV489wg6xEtplX5l_00zXIJvizWotnhiQVjakmK2OWQwcT6vbAANzYq2vr3v/exec'; // URL for GET data
        const updateUrl = 'https://script.google.com/macros/s/AKfycbw3-YmHcV489wg6xEtplX5l_00zXIJvizWotnhiQVjakmK2OWQwcT6vbAANzYq2vr3v/exec'; // URL for POST updates

        // Show/Hide Loading
        function toggleLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // Show Toast
        function showToast() {
            const toast = new bootstrap.Toast(document.getElementById('successToast'));
            toast.show();
        }

        // Load data on page load
        window.addEventListener('load', () => loadData(false));

        function loadData(filterNonZeroSelisih = false) {
            toggleLoading(true);
            fetch(getUrl)
                .then(response => response.json())
                .then(json => {
                    if (json.status === 'success') {
                        const filteredData = filterNonZeroSelisih ? json.data.filter(item => item.Selisih !== 0) : json.data;
                        displayData(filteredData);
                        applyLocalChanges();
                    } else {
                        alert('Failed to load data');
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    alert('Error loading data from Google Sheets');
                })
                .finally(() => toggleLoading(false));
        }

        function displayData(data) {
            const container = document.getElementById('dataContainer');
            container.innerHTML = '';
            data.forEach(item => {
                const localDate = new Date(item.LastUpdate).toLocaleDateString('id-ID', { timeZone: 'Asia/Jakarta' }); // Hanya tanggal
                const card = document.createElement('div');
                card.className = 'col-12 col-md-4';
                card.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <div class="row row-baris category-section">
                                <div class="col-6">${item.CATEGORY}</div>
                                <div class="col-6 text-end lastupdate">${localDate}</div>
                            </div>
                            <div class="row row-baris">
                                <div class="col-4">${item.PLU}</div>
                                <div class="col-8">${item.DESCRIPTION}</div>
                            </div>
                            <div class="row">
                                <div class="col-4">
                                    <div class="label-input text-center">Fisik</div>
                                    <input type="number" class="form-control fisik text-center" data-plu="${item.PLU}" value="${item.Fisik}">
                                </div>
                                <div class="col-4">
                                    <div class="label-input text-center">On Hand</div>
                                    <input type="number" class="form-control onhand text-center" data-plu="${item.PLU}" value="${item['On Hand']}">
                                </div>
                                <div class="col-4">
                                    <div class="label-input text-center">Selisih</div>
                                    <input type="text" class="form-control selisih text-center" value="${item.Selisih}" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            addEventListeners();
        }

        function addEventListeners() {
            document.querySelectorAll('.onhand, .fisik').forEach(input => {
                input.addEventListener('change', handleChange);
            });
        }

        function handleChange(event) {
            const row = event.target.closest('.row');
            const cardBody = event.target.closest('.card-body');
            const plu = event.target.dataset.plu;
            const onhand = parseFloat(row.querySelector('.onhand').value) || 0;
            const fisik = parseFloat(row.querySelector('.fisik').value) || 0;
            const selisih = fisik - onhand; // Assuming Selisih = Fisik - On Hand
            const lastUpdateUTC = new Date().toISOString(); // UTC for storage
            const lastUpdateLocal = new Date().toLocaleDateString('id-ID', { timeZone: 'Asia/Jakarta' }); // Hanya tanggal untuk display

            row.querySelector('.selisih').value = selisih;
            cardBody.querySelector('.lastupdate').textContent = lastUpdateLocal;

            saveToLocal(plu, onhand, fisik, selisih, lastUpdateUTC);
        }

        function saveToLocal(plu, onhand, fisik, selisih, lastUpdate) {
            let updates = JSON.parse(localStorage.getItem('updates')) || {};
            updates[plu] = { 'On Hand': onhand, Fisik: fisik, Selisih: selisih, LastUpdate: lastUpdate };
            localStorage.setItem('updates', JSON.stringify(updates));
        }

        function applyLocalChanges() {
            const updates = JSON.parse(localStorage.getItem('updates')) || {};
            Object.entries(updates).forEach(([plu, vals]) => {
                const onhandInput = document.querySelector(`.onhand[data-plu="${plu}"]`);
                const fisikInput = document.querySelector(`.fisik[data-plu="${plu}"]`);
                if (onhandInput && fisikInput) {
                    onhandInput.value = vals['On Hand'];
                    fisikInput.value = vals.Fisik;
                    const row = onhandInput.closest('.row');
                    const cardBody = onhandInput.closest('.card-body');
                    row.querySelector('.selisih').value = vals.Selisih;
                    const localDate = new Date(vals.LastUpdate).toLocaleDateString('id-ID', { timeZone: 'Asia/Jakarta' });
                    cardBody.querySelector('.lastupdate').textContent = localDate;
                }
            });
        }

        // Search functionality
        document.getElementById('search').addEventListener('keyup', (event) => {
            const searchTerm = event.target.value.toLowerCase();
            const cards = document.querySelectorAll('#dataContainer .card');
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.closest('.col-12').style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // Update button to send batch updates and clear localStorage
        document.getElementById('updateBtn').addEventListener('click', () => {
            const updates = JSON.parse(localStorage.getItem('updates')) || {};
            if (Object.keys(updates).length === 0) {
                alert('No changes to update');
                localStorage.clear(); // Clear localStorage if no updates
                loadData(false); // Reload all data from Google Sheets
                return;
            }

            toggleLoading(true);
            fetch(updateUrl, {
                method: 'POST',
                
                body: JSON.stringify({ data: Object.entries(updates).map(([plu, vals]) => ({
                    PLU: plu,
                    'On Hand': vals['On Hand'],
                    Fisik: vals.Fisik,
                    Selisih: vals.Selisih,
                    LastUpdate: vals.LastUpdate
                })) })
            })
            .then(response => response.json())
            .then(json => {
                if (json.status === 'success') {
                    localStorage.clear(); // Clear localStorage on success
                    showToast();
                    loadData(true); // Reload data, only showing items with Selisih != 0
                } else {
                    alert('Failed to update data');
                }
            })
            .catch(error => {
                console.error('Error updating data:', error);
                alert('Error updating data to Google Sheets');
            })
            .finally(() => toggleLoading(false));
        });
    </script>
</body>
</html>
