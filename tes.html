<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Serah Terima Shift</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4f46e5; --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
      --background: #f8fafc; --card: #ffffff; --text-dark: #1e293b; --text-muted: #64748b; --border: #e2e8f0;
    }

    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent; 
      font-family: 'Inter', sans-serif; 
    }

    body { 
      margin: 0; 
      background: var(--background); 
      color: var(--text-dark); 
      min-height: 100vh; 
      overflow-x: hidden;
      font-size: 13px; /* Lebih kecil untuk mobile */
    }

    /* Loader Spinner */
    #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    .spinner { width: 32px; height: 32px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    header { 
      background: white; 
      padding: 8px 12px; 
      border-bottom: 1px solid var(--border); 
      position: sticky; 
      top: 0; 
      z-index: 100; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
    }
    header span { font-size: 13px; font-weight: 800; }

    .container { padding: 8px; max-width: 500px; margin: 0 auto; width: 100%; }
    .hidden { display: none !important; }

    /* Dashboard UI lebih compact */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 12px;
    }

    .nav-card {
      background: var(--card);
      border-radius: 10px;
      padding: 10px 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--border);
      box-shadow: 0 1px 3px rgba(0,0,0,0.03);
      transition: all 0.2s ease;
      text-align: center;
      cursor: pointer;
    }

    .nav-card:active { transform: scale(0.96); background: #f1f5f9; }

    .nav-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .icon-master { background: #e0e7ff; color: #4f46e5; }
    .icon-opname { background: #dcfce7; color: #10b981; }

    .nav-text h3 { margin: 0; font-size: 12px; font-weight: 700; color: var(--text-dark); }
    .nav-text p { display: none; }

    .user-greeting {
      font-size: 11px;
      color: var(--success);
      margin-bottom: 6px;
      font-weight: 600;
      min-height: 14px;
    }

    /* Cards lebih rapat */
    .data-card { 
      background: var(--card); 
      border-radius: 8px; 
      padding: 8px 10px; 
      margin-bottom: 6px; 
      border: 1px solid var(--border); 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      gap: 8px;
    }
    .data-card.filled { border-left: 4px solid var(--success); background: #f0fdf4; }

    .card-info { flex: 1; }
    .card-info h4 { margin: 0 0 2px 0; font-size: 12px; line-height: 1.2; }
    .card-info p { margin: 0; font-size: 9px; color: var(--text-muted); }

    .qty-badge { background: #e0e7ff; color: var(--primary); padding: 2px 5px; border-radius: 5px; font-weight: 700; font-size: 10px; }
    .badge { 
      background: #f1f5f9; color: #475569; padding: 2px 6px; border-radius: 4px; 
      font-size: 9px; font-weight: 600; border: 1px solid var(--border);
      display: inline-flex; align-items: center; margin-bottom: 4px;
    }

    .input-group { margin-bottom: 10px; }
    .input-group label { display: block; font-size: 9px; font-weight: 700; color: var(--text-muted); margin-bottom: 3px; text-transform: uppercase; }

    input, select { 
      width: 100%; 
      padding: 8px; 
      border-radius: 6px; 
      border: 1px solid var(--border); 
      font-size: 14px; /* Mencegah auto-zoom */
      margin-bottom: 4px; 
    }
    input[readonly] { background: #f1f5f9; color: #64748b; }

    button { padding: 8px; border-radius: 6px; border: none; font-weight: 600; font-size: 13px; cursor: pointer; }
    .btn-primary { background: var(--primary); color: white; width: 100%; }
    .btn-secondary { background: #e2e8f0; color: var(--text-dark); padding: 6px 10px; font-size: 11px; }

    /* Modal compact */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: flex-end; z-index: 1000; }
    .modal-content { 
      background: white; 
      width: 100%; 
      border-radius: 16px 16px 0 0; 
      padding: 12px; 
      padding-bottom: env(safe-area-inset-bottom);
      max-height: 80vh; 
      overflow-y: auto; 
    }

    .bottom-nav { 
      position: fixed; 
      bottom: 0; left: 0; right: 0; 
      background: white; 
      padding: 8px; 
      padding-bottom: calc(8px + env(safe-area-inset-bottom)); 
      border-top: 1px solid var(--border); 
      display: flex; 
      gap: 6px; 
      max-width: 500px; 
      margin: 0 auto; 
    }

    /* Barcode lebih kecil */
    .bc-svg { max-width: 100px; height: auto; }

    /* Penyesuaian khusus untuk step 2 card */
    #cardListStep2 .data-card {
      flex-direction: column;
      align-items: flex-start;
    }
    #cardListStep2 .data-card > div:first-child {
      width: 100%;
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    #cardListStep2 input[type="number"] {
      width: 70px;
      padding: 4px;
      font-size: 12px;
    }
  </style>
</head>
<body>

<div id="loader" class="hidden"><div class="spinner"></div><p style="margin-top:8px; font-weight:600">Sinkronisasi...</p></div>

<header id="appHeader" class="hidden">
  <span style="font-weight: 800; letter-spacing: -0.5px;">ST SHIFT</span>
  <button onclick="doLogout()" style="background:none; border:none; color: var(--danger); font-size: 11px; font-weight: 800;">LOGOUT</button>
</header>

<div class="container" id="loginPage" style="text-align: center; padding-top: 50px;">
  <div style="font-size: 50px; margin-bottom: 8px;">üõ°Ô∏è</div>
  <h2 style="margin-bottom: 4px; font-size: 20px;">Stock Opname</h2>
  <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 24px;">Login menggunakan NIK</p>
  
  <div class="input-group">
    <input type="text" id="username" placeholder="Masukkan NIK" oninput="handleNIKInput(this.value)">
  </div>
  <div id="displayEmployeeName" class="user-greeting-login" style="font-size:11px; margin-bottom:8px;"></div>
  
  <div class="input-group">
    <input type="password" id="password" placeholder="Password">
  </div>
  <button class="btn-primary" onclick="doLogin()">Masuk</button>
</div>

<div class="container hidden" id="dashboard">
  <div style="margin-bottom: 16px;">
    <h2 style="margin: 0; font-size: 20px;">Halo, <span id="displayUser" style="color: var(--primary);">User</span> üëã</h2>
    <p id="displayNIK" style="margin: 2px 0 0 0; font-size: 11px; color: var(--text-muted);"></p>
  </div>

  <div class="dashboard-grid">
    <div class="nav-card" onclick="openMaster()">
      <div class="nav-icon icon-master">üìÇ</div>
      <div class="nav-text"><h3>Master Data</h3></div>
    </div>
    <div class="nav-card" onclick="openOpname()">
      <div class="nav-icon icon-opname">üìù</div>
      <div class="nav-text"><h3>Mulai Opname</h3></div>
    </div>
  </div>
</div>

<div class="container hidden" id="masterPage">
  <div style="display:flex; align-items: center; gap: 8px; margin-bottom: 12px;">
    <button onclick="showPage('dashboard')" class="btn-secondary" style="padding:6px 10px;">‚Üê</button>
    <input type="text" id="searchMaster" oninput="filterMaster()" placeholder="Cari PLU / Nama..." style="margin-bottom:0; font-size:13px;">
  </div>
  <div id="cardListMaster"></div>
</div>

<div class="container hidden" id="opnamePage" style="padding-bottom: 80px;">
  <div id="step1Content">
    <div style="margin-bottom: 10px;"><small><b>STEP 1:</b> INPUT DISPLAY</small></div>
    <input type="text" id="filterOpname" oninput="applyFilter()" placeholder="Cari barang display...">
    <div id="cardListStep1"></div>
    <div class="bottom-nav">
      <button class="btn-secondary" onclick="showPage('dashboard')">Batal</button>
      <button class="btn-primary" onclick="goStep2()">Lanjut</button>
    </div>
  </div>

  <div id="step2Content" class="hidden">
    <div style="margin-bottom: 10px;"><small><b>STEP 2:</b> DATA PENERIMAAN</small></div>
    <select id="shift" style="margin-bottom:8px;"><option value="">Pilih Shift</option><option>Pagi</option><option>Siang</option><option>Malam</option></select>
    <div class="input-group">
      <label>Penyerah (Login)</label>
      <input type="text" id="penyerah" readonly>
    </div>
    <div class="input-group">
      <label>Penerima</label>
      <input type="text" id="penerima" placeholder="Nama penerima...">
    </div>
    <div id="cardListStep2" style="margin-top:16px;"></div>
    <div class="bottom-nav">
      <button class="btn-secondary" onclick="setStep(1)">Kembali</button>
      <button class="btn-primary" onclick="goStep3()">Review</button>
    </div>
  </div>

  <div id="step3Content" class="hidden">
    <div style="margin-bottom: 10px;"><small><b>STEP 3:</b> REVIEW & SINKRONISASI</small></div>
    <div id="cardListStep3"></div>
    <div class="bottom-nav">
      <button class="btn-primary" onclick="finishAll()" style="background:var(--success)">Selesai</button>
    </div>
  </div>
</div>

<div id="modalEntry" class="modal hidden">
  <div class="modal-content">
    <h3 id="modalTitle" style="margin:0 0 4px 0; font-size:16px;">Item</h3>
    <p id="modalPLU" style="color:var(--text-muted); font-size: 11px; margin-bottom: 16px;">PLU: 0000</p>
    
    <div id="modalBodyDisplay">
        <div style="text-align:center; padding: 16px; background: #f8fafc; border-radius: 12px; margin-bottom:16px;">
            <small style="color:var(--text-muted); font-weight:600">Qty Display</small>
            <h1 id="displayTotal" style="margin:4px 0 0 0; color:var(--primary); font-size: 36px;">0</h1>
        </div>
        <input type="number" id="inputAddQty" placeholder="Tambah jumlah..." style="text-align:center; font-size: 18px; margin-bottom:12px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom:8px;">
            <button class="btn-secondary" onclick="resetCurrentQty()">Reset</button>
            <button class="btn-primary" onclick="handleModalSave()">Tambahkan</button>
        </div>
        <button class="btn-secondary" onclick="closeModal()" style="width:100%">Batal</button>
    </div>

    <div id="modalBodyRevisi" class="hidden">
        <div style="margin-bottom: 16px; display: flex; flex-wrap: wrap; gap:4px;">
            <span class="badge">Gudang: <span id="bGd">0</span></span>
            <span class="badge">Mako: <span id="bMk">0</span></span>
            <span class="badge">Disp: <span id="bDs">0</span></span>
            <span class="badge">On Hand: <span id="bOh">0</span></span>
        </div>
        <div class="input-group"><label>Qty Gudang Baru</label><input type="number" id="revG"></div>
        <div class="input-group"><label>Qty Mako (Read Only)</label><input type="number" id="revM" readonly></div>
        <div class="input-group"><label>Qty Display Baru</label><input type="number" id="revD"></div>
        <div class="input-group"><label>Qty On Hand</label><input type="number" id="revOH"></div>
        <div style="display: flex; gap: 8px; margin-top:8px;">
            <button class="btn-primary" onclick="handleModalSave()" style="flex:2">Simpan</button>
            <button class="btn-secondary" onclick="closeModal()" style="flex:1">Batal</button>
        </div>
    </div>
  </div>
</div>

<div id="modalMaster" class="modal hidden">
  <div class="modal-content">
    <h3 style="margin-bottom:16px; font-size:16px;">Update Stok Gudang</h3>
    <div class="input-group"><label>PLU / Nama</label><input type="text" id="mDesc" readonly></div>
    <div class="input-group"><label>Qty Gudang</label><input type="number" id="mQtyG"></div>
    <div class="input-group"><label>Qty Mako (Read Only)</label><input type="number" id="mQtyM" readonly></div>
    <button class="btn-primary" onclick="saveMasterUpdate()" style="margin-bottom:8px;">Update</button>
    <button class="btn-secondary" onclick="closeModal()" style="width:100%">Tutup</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwjqh46cEuJB8kmsRpHBJwD607fPgZCLJeGba6z7B6rvxXEZMOBFhAwJSiFdyRtX6Dt/exec"; 
let masterData = [];
let opnameSession = JSON.parse(localStorage.getItem('opname_session')) || [];
let currentIdx = -1;
let currentMode = "";

async function callGAS(payload) {
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
        return await response.json();
    } catch (err) { console.error(err); throw err; }
}

// LOGIN FEATURES
async function handleNIKInput(nik) {
    const display = document.getElementById('displayEmployeeName');
    if (nik.length >= 4) {
        try {
            const res = await callGAS({ action: 'checkNIK', nik: nik });
            display.innerText = res.status === 'success' ? "Karyawan: " + res.nama : "";
        } catch (e) {}
    } else { display.innerText = ""; }
}

async function doLogin() {
    const user_name = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    if(!user_name || !password) return alert("Lengkapi data!");
    
    toggleLoading(true);
    try {
        const res = await callGAS({ action: 'login', user_name, password });
        if(res.status === 'success') {
            sessionStorage.setItem('isLogged', '1');
            sessionStorage.setItem('userName', res.user);
            sessionStorage.setItem('userNIK', res.nik);
            
            document.getElementById('displayUser').innerText = res.user;
            document.getElementById('displayNIK').innerText = "NIK: " + res.nik;
            
            await initMaster();
            showPage('dashboard');
        } else { alert("NIK/Password Salah!"); }
    } catch(e) { alert("Gagal koneksi ke server."); } 
    finally { toggleLoading(false); }
}

// DASHBOARD & NAVIGATION
function showPage(id) {
    document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    document.getElementById('appHeader').classList.toggle('hidden', id === 'loginPage');
}

function openMaster() { showPage('masterPage'); renderMasterList(); }

function openOpname() {
    if(opnameSession.length === 0) {
        opnameSession = masterData.map(m => ({ ...m, qtyDisplay: 0, qtyOnHand: 0 }));
        localStorage.setItem('opname_session', JSON.stringify(opnameSession));
    }
    document.getElementById('penyerah').value = sessionStorage.getItem('userName');
    showPage('opnamePage');
    setStep(1);
}

// DATA LOGIC
async function initMaster() {
    toggleLoading(true);
    try {
        const res = await callGAS({ action: 'getMaster' });
        masterData = Array.isArray(res) ? res : [];
        renderMasterList();
    } finally { toggleLoading(false); }
}

function renderMasterList() {
    const container = document.getElementById('cardListMaster');
    container.innerHTML = masterData.map((it, i) => `
        <div class="data-card" onclick="openMasterDetailModal(${i})">
            <div class="card-info">
                <h4>${it.description}</h4>
                <p>PLU: ${it.plu} | Mako: ${it.qty_mako}</p>
                <div style="margin-top:4px;"><svg class="bc-svg" data-val="${it.barcode}"></svg></div>
            </div>
            <div class="qty-badge">${it.qty_gudang}</div>
        </div>
    `).join('');
    renderBarcodes();
}

function openMasterDetailModal(i) {
    currentIdx = i; const it = masterData[i];
    document.getElementById('mDesc').value = it.description;
    document.getElementById('mQtyG').value = it.qty_gudang;
    document.getElementById('mQtyM').value = it.qty_mako;
    document.getElementById('modalMaster').classList.remove('hidden');
}

async function saveMasterUpdate() {
    const user = sessionStorage.getItem('userName');
    const plu = masterData[currentIdx].plu;
    const qty = Number(document.getElementById('mQtyG').value);
    toggleLoading(true);
    try {
        await callGAS({ action: 'updateMaster', plu, qty_gudang: qty, user });
        await initMaster();
        closeModal();
    } finally { toggleLoading(false); }
}

// OPNAME STEPS
function setStep(n) {
    [1,2,3].forEach(i => document.getElementById(`step${i}Content`).classList.toggle('hidden', i !== n));
    if(n === 1) renderStep1();
}

function renderStep1() {
    document.getElementById('cardListStep1').innerHTML = opnameSession.map((it, i) => `
        <div class="data-card ${it.qtyDisplay > 0 ? 'filled' : ''}" onclick="openEntryModal(${i}, 'DISPLAY')">
            <div class="card-info"><h4>${it.description}</h4><p>PLU: ${it.plu}</p></div>
            <div class="qty-badge">${it.qtyDisplay}</div>
        </div>
    `).join('');
}

function goStep2() {
    setStep(2);
    document.getElementById('cardListStep2').innerHTML = opnameSession.map((it, i) => `
        <div class="data-card">
            <div>
                <div class="card-info"><h4>${it.description}</h4><p>PLU: ${it.plu}</p></div>
                <input type="number" placeholder="OnHand" value="${it.qtyOnHand || ''}" 
                    onchange="updateFisik(${i}, this.value)" style="width:70px; text-align:center; padding:4px;">
            </div>
            <svg class="bc-svg" data-val="${it.barcode}"></svg>
        </div>
    `).join('');
    renderBarcodes();
}

function updateFisik(i, val) {
    opnameSession[i].qtyOnHand = Number(val);
    localStorage.setItem('opname_session', JSON.stringify(opnameSession));
}

async function goStep3() {
    const shift = document.getElementById('shift').value;
    const pen = document.getElementById('penerima').value;
    if(!shift || !pen) return alert("Pilih Shift & Nama Penerima!");
    
    toggleLoading(true);
    try {
        await callGAS({
            action: 'saveHistory',
            shift, penerima: pen, penyerah: sessionStorage.getItem('userName'),
            items: opnameSession.map(it => ({ ...it, selisih: it.qtyOnHand - (Number(it.qty_gudang) + Number(it.qty_mako) + Number(it.qtyDisplay)) }))
        });
        setStep(3); renderStep3();
    } finally { toggleLoading(false); }
}

function renderStep3() {
    const container = document.getElementById('cardListStep3');
    container.innerHTML = "";
    opnameSession.forEach((it, i) => {
        const totalSis = Number(it.qty_gudang) + Number(it.qty_mako) + Number(it.qtyDisplay);
        const sel = it.qtyOnHand - totalSis;
        if(sel !== 0) {
            container.innerHTML += `
                <div class="data-card">
                    <div class="card-info">
                        <h4>${it.description}</h4>
                        <p>OnHand: ${it.qtyOnHand} | Fisik: ${totalSis} | Sel: <b style="color:${sel<0?'red':'green'}">${sel}</b></p>
                    </div>
                    <button class="btn-secondary" onclick="openEntryModal(${i}, 'REVISI')" style="padding:4px 8px;">Edit</button>
                </div>`;
        }
    });
}

function openEntryModal(i, mode) {
    currentIdx = i; currentMode = mode;
    const it = opnameSession[i];
    document.getElementById('modalTitle').innerText = it.description;
    document.getElementById('modalPLU').innerText = "PLU: " + it.plu;
    
    if(mode === 'DISPLAY') {
        document.getElementById('modalBodyDisplay').classList.remove('hidden');
        document.getElementById('modalBodyRevisi').classList.add('hidden');
        document.getElementById('displayTotal').innerText = it.qtyDisplay || 0;
        document.getElementById('inputAddQty').value = '';
    } else {
        document.getElementById('modalBodyDisplay').classList.add('hidden');
        document.getElementById('modalBodyRevisi').classList.remove('hidden');
        document.getElementById('bGd').innerText = it.qty_gudang;
        document.getElementById('bMk').innerText = it.qty_mako;
        document.getElementById('bDs').innerText = it.qtyDisplay;
        document.getElementById('bOh').innerText = it.qtyOnHand;
        document.getElementById('revG').value = it.qty_gudang;
        document.getElementById('revM').value = it.qty_mako;
        document.getElementById('revD').value = it.qtyDisplay;
        document.getElementById('revOH').value = it.qtyOnHand;
    }
    document.getElementById('modalEntry').classList.remove('hidden');
}

async function handleModalSave() {
    const it = opnameSession[currentIdx];
    if(currentMode === 'DISPLAY') {
        const add = Number(document.getElementById('inputAddQty').value);
        if(add) {
            it.qtyDisplay += add;
            localStorage.setItem('opname_session', JSON.stringify(opnameSession));
            renderStep1();
        }
        closeModal();
    } else {
        const user = sessionStorage.getItem('userName');
        const inputs = [{id:'revG', k:'qty_gudang'}, {id:'revD', k:'qtyDisplay'}, {id:'revOH', k:'qtyOnHand'}];
        toggleLoading(true);
        try {
            for(let inp of inputs) {
                const val = document.getElementById(inp.id).value;
                if(val !== "" && Number(val) !== it[inp.k]) {
                    await callGAS({ action: 'saveLogEdit', plu: it.plu, parameter_revisi: inp.k, nilai_awal: it[inp.k], nilai_revisi: val });
                    if(inp.k === 'qty_gudang') await callGAS({ action: 'updateMaster', plu: it.plu, qty_gudang: Number(val), user });
                    it[inp.k] = Number(val);
                }
            }
            localStorage.setItem('opname_session', JSON.stringify(opnameSession));
            renderStep3();
            closeModal();
        } finally { toggleLoading(false); }
    }
}

function toggleLoading(s) { document.getElementById('loader').classList.toggle('hidden', !s); }
function closeModal() { document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden')); }
function backStep1() { setStep(1); }
function resetCurrentQty() { 
    opnameSession[currentIdx].qtyDisplay = 0; 
    document.getElementById('displayTotal').innerText = "0"; 
    document.getElementById('inputAddQty').value = '';
}
function doLogout() { sessionStorage.clear(); localStorage.removeItem('opname_session'); location.reload(); }
function renderBarcodes() { document.querySelectorAll('.bc-svg').forEach(el => JsBarcode(el, el.dataset.val, { height: 25, width: 1, fontSize: 8 })); }
function filterMaster() {
    const f = document.getElementById('searchMaster').value.toLowerCase();
    document.querySelectorAll('#cardListMaster .data-card').forEach(c => c.style.display = c.innerText.toLowerCase().includes(f) ? '' : 'none');
}
function applyFilter() {
    const f = document.getElementById('filterOpname').value.toLowerCase();
    document.querySelectorAll('#cardListStep1 .data-card').forEach(c => c.style.display = c.innerText.toLowerCase().includes(f) ? '' : 'none');
}
function finishAll() {
    if(confirm("Selesaikan opname dan hapus data lokal?")) {
        localStorage.removeItem('opname_session'); opnameSession = []; showPage('dashboard');
    }
}

window.onload = () => {
    if(sessionStorage.getItem('isLogged')) { 
        document.getElementById('displayUser').innerText = sessionStorage.getItem('userName');
        document.getElementById('displayNIK').innerText = "NIK: " + sessionStorage.getItem('userNIK');
        initMaster(); showPage('dashboard'); 
    }
};
</script>
</body>
</html>
