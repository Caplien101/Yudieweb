<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Stok Opname - Sistem</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
      background-color: #f8fafc;
    }
    @media screen and (-webkit-min-device-pixel-ratio:0) {
      select, textarea, input { font-size: 16px !important; }
    }
    .stock-card {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-bottom: 16px;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    .stock-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .stock-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(to bottom, #0d6efd, #0dcaf0);
      border-radius: 10px 0 0 10px;
      opacity: 0.7;
    }
    .stock-card .plu-col {
      position: relative;
      z-index: 1;
      width: 15%; min-width: 70px; font-weight: 600; 
    }
    .stock-card .desc-col { 
      position: relative;
      z-index: 1;
      width: 45%; min-width: 120px; color: #475569; font-size: 0.95rem; 
    }
    .stock-card .total-col { 
      position: relative;
      z-index: 1;
      width: 20%; min-width: 60px; text-align: center; font-weight: 700; color: #0d6efd; 
    }
    .stock-card .btn-col { 
      position: relative;
      z-index: 1;
      width: 20%; min-width: 60px; text-align: right; 
    }
    .btn-sm { 
      padding: 0.3rem 0.6rem; 
      font-size: 0.85rem;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .btn-sm:hover {
      transform: scale(1.05);
    }
    @media (max-width: 575px) {
      .stock-card .plu-col { width: 20%; min-width: 60px; }
      .stock-card .desc-col { width: 40%; min-width: 100px; font-size: 0.85rem; }
      .stock-card .total-col { width: 20%; min-width: 50px; }
      .stock-card .btn-col { width: 20%; min-width: 50px; }
    }
    #toastContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
    }
    .sticky-search {
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .progress-section {
      background: rgba(13, 110, 253, 0.1);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .progress-bar-custom {
      background: linear-gradient(to right, #0d6efd, #0dcaf0);
      border-radius: 10px;
    }
    footer {
      background: #1e293b;
      color: #cbd5e1;
    }
    .alert-custom {
      border-left: 4px solid #0d6efd;
      border-radius: 6px;
      background: rgba(13, 110, 253, 0.1);
      margin-bottom: 1rem;
    }
  </style>
</head>
<body class="d-flex flex-column min-vh-100 bg-light">

<div class="container py-4">
  <h2 class="mb-4 text-center fw-bold text-primary">
    <i class="bi bi-boxes me-2"></i>Stok Opname
  </h2>
  
  <!-- Alert untuk instruksi singkat -->
  <div class="alert alert-info alert-custom d-flex align-items-center" role="alert">
    <i class="bi bi-info-circle-fill me-2"></i>
    <div>Jika ingin update qty gudang saja lakukan Simpan Qty Gudang. Total item: <span id="totalItems" class="fw-bold">0</span></div>
  </div>
  
  <!-- Progress Section untuk UX -->
  <div class="progress-section">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <span class="text-muted small">Progres Input Stok</span>
      <span class="text-muted small" id="completedCount">0 / <span id="totalData">0</span></span>
    </div>
    <div class="progress" style="height: 6px;">
      <div class="progress-bar progress-bar-custom" id="progressBar" role="progressbar" style="width: 0%"></div>
    </div>
  </div>

  <div class="sticky-top bg-white py-3 shadow-sm sticky-search" style="margin-top: -1.5rem; margin-bottom: 1.5rem;">
    <div class="container">
      <div class="input-group">
        <span class="input-group-text bg-primary text-white"><i class="bi bi-search"></i></span>
        <input type="text" id="searchInput" class="form-control" placeholder="Cari PLU atau Deskripsi...">
        <button class="btn btn-outline-secondary" type="button" id="clearSearch" title="Hapus pencarian">
          <i class="bi bi-x-circle"></i>
        </button>
      </div>
    </div>
  </div>

  <div id="stockCards"></div>

  <div class="text-center mt-4">
    <button id="saveToInventoryBtn" class="btn btn-outline-primary mb-3" disabled>
      <span class="spinner-border spinner-border-sm me-2 d-none" role="status"></span>
      <i class="bi bi-cloud-upload me-2"></i>Simpan Qty Gudang
    </button>
    <button id="saveAndNextBtn" class="btn btn-success btn-lg" disabled>
      <span class="spinner-border spinner-border-sm me-2 d-none" role="status"></span>
      <i class="bi bi-save me-2"></i>Simpan & Lanjutkan
    </button>
  </div>
</div>

<div id="toastContainer"></div>

<!-- Modal Detail -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title fw-bold">
          <i class="bi bi-box-seam me-2"></i>Detail Stok
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editIndex">
        <div class="mb-3">
          <label class="form-label fw-bold">
            <i class="bi bi-tag me-1 text-primary"></i>PLU
          </label>
          <input type="text" class="form-control" id="plu" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">
            <i class="bi bi-card-text me-1 text-primary"></i>Description
          </label>
          <input type="text" class="form-control" id="description" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">
            <i class="bi bi-building me-1 text-primary"></i>Qty Gudang
          </label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-pencil-square"></i></span>
            <input type="number" class="form-control" id="qtyGudang" min="0">
            <span class="input-group-text" id="gudangTimestamp"></span>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-6">
            <label class="form-label fw-bold">
              <i class="bi bi-archive me-1 text-primary"></i>Qty Rak
            </label>
            <input type="number" class="form-control" id="qtyRak" min="0" placeholder="Qty Rak (angka)">
          </div>
          <div class="col-6">
            <label class="form-label fw-bold">
              <i class="bi bi-shelf me-1 text-primary"></i>Qty Ambalan
            </label>
            <input type="number" class="form-control" id="qtyAmbalan" min="0" placeholder="Qty Ambalan (angka)">
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-6">
            <label class="form-label fw-bold">
              <i class="bi bi-shop me-1 text-primary"></i>Qty Gondola
            </label>
            <input type="number" class="form-control" id="qtyGondola" min="0" placeholder="Qty Gondola (angka)">
          </div>
          <div class="col-6">
            <label class="form-label fw-bold">
              <i class="bi bi-calculator me-1 text-primary"></i>Qty Total
            </label>
            <input type="number" class="form-control bg-light" id="qtyTotal" readonly>
          </div>
        </div>
        <!-- Alert di modal untuk peringatan input -->
        <div class="alert alert-warning alert-dismissible fade show" role="alert" id="inputAlert" style="display: none;">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          Pastikan input angka valid untuk menghindari kesalahan perhitungan.
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i>Batal
        </button>
        <button type="button" class="btn btn-primary" id="saveChanges">
          <i class="bi bi-check-circle me-1"></i>Simpan Perubahan
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Sticky Footer -->
<footer class="bg-dark text-light text-center py-2 mt-auto" style="position: sticky; bottom: 0; z-index: 100;">
  <small>© 2025 Stok Opname System • v1.0</small>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // ✅ Hapus baris berikut jika ingin menyimpan progres pengguna:
  localStorage.removeItem('stok_opname_session');
  sessionStorage.removeItem('stokOpnameStep');

  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw4-KfGgF2sS29CJN24JKUgWj7UfmPFIaKXu0GzqQ_xhHVd7reD7g0Bqi-DMQvmf-nb/exec';
  let stockData = JSON.parse(localStorage.getItem('stok_opname_session')) || [];
  let currentFilteredData = [];

  function saveToStorage() {
    localStorage.setItem('stok_opname_session', JSON.stringify(stockData));
  }

  function updateProgress() {
    const total = stockData.length;
    const completed = stockData.filter(item => item.userInputProvided).length;
    document.getElementById('completedCount').innerHTML = `${completed} / <span id="totalData">${total}</span>`;
    document.getElementById('totalItems').textContent = total;
    const percentage = total > 0 ? (completed / total) * 100 : 0;
    document.getElementById('progressBar').style.width = `${percentage}%`;
  }

  function renderCards(data = stockData) {
    currentFilteredData = data;
    const container = document.getElementById('stockCards');
    container.innerHTML = '';
    if (data.length === 0) {
      container.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-inbox display-4 mb-3"></i><p>Tidak ada data ditemukan.</p></div>';
      return;
    }
    data.forEach((item) => {
      const originalIndex = stockData.findIndex(d => d.plu === item.plu && d.description === item.description);
      const isCompleted = item.userInputProvided;
      const checkIcon = isCompleted ? '<i class="bi bi-check-circle-fill text-success me-1"></i>' : '<i class="bi bi-circle text-muted me-1"></i>';
      container.innerHTML += `
        <div class="stock-card">
          <div class="plu-col">${item.plu}</div>
          <div class="desc-col">${item.description}</div>
          <div class="total-col">${checkIcon}${item.qtyTotal}</div>
          <div class="btn-col">
            <button class="btn btn-outline-primary btn-sm" onclick="openDetail(${originalIndex})" title="Lihat Detail">
              <i class="bi bi-eye"></i>
            </button>
          </div>
        </div>
      `;
    });
  }

  window.openDetail = function(i) {
    if (isNaN(i) || i < 0 || i >= stockData.length || !stockData[i]) {
      console.error('Invalid item index:', i);
      showToast('Data item tidak valid. Silakan refresh halaman.', 'danger');
      return;
    }

    const item = stockData[i];
    document.getElementById('editIndex').value = i;
    document.getElementById('plu').value = item.plu;
    document.getElementById('description').value = item.description;
    document.getElementById('qtyGudang').value = item.qtyGudang || 0;
    document.getElementById('qtyRak').value = item.qtyRak || 0;
    document.getElementById('qtyAmbalan').value = item.qtyAmbalan || 0;
    document.getElementById('qtyGondola').value = item.qtyGondola || 0;
    document.getElementById('qtyTotal').value = item.qtyTotal || 0;
    document.getElementById('gudangTimestamp').textContent = item.gudangLastUpdate || '';

    const autoCalc = () => {
      const g = parseInt(document.getElementById('qtyGudang').value) || 0;
      const r = parseInt(document.getElementById('qtyRak').value) || 0;
      const a = parseInt(document.getElementById('qtyAmbalan').value) || 0;
      const gond = parseInt(document.getElementById('qtyGondola').value) || 0;
      const total = g + r + a + gond;
      document.getElementById('qtyTotal').value = total;
      
      const alertEl = document.getElementById('inputAlert');
      if (total !== item.qtyTotal) {
        alertEl.style.display = 'block';
        setTimeout(() => { alertEl.style.display = 'none'; }, 5000);
      }
    };

    // Event listeners
    document.getElementById('qtyGudang').oninput = () => {
      document.getElementById('gudangTimestamp').textContent = new Date().toISOString().split('T')[0];
      autoCalc();
    };
    document.getElementById('qtyRak').oninput = autoCalc;
    document.getElementById('qtyAmbalan').oninput = autoCalc;
    document.getElementById('qtyGondola').oninput = autoCalc;

    autoCalc();
    new bootstrap.Modal(document.getElementById('detailModal')).show();
  };

  document.getElementById('saveChanges').onclick = () => {
    const indexStr = document.getElementById('editIndex').value;
    const i = parseInt(indexStr, 10);
    
    if (isNaN(i) || i < 0 || i >= stockData.length) {
      console.error('Invalid edit index:', indexStr);
      return;
    }

    const item = stockData[i];
    item.qtyGudang = parseInt(document.getElementById('qtyGudang').value) || 0;
    item.qtyRak = parseInt(document.getElementById('qtyRak').value) || 0;
    item.qtyAmbalan = parseInt(document.getElementById('qtyAmbalan').value) || 0;
    item.qtyGondola = parseInt(document.getElementById('qtyGondola').value) || 0;
    item.qtyTotal = parseInt(document.getElementById('qtyTotal').value) || 0;
    item.gudangLastUpdate = document.getElementById('gudangTimestamp').textContent;
    item.userInputProvided = true;

    saveToStorage();
    // Re-render dengan filter yang sama
    const term = document.getElementById('searchInput').value.toLowerCase();
    if (term) {
      const filtered = stockData.filter(item =>
        item.plu.toString().includes(term) || 
        item.description.toLowerCase().includes(term)
      );
      renderCards(filtered);
    } else {
      renderCards();
    }
    updateProgress();
    bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();
    showToast('Perubahan berhasil disimpan!', 'success');
  };

  document.getElementById('saveToInventoryBtn').onclick = () => {
    const btn = document.getElementById('saveToInventoryBtn');
    btn.disabled = true;
    btn.querySelector('.spinner-border').classList.remove('d-none');

    const updates = stockData.map(item => ({ plu: item.plu, qtyGudang: item.qtyGudang }));
    fetch(SCRIPT_URL, {
      method: 'POST',
      
      body: JSON.stringify({ action: 'updateInventory', data: updates })
    })
    .then(res => res.json())
    .then(result => {
      if (result.status === 'success') {
        showToast('Qty Gudang berhasil disimpan ke Inventory!', 'success');
      } else {
        throw new Error(result.message || 'Gagal menyimpan');
      }
    })
    .catch(err => {
      console.error(err);
      showToast('Gagal menyimpan ke Inventory: ' + err.message, 'danger');
    })
    .finally(() => {
      btn.disabled = false;
      btn.querySelector('.spinner-border').classList.add('d-none');
    });
  };

  function showToast(msg, type = 'success') {
    const c = document.getElementById('toastContainer');
    const color = type === 'success' ? 'bg-success' : 'bg-danger';
    const icon = type === 'success' ? 'bi bi-check-circle-fill' : 'bi bi-exclamation-triangle-fill';
    const el = document.createElement('div');
    el.className = `toast align-items-center text-white ${color} border-0`;
    el.innerHTML = `<div class="d-flex"><div class="toast-body"><i class="${icon} me-2"></i>${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
    c.appendChild(el);
    new bootstrap.Toast(el, { autohide: true, delay: 3000 }).show();
    el.addEventListener('hidden.bs.toast', () => el.remove());
  }

  // Clear search button
  document.getElementById('clearSearch').onclick = () => {
    document.getElementById('searchInput').value = '';
    renderCards();
  };

  if (stockData.length === 0) {
    fetch(`${SCRIPT_URL}?action=getInventory`)
      .then(res => res.json())
      .then(data => {
        if (data.error) throw new Error(data.error);
        stockData = data.map(item => ({
          plu: item.plu,
          description: item.description,
          qtyGudang: parseInt(item.qtyGudang) || 0,
          qtyRak: 0,
          qtyAmbalan: 0,
          qtyGondola: 0,
          qtyTotal: parseInt(item.qtyGudang) || 0,
          gudangLastUpdate: new Date().toISOString().split('T')[0],
          userInputProvided: false
        }));
        saveToStorage();
        renderCards();
        updateProgress();
        document.getElementById('saveToInventoryBtn').disabled = false;
        document.getElementById('saveAndNextBtn').disabled = false;
      })
      .catch(err => {
        console.error(err);
        showToast('Gagal memuat data dari Google Sheet', 'danger');
        renderCards([]);
        updateProgress();
      });
  } else {
    renderCards();
    updateProgress();
    document.getElementById('saveToInventoryBtn').disabled = false;
    document.getElementById('saveAndNextBtn').disabled = false;
  }

  document.getElementById('searchInput').addEventListener('input', function() {
    const term = this.value.toLowerCase();
    if (term.trim() === '') {
      renderCards();
    } else {
      const filtered = stockData.filter(item =>
        item.plu.toString().includes(term) || 
        item.description.toLowerCase().includes(term)
      );
      renderCards(filtered);
    }
  });

  document.getElementById('saveAndNextBtn').onclick = () => {
    const btn = document.getElementById('saveAndNextBtn');
    btn.disabled = true;
    btn.querySelector('.spinner-border').classList.remove('d-none');
    saveToStorage();
    sessionStorage.setItem('stokOpnameStep', '1');
    showToast('Data disimpan dan melanjutkan ke langkah berikutnya!', 'success');
    setTimeout(() => window.location.replace('stok-opname-onhand.html'), 1000);
  };
</script>
</body>
</html>
