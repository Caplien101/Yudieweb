<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel - Upload Gambar</title>
  <!-- ‚úÖ Fix: Hapus spasi berlebih -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .thumb { height: 80px; object-fit: cover; }
    .img-item { 
      margin-bottom: 10px; 
      border: 1px solid #ddd; 
      padding: 8px; 
      border-radius: 8px; 
    }
  </style>
</head>
<body>
  <div class="container mt-5">
    <h1>Admin Panel - Upload Gambar</h1>

    <!-- Form Upload -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Upload Gambar dari Perangkat</h5>
        <form id="uploadForm">
          <div class="mb-3">
            <label for="file" class="form-label">Pilih Gambar</label>
            <input type="file" class="form-control" id="file" accept="image/*" required>
          </div>
          <div class="mb-3">
            <label for="category" class="form-label">Kategori</label>
            <input type="text" class="form-control" id="category" placeholder="misal: alam" value="lainnya">
          </div>
          <button type="submit" class="btn btn-primary">Upload</button>
        </form>
        <div id="uploadStatus" class="mt-3"></div>
      </div>
    </div>

    <!-- Daftar Gambar -->
    <div class="card">
      <div class="card-body">
        <h5>Daftar Gambar di Galeri</h5>
        <ul id="imageList" class="list-unstyled"></ul>
      </div>
    </div>
  </div>

 <script>
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyI-1CXhZULKitbn1I7OfS4NkHNGeXGJJhXgtpOZCcuCMQQnx9sx0xFom5tV_WZ3Uht/exec';

  document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const fileInput = document.getElementById('file');
    const file = fileInput.files[0];
    const category = document.getElementById('category').value;
    const status = document.getElementById('uploadStatus');

    if (!file) {
      status.innerHTML = '<div class="alert alert-danger">Pilih file dulu!</div>';
      return;
    }

    const formData = new FormData();
    formData.append('file', file);
    formData.append('category', category);

    const xhr = new XMLHttpRequest();

    // Tampilkan status upload
    xhr.upload.onprogress = function(e) {
      if (e.lengthComputable) {
        const percent = (e.loaded / e.total) * 100;
        status.innerHTML = `<div class="alert alert-info">Mengunggah: ${Math.round(percent)}%</div>`;
      }
    };

    xhr.onload = function() {
      if (xhr.status === 200) {
        try {
          // Coba parse JSON
          const data = JSON.parse(xhr.responseText);
          console.log('Respon dari GAS:', data);

          if (data.success) {
            status.innerHTML = '<div class="alert alert-success">‚úÖ Upload berhasil!</div>';
            loadImages(); // Refresh daftar gambar
            fileInput.value = ''; // Reset form
            document.getElementById('category').value = 'lainnya';
          } else {
            status.innerHTML = `<div class="alert alert-danger">‚ùå Gagal: ${data.error}</div>`;
          }
        } catch (err) {
          // Jika JSON rusak, tapi HTTP 200 ‚Üí kemungkinan berhasil
          status.innerHTML = '<div class="alert alert-warning">‚úÖ Upload mungkin berhasil! Cek folder Google Drive.</div>';
          loadImages();
        }
      } else {
        status.innerHTML = `<div class="alert alert-danger">‚ùå Gagal: HTTP ${xhr.status}</div>`;
      }
    };

    xhr.onerror = function() {
      status.innerHTML = '<div class="alert alert-danger">üåê Network error. Cek URL atau koneksi.</div>';
    };

    xhr.open('POST', WEB_APP_URL);
    xhr.send(formData); // Kirim tanpa mode: no-cors
  });

  // Fungsi loadImages tetap sama
  async function loadImages() {
    try {
      const res = await fetch('data.json?t=' + Date.now());
      const images = await res.json();
      renderImageList(images);
    } catch (err) {
      console.error('Gagal muat data.json:', err);
      document.getElementById('uploadStatus').insertAdjacentHTML('beforeend',
        '<div class="alert alert-warning">Tidak bisa muat data.json. Pastikan file ada.</div>'
      );
    }
  }

  function renderImageList(images) {
    const list = document.getElementById('imageList');
    list.innerHTML = '';
    images.forEach(img => {
      const li = document.createElement('li');
      li.className = 'img-item';
      li.innerHTML = `
        <div class="d-flex align-items-center">
          <img src="${img.url}" class="thumb me-3">
          <div>
            <div><strong>${img.category}</strong></div>
            <button class="btn btn-sm btn-danger" onclick="deleteImage('${img.id}')">Hapus</button>
          </div>
        </div>`;
      list.appendChild(li);
    });
  }

  async function deleteImage(id) {
    if (!confirm('Hapus dari daftar? File di Drive harus dihapus manual.')) return;
    try {
      const res = await fetch('data.json');
      let images = await res.json();
      images = images.filter(i => i.id !== id);
      alert('Gambar dihapus dari daftar. Simpan data.json secara manual jika perlu.');
      loadImages();
    } catch (err) {
      alert('Gagal memuat data.json');
    }
  }

  document.addEventListener('DOMContentLoaded', loadImages);
</script>
</body>
</html>
