<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSM per Personil - Dashboard Toko</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2c3e50',
                        secondary: '#3498db',
                        success: '#27ae60',
                        warning: '#f39c12',
                        danger: '#e74c3c',
                        info: '#17a2b8'
                    }
                }
            }
        }
    </script>
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .chart-container {
            position: relative;
            height: 500px; /* Tinggi chart diperbesar untuk landscape */
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-gradient-to-r from-primary to-secondary text-white rounded-xl p-6 mb-6 shadow-lg">
            <div class="flex items-center">
                <i class="bi bi-people text-3xl mr-3"></i>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold">PSM Personil Toko</h1>
                    <p class="text-blue-100">Monitoring Pencapaian Produk PSM per Personil</p>
                </div>
            </div>
        </div>
        
        <!-- Filter Section -->
        <div class="bg-white rounded-xl p-6 mb-6 shadow">
            <h5 class="text-lg font-semibold mb-4 flex items-center">
                <i class="bi bi-funnel mr-2"></i>Filter Data
            </h5>
            
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4">
                <div>
                    <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Awal</label>
                    <input type="date" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent" id="startDate">
                </div>
                <div>
                    <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Akhir</label>
                    <input type="date" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent" id="endDate">
                </div>
                <div>
                    <label for="shiftFilter" class="block text-sm font-medium text-gray-700 mb-1">Shift</label>
                    <select class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent" id="shiftFilter">
                        <option value="all">Semua</option>
                        <option value="1">Shift 1</option>
                        <option value="2">Shift 2</option>
                        <option value="3">Shift 3</option>
                    </select>
                </div>
                <div>
                    <label for="productFilter" class="block text-sm font-medium text-gray-700 mb-1">Produk</label>
                    <select class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent" id="productFilter">
                        <option value="all">Semua</option>
                    </select>
                </div>
                <div>
                    <label for="nikFilter" class="block text-sm font-medium text-gray-700 mb-1">Personil</label>
                    <select class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent" id="nikFilter">
                        <option value="all">Semua</option>
                    </select>
                </div>
            </div>
            
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
                <div class="mb-3 md:mb-0">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <input class="h-4 w-4 text-secondary border-gray-300 rounded focus:ring-secondary" type="checkbox" id="showAllNik" checked>
                            <label for="showAllNik" class="ml-2 text-sm text-gray-700 flex items-center">
                                <i class="bi bi-eye mr-1"></i>Tampilkan semua personil
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input class="h-4 w-4 text-secondary border-gray-300 rounded focus:ring-secondary" type="checkbox" id="showGapOnly">
                            <label for="showGapOnly" class="ml-2 text-sm text-gray-700 flex items-center">
                                <i class="bi bi-filter-circle mr-1"></i>Hanya tampilkan GAP negatif
                            </label>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button class="bg-secondary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg flex items-center transition duration-200" id="applyFilter">
                        <i class="bi bi-filter-circle mr-2"></i>Terapkan Filter
                    </button>
                    <button class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg flex items-center transition duration-200" id="resetFilter">
                        <i class="bi bi-arrow-clockwise mr-2"></i>Reset
                    </button>
                </div>
            </div>
            
            <div class="flex flex-wrap items-center">
                <span id="dataPeriod" class="text-gray-600 text-sm mr-3 flex items-center">
                    <i class="bi bi-calendar mr-1"></i>Periode: Loading...
                </span>
                <span id="employeeCount" class="bg-info text-white text-xs font-semibold px-2.5 py-0.5 rounded-full mr-2">0 personil</span>
                <span id="totalTargetBadge" class="bg-gray-600 text-white text-xs font-semibold px-2.5 py-0.5 rounded-full">Target: 0</span>
                <span id="targetPerPersonBadge" class="bg-warning text-white text-xs font-semibold px-2.5 py-0.5 rounded-full ml-2">Target per Personil: 0</span>
            </div>
        </div>
        
        <!-- Chart Section -->
        <div class="bg-white rounded-xl p-6 mb-6 shadow">
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
                <h5 class="text-lg font-semibold flex items-center mb-2 md:mb-0">
                    <i class="bi bi-bar-chart-fill text-secondary mr-2"></i>Grafik Performa Personil
                </h5>
                <div class="text-sm text-gray-600">
                    <span class="font-medium">Total Penjualan: <span id="totalSalesValue" class="text-primary font-bold">0</span></span>
                    <span class="mx-2">•</span>
                    <span class="font-medium">Rata-rata per Personil: <span id="averageSalesValue" class="text-primary font-bold">0</span></span>
                </div>
            </div>
            
            <div class="mb-4">
                <div class="bg-blue-50 border-l-4 border-secondary pl-3 py-2">
                    <div class="flex flex-wrap justify-between items-center">
                        <span class="text-sm font-medium">Total Penjualan per Personil - Diurutkan dari tertinggi ke terendah</span>
                        <div class="flex items-center mt-1 md:mt-0">
                            <div class="flex items-center mr-3">
                                <div class="w-3 h-3 bg-secondary rounded mr-1"></div>
                                <span class="text-xs">Penjualan</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-0.5 bg-red-500 mr-1"></div>
                                <span class="text-xs">Garis Target</span>
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-600 mt-1">Garis merah menunjukkan target yang harus dicapai setiap personil</p>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
            
            <div class="mt-4 text-xs text-gray-500 flex flex-wrap justify-center">
                <div class="flex items-center mr-4 mb-1">
                    <div class="w-3 h-3 bg-success rounded-full mr-1"></div>
                    <span>≥ 100% Target</span>
                </div>
                <div class="flex items-center mr-4 mb-1">
                    <div class="w-3 h-3 bg-warning rounded-full mr-1"></div>
                    <span>70-99% Target</span>
                </div>
                <div class="flex items-center mr-4 mb-1">
                    <div class="w-3 h-3 bg-danger rounded-full mr-1"></div>
                    <span>&lt; 70% Target</span>
                </div>
                <div class="flex items-center mb-1">
                    <div class="w-3 h-3 bg-secondary rounded-full mr-1"></div>
                    <span>Belum ada target</span>
                </div>
            </div>
        </div>
        
        <!-- Data Section -->
        <div class="bg-white rounded-xl shadow overflow-hidden mb-6">
            <div class="border-b border-gray-200 px-6 py-4 flex flex-col md:flex-row md:items-center justify-between">
                <div class="mb-2 md:mb-0">
                    <h5 class="font-semibold text-gray-800 flex items-center">
                        <i class="bi bi-table mr-2"></i>Data PSM per Personil
                    </h5>
                    <div class="flex mt-1 space-x-2">
                        <span class="bg-primary text-white text-xs font-semibold px-2.5 py-0.5 rounded-full" id="rowCount">0 baris</span>
                        <span class="bg-gray-600 text-white text-xs font-semibold px-2.5 py-0.5 rounded-full" id="productCount">0 produk</span>
                        <span class="bg-success text-white text-xs font-semibold px-2.5 py-0.5 rounded-full" id="achievedCount">0 mencapai target</span>
                    </div>
                </div>
                <div>
                    <button class="bg-white border border-secondary text-secondary hover:bg-secondary hover:text-white font-medium py-2 px-4 rounded-lg flex items-center transition duration-200" id="exportData">
                        <i class="bi bi-download mr-2"></i>Export CSV
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto custom-scrollbar">
                <table class="min-w-full divide-y divide-gray-200" id="psmTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Personil</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Target per Personil</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actual per Personil</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pencapaian</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">GAP</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Info Panel -->
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-5">
            <h6 class="font-semibold text-blue-800 mb-2 flex items-center">
                <i class="bi bi-info-circle mr-2"></i>Informasi
            </h6>
            <ul class="text-sm text-blue-700 space-y-1">
                <li class="flex items-start">
                    <i class="bi bi-dot mr-1 mt-0.5"></i>
                    <span>Data diambil dari Google Apps Script API</span>
                </li>
                <li class="flex items-start">
                    <i class="bi bi-dot mr-1 mt-0.5"></i>
                    <span>Target dihitung secara proporsional berdasarkan periode yang dipilih</span>
                </li>
                <li class="flex items-start">
                    <i class="bi bi-dot mr-1 mt-0.5"></i>
                    <span>GAP = Actual - Target (positif = melebihi target, negatif = di bawah target)</span>
                </li>
                <li class="flex items-start">
                    <i class="bi bi-dot mr-1 mt-0.5"></i>
                    <span><strong>Target total sama untuk semua personil</strong> - perbandingan berdasarkan actual penjualan</span>
                </li>
                <li class="flex items-start">
                    <i class="bi bi-dot mr-1 mt-0.5"></i>
                    <span><strong>Garis merah pada grafik</strong> menunjukkan target yang harus dicapai setiap personil</span>
                </li>
            </ul>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-secondary mx-auto mb-4"></div>
            <h5 class="text-lg font-semibold text-gray-800">Memuat data dari server...</h5>
            <p class="text-gray-600 mt-1" id="loadingText">Mengambil data PSM dan target</p>
        </div>
    </div>

    <script>
        // ==============================================
        // KONFIGURASI
        // ==============================================
        const API_URL = 'https://script.google.com/macros/s/AKfycby_L_vmTHUtl7NUr3qHI-upGlPNUWKJ1uRgPFOPWgWofMDU8siS1Ex_YHR-y0P69E-cGA/exec';
        
        // Variabel global
        let allData = {};
        let currentStartDate, currentEndDate;
        let nikToNameMap = {};
        let currentProductGroupsWithTarget = {};
        let totalTargetForAll = 0;
        let performanceChart = null;
        
        // ==============================================
        // FUNGSI PARSING TANGGAL - SOLUSI UTAMA
        // ==============================================
        
        // Fungsi utama untuk parsing tanggal dengan timezone UTC
        function parseDateUTC(dateString) {
            if (!dateString || dateString.trim() === '') {
                console.warn('Tanggal kosong atau null:', dateString);
                return null;
            }
            
            // 1. Jika sudah Date object
            if (dateString instanceof Date) {
                return dateString;
            }
            
            // 2. Coba format ISO: "2026-01-01"
            if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const parts = dateString.split('-');
                const year = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1;
                const day = parseInt(parts[2], 10);
                
                // Buat tanggal di UTC (midnight UTC)
                const date = new Date(Date.UTC(year, month, day, 0, 0, 0));
                return date;
            }
            
            // 3. Coba format Indonesia: "01/01/2026"
            if (dateString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                const parts = dateString.split('/');
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1;
                const year = parseInt(parts[2], 10);
                
                // Buat tanggal di UTC (midnight UTC)
                const date = new Date(Date.UTC(year, month, day, 0, 0, 0));
                return date;
            }
            
            // 4. Coba format D/M/YYYY: "1/1/2026"
            if (dateString.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                const parts = dateString.split('/');
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1;
                const year = parseInt(parts[2], 10);
                
                const date = new Date(Date.UTC(year, month, day, 0, 0, 0));
                return date;
            }
            
            // 5. Coba parsing langsung (fallback)
            const date = new Date(dateString);
            if (!isNaN(date.getTime())) {
                return date;
            }
            
            console.error(`Gagal parsing: "${dateString}"`);
            return null;
        }
        
        // Fungsi untuk konversi date object ke string YYYY-MM-DD
        function formatDateToYYYYMMDD(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
                return '';
            }
            
            const year = date.getUTCFullYear();
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const day = String(date.getUTCDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }
        
        // Fungsi untuk konversi ke format Indonesia
        function formatDateToDDMMYYYY(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
                return 'Invalid Date';
            }
            
            const day = String(date.getUTCDate()).padStart(2, '0');
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const year = date.getUTCFullYear();
            
            return `${day}/${month}/${year}`;
        }
        
        // ==============================================
        // FUNGSI NORMALISASI DATA
        // ==============================================
        
        function normalizeData(rawData) {
            const normalizedData = {
                data_psm: [],
                target_psm: [],
                data_nik: [],
                _meta: {
                    data_psm_count: 0,
                    target_psm_count: 0
                }
            };
            
            // 1. Normalisasi Data PSM
            if (rawData.data_psm && Array.isArray(rawData.data_psm)) {
                rawData.data_psm.forEach(record => {
                    const normalized = { ...record };
                    
                    // Parse tanggal dengan UTC
                    if (record.tanggal) {
                        const parsedDate = parseDateUTC(record.tanggal);
                        if (parsedDate) {
                            normalized.tanggal_utc = parsedDate;
                            normalized.tanggal_iso = parsedDate.toISOString().split('T')[0];
                            normalized.tanggal_display = formatDateToDDMMYYYY(parsedDate);
                        }
                    }
                    
                    // Normalisasi angka
                    normalized.qty_numeric = parseInt(record.qty) || 0;
                    normalized.shift_numeric = parseInt(record.shift) || 0;
                    normalized.nik_string = record.nik ? record.nik.toString() : 'unknown';
                    
                    normalizedData.data_psm.push(normalized);
                });
                
                normalizedData._meta.data_psm_count = normalizedData.data_psm.length;
            }
            
            // 2. Normalisasi Target PSM
            if (rawData.target_psm && Array.isArray(rawData.target_psm)) {
                rawData.target_psm.forEach(record => {
                    const normalized = { ...record };
                    
                    // Parse tanggal start
                    if (record.start_date) {
                        const parsedStart = parseDateUTC(record.start_date);
                        if (parsedStart) {
                            normalized.start_date_utc = parsedStart;
                            normalized.start_date_iso = parsedStart.toISOString().split('T')[0];
                        }
                    }
                    
                    // Parse tanggal end
                    if (record.end_date) {
                        const parsedEnd = parseDateUTC(record.end_date);
                        if (parsedEnd) {
                            normalized.end_date_utc = parsedEnd;
                            normalized.end_date_iso = parsedEnd.toISOString().split('T')[0];
                        }
                    }
                    
                    // Normalisasi target
                    normalized.target_pernik_numeric = parseInt(record.target_pernik) || 0;
                    
                    normalizedData.target_psm.push(normalized);
                });
                
                normalizedData._meta.target_psm_count = normalizedData.target_psm.length;
            }
            
            // 3. Data NIK
            if (rawData.data_nik) {
                normalizedData.data_nik = rawData.data_nik;
            }
            
            return normalizedData;
        }
        
        // ==============================================
        // FUNGSI UTAMA
        // ==============================================
        
        async function loadData() {
            try {
                showLoading(true, 'Menghubungkan ke server...');
                
                const response = await fetch(API_URL);
                const rawData = await response.json();
                
                // Normalisasi data
                allData = normalizeData(rawData);
                
                // Proses mapping NIK
                processNIKData();
                
                // Setup UI
                setupDefaultDates();
                populateFilters();
                
                // Terapkan filter awal
                applyFilters();
                
                showLoading(false);
                
            } catch (error) {
                console.error('Error loading data:', error);
                showLoading(false);
                alert('Gagal memuat data. Silakan refresh halaman.');
            }
        }
        
        function processNIKData() {
            const nikRecords = allData.data_nik || [];
            nikToNameMap = {};
            
            nikRecords.forEach(record => {
                if (record.nik) {
                    const nikStr = record.nik.toString();
                    nikToNameMap[nikStr] = record.nama || `Personil ${nikStr}`;
                }
            });
            
            // Backup dari data PSM
            const psmData = allData.data_psm || [];
            psmData.forEach(record => {
                if (record.nik_string && record.nik_string !== 'unknown' && !nikToNameMap[record.nik_string]) {
                    nikToNameMap[record.nik_string] = `Personil ${record.nik_string}`;
                }
            });
            
            document.getElementById('employeeCount').textContent = `${Object.keys(nikToNameMap).length} personil`;
        }
        
        function getEmployeeName(nik) {
            if (!nik) return 'Tidak diketahui';
            const nikStr = nik.toString();
            return nikToNameMap[nikStr] || `Personil ${nikStr}`;
        }
        
        function setupDefaultDates() {
            // Default: 7 hari terakhir
            const today = new Date();
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(today.getDate() - 6); // 7 hari termasuk hari ini
            
            // Format untuk input date (YYYY-MM-DD)
            document.getElementById('startDate').value = formatDateToYYYYMMDD(sevenDaysAgo);
            document.getElementById('endDate').value = formatDateToYYYYMMDD(today);
            
            currentStartDate = formatDateToYYYYMMDD(sevenDaysAgo);
            currentEndDate = formatDateToYYYYMMDD(today);
            
            updatePeriodText();
        }
        
        function updatePeriodText() {
            const start = parseDateUTC(currentStartDate);
            const end = parseDateUTC(currentEndDate);
            
            if (!start || !end) {
                document.getElementById('dataPeriod').textContent = 'Periode: Tanggal tidak valid';
                return;
            }
            
            const formattedStart = formatDateToDDMMYYYY(start);
            const formattedEnd = formatDateToDDMMYYYY(end);
            
            document.getElementById('dataPeriod').innerHTML = 
                `<i class="bi bi-calendar mr-1"></i>Periode: ${formattedStart} - ${formattedEnd}`;
        }
        
        function populateFilters() {
            const psmData = allData.data_psm || [];
            
            // Produk
            const products = [...new Set(psmData.map(item => item.nama_produk).filter(Boolean))].sort();
            const productFilter = document.getElementById('productFilter');
            
            while (productFilter.options.length > 1) {
                productFilter.remove(1);
            }
            
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                productFilter.appendChild(option);
            });
            
            // Personil
            const nikList = [...new Set(psmData.map(item => item.nik_string).filter(nik => nik && nik !== 'unknown'))].sort();
            const nikFilter = document.getElementById('nikFilter');
            
            while (nikFilter.options.length > 1) {
                nikFilter.remove(1);
            }
            
            nikList.forEach(nik => {
                const option = document.createElement('option');
                option.value = nik;
                const employeeName = getEmployeeName(nik);
                option.textContent = `${employeeName} (${nik})`;
                nikFilter.appendChild(option);
            });
        }
        
        function applyFilters() {
            // Ambil nilai filter
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            const shiftFilter = document.getElementById('shiftFilter').value;
            const productFilter = document.getElementById('productFilter').value;
            const nikFilter = document.getElementById('nikFilter').value;
            const showAllNik = document.getElementById('showAllNik').checked;
            const showGapOnly = document.getElementById('showGapOnly').checked;
            
            // Parse tanggal filter (dari input user, format YYYY-MM-DD)
            const startDate = parseDateUTC(startDateStr);
            let endDate = parseDateUTC(endDateStr);
            
            if (!startDate || !endDate) {
                showError('Tanggal filter tidak valid');
                return;
            }
            
            // Set endDate ke akhir hari (23:59:59.999)
            endDate.setUTCHours(23, 59, 59, 999);
            
            // Proses data
            processAndDisplayData(startDate, endDate, {
                shiftFilter,
                productFilter,
                nikFilter,
                showAllNik,
                showGapOnly
            });
        }
        
        function processAndDisplayData(filterStartDate, filterEndDate, filters) {
            try {
                const psmData = allData.data_psm || [];
                const targetPSM = allData.target_psm || [];
                
                // 1. Filter berdasarkan tanggal (UTC)
                let filteredPsmData = psmData.filter(item => {
                    if (!item.tanggal_utc) return false;
                    return item.tanggal_utc >= filterStartDate && item.tanggal_utc <= filterEndDate;
                });
                
                // 2. Filter shift
                if (filters.shiftFilter !== 'all') {
                    const shift = parseInt(filters.shiftFilter);
                    filteredPsmData = filteredPsmData.filter(item => item.shift_numeric === shift);
                }
                
                // 3. Filter produk
                if (filters.productFilter !== 'all') {
                    filteredPsmData = filteredPsmData.filter(item => item.nama_produk === filters.productFilter);
                }
                
                // 4. Filter NIK
                if (filters.nikFilter !== 'all') {
                    filteredPsmData = filteredPsmData.filter(item => item.nik_string === filters.nikFilter);
                }
                
                // 5. Kelompokkan data: Produk -> NIK -> Total Qty
                const productGroups = {};
                
                filteredPsmData.forEach(item => {
                    const product = item.nama_produk;
                    const nik = item.nik_string;
                    const qty = item.qty_numeric;
                    
                    if (!productGroups[product]) {
                        productGroups[product] = {};
                    }
                    
                    if (!productGroups[product][nik]) {
                        productGroups[product][nik] = 0;
                    }
                    
                    productGroups[product][nik] += qty;
                });
                
                // 6. Hitung target total
                totalTargetForAll = 0;
                
                targetPSM.forEach(targetItem => {
                    const targetStart = targetItem.start_date_utc;
                    const targetEnd = targetItem.end_date_utc;
                    
                    if (!targetStart || !targetEnd) return;
                    
                    // Cek overlap periode (UTC)
                    if (filterStartDate <= targetEnd && filterEndDate >= targetStart) {
                        const overlapStart = new Date(Math.max(filterStartDate.getTime(), targetStart.getTime()));
                        const overlapEnd = new Date(Math.min(filterEndDate.getTime(), targetEnd.getTime()));
                        const overlapDays = Math.max(0, Math.floor((overlapEnd - overlapStart) / (1000 * 60 * 60 * 24)) + 1);
                        
                        const targetTotalDays = Math.floor((targetEnd - targetStart) / (1000 * 60 * 60 * 24)) + 1;
                        
                        if (targetTotalDays > 0) {
                            const proportion = overlapDays / targetTotalDays;
                            const targetPerNik = Math.round(targetItem.target_pernik_numeric * proportion);
                            totalTargetForAll += targetPerNik;
                        }
                    }
                });
                
                // Update UI target
                document.getElementById('totalTargetBadge').textContent = `Target: ${formatNumber(totalTargetForAll)}`;
                document.getElementById('targetPerPersonBadge').textContent = `Target per Personil: ${formatNumber(totalTargetForAll)}`;
                
                // 7. Hitung target per produk per NIK
                currentProductGroupsWithTarget = {};
                
                Object.keys(productGroups).forEach(product => {
                    currentProductGroupsWithTarget[product] = {};
                    Object.keys(productGroups[product]).forEach(nik => {
                        currentProductGroupsWithTarget[product][nik] = {
                            actual: productGroups[product][nik],
                            target: 0
                        };
                    });
                });
                
                // Hitung target per produk
                targetPSM.forEach(targetItem => {
                    const targetStart = targetItem.start_date_utc;
                    const targetEnd = targetItem.end_date_utc;
                    
                    if (!targetStart || !targetEnd) return;
                    
                    const product = targetItem.nama_produk;
                    
                    // Cek overlap periode
                    if (filterStartDate <= targetEnd && filterEndDate >= targetStart) {
                        const overlapStart = new Date(Math.max(filterStartDate.getTime(), targetStart.getTime()));
                        const overlapEnd = new Date(Math.min(filterEndDate.getTime(), targetEnd.getTime()));
                        const overlapDays = Math.max(0, Math.floor((overlapEnd - overlapStart) / (1000 * 60 * 60 * 24)) + 1);
                        
                        const targetTotalDays = Math.floor((targetEnd - targetStart) / (1000 * 60 * 60 * 24)) + 1;
                        
                        if (targetTotalDays > 0) {
                            const proportion = overlapDays / targetTotalDays;
                            const targetPerNik = Math.round(targetItem.target_pernik_numeric * proportion);
                            
                            // Distribusikan ke NIK yang menjual produk ini
                            if (currentProductGroupsWithTarget[product]) {
                                Object.keys(currentProductGroupsWithTarget[product]).forEach(nik => {
                                    currentProductGroupsWithTarget[product][nik].target += targetPerNik;
                                });
                            }
                        }
                    }
                });
                
                // 8. Hitung statistik dan update chart
                calculateAndDisplayStats();
                
                // 9. Tampilkan tabel
                displayGroupedTableData(currentProductGroupsWithTarget, filters.showAllNik, filters.showGapOnly);
                
            } catch (error) {
                console.error('Error processing data:', error);
                showError('Terjadi kesalahan dalam memproses data');
            }
        }
        
        function calculateAndDisplayStats() {
            try {
                // Hitung total actual per personil
                const employeeActualTotals = {};
                
                Object.keys(currentProductGroupsWithTarget).forEach(product => {
                    Object.keys(currentProductGroupsWithTarget[product]).forEach(nik => {
                        const data = currentProductGroupsWithTarget[product][nik];
                        const actual = data.actual || 0;
                        
                        if (!employeeActualTotals[nik]) {
                            employeeActualTotals[nik] = {
                                totalActual: 0,
                                achievements: []
                            };
                        }
                        
                        employeeActualTotals[nik].totalActual += actual;
                        
                        const targetPerProduct = data.target || 0;
                        const achievementPerProduct = targetPerProduct > 0 ? Math.round((actual / targetPerProduct) * 100) : 0;
                        employeeActualTotals[nik].achievements.push({
                            product: product,
                            achievement: achievementPerProduct,
                            actual: actual,
                            target: targetPerProduct
                        });
                    });
                });
                
                // Hitung persentase per personil
                const employeePercentages = [];
                
                Object.keys(employeeActualTotals).forEach(nik => {
                    const totals = employeeActualTotals[nik];
                    const percentage = totalTargetForAll > 0 ? 
                        Math.round((totals.totalActual / totalTargetForAll) * 100) : 0;
                    
                    employeePercentages.push({
                        nik: nik,
                        employeeName: getEmployeeName(nik),
                        percentage: percentage,
                        totalActual: totals.totalActual,
                        totalTarget: totalTargetForAll,
                        achievements: totals.achievements
                    });
                });
                
                // Hitung statistik tambahan
                let totalSales = 0;
                let achievedTargetCount = 0;
                
                employeePercentages.forEach(employee => {
                    totalSales += employee.totalActual;
                    
                    // Hitung berapa banyak yang mencapai target (≥ 100%)
                    if (employee.percentage >= 100) {
                        achievedTargetCount++;
                    }
                });
                
                const averageSales = employeePercentages.length > 0 ? 
                    Math.round(totalSales / employeePercentages.length) : 0;
                
                // Update statistik di UI
                document.getElementById('totalSalesValue').textContent = formatNumber(totalSales);
                document.getElementById('averageSalesValue').textContent = formatNumber(averageSales);
                document.getElementById('achievedCount').textContent = `${achievedTargetCount} mencapai target`;
                
                // Update chart dengan data baru
                updatePerformanceChart(employeePercentages);
                
            } catch (error) {
                console.error('Error calculating stats:', error);
                document.getElementById('totalSalesValue').textContent = '0';
                document.getElementById('averageSalesValue').textContent = '0';
                document.getElementById('achievedCount').textContent = '0 mencapai target';
            }
        }
        
        function updatePerformanceChart(employeeData) {
            // Sort data berdasarkan total actual (terbesar ke terkecil)
            const sortedData = [...employeeData]
                .filter(item => item.totalActual > 0)
                .sort((a, b) => b.totalActual - a.totalActual);
            
            // Ambil maksimal 20 personil untuk chart agar tidak terlalu penuh
            const displayData = sortedData.slice(0, 20);
            
            // Gunakan nama lengkap untuk label
            const labels = displayData.map(item => {
                // Potong nama jika terlalu panjang (>25 karakter)
                const name = item.employeeName;
                return name.length > 25 ? name.substring(0, 22) + '...' : name;
            });
            
            const actualValues = displayData.map(item => item.totalActual);
            const targetValues = displayData.map(item => item.totalTarget);
            const percentages = displayData.map(item => item.percentage);
            
            // Warna bar berdasarkan persentase pencapaian
            const backgroundColors = percentages.map(p => {
                if (p >= 100) return '#27ae60'; // success
                if (p >= 70) return '#f39c12'; // warning
                if (p > 0) return '#e74c3c'; // danger
                return '#3498db'; // secondary - untuk yang belum ada target atau 0%
            });
            
            // Buat atau update chart
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            if (performanceChart) {
                performanceChart.destroy();
            }
            
            // PERUBAHAN UTAMA: Chart mode landscape dengan garis target
            performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        // Dataset untuk actual penjualan
                        {
                            label: 'Penjualan Actual',
                            data: actualValues,
                            backgroundColor: backgroundColors,
                            borderColor: backgroundColors.map(color => color.replace('0.8', '1')),
                            borderWidth: 1,
                            borderRadius: 4,
                            barPercentage: 0.7,
                            order: 1 // Bar chart di depan
                        },
                        // Dataset untuk garis target
                        {
                            label: 'Target',
                            data: targetValues,
                            type: 'line',
                            borderColor: '#e74c3c', // Merah
                            borderWidth: 2,
                            borderDash: [5, 5], // Garis putus-putus
                            fill: false,
                            pointRadius: 0, // Tidak menampilkan titik
                            pointHoverRadius: 0,
                            tension: 0, // Garis lurus, tidak melengkung
                            order: 0 // Garis di belakang bar chart
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 10,
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const datasetLabel = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    const index = context.dataIndex;
                                    
                                    if (datasetLabel === 'Penjualan Actual') {
                                        const percentage = percentages[index];
                                        const employee = displayData[index];
                                        return [
                                            `Personil: ${employee.employeeName}`,
                                            `NIK: ${employee.nik}`,
                                            `Actual: ${formatNumber(value)}`,
                                            `Target: ${formatNumber(employee.totalTarget)}`,
                                            `Pencapaian: ${percentage}%`
                                        ];
                                    } else if (datasetLabel === 'Target') {
                                        return [`Target: ${formatNumber(value)}`];
                                    }
                                    
                                    return `${datasetLabel}: ${formatNumber(value)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            // Sumbu X untuk nama personil
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                // Rotasi label untuk nama yang panjang
                                maxRotation: 45,
                                minRotation: 0,
                                font: {
                                    size: 10 // Ukuran font lebih kecil
                                }
                            }
                        },
                        y: {
                            // Sumbu Y untuk nilai penjualan
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            },
                            title: {
                                display: true,
                                text: 'Jumlah Penjualan',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    // Animasi dan interaksi
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
        
        function displayGroupedTableData(productGroups, showAllNik, showGapOnly) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            let totalRows = 0;
            let totalProducts = 0;
            let achievedCount = 0;
            
            if (Object.keys(productGroups).length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 inline-block">
                                <div class="flex items-center">
                                    <i class="bi bi-exclamation-triangle text-yellow-500 mr-2"></i>
                                    <strong class="text-yellow-800">Tidak ada data yang ditampilkan</strong>
                                </div>
                                <div class="mt-2 text-sm text-yellow-700">
                                    <p class="mb-1">Coba:</p>
                                    <ul class="list-disc pl-5 text-left">
                                        <li>Centang "Tampilkan semua personil"</li>
                                        <li>Hapus centang "Hanya tampilkan GAP negatif"</li>
                                        <li>Perluas periode tanggal</li>
                                        <li>Pilih filter yang lebih umum</li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                document.getElementById('rowCount').textContent = `0 baris`;
                document.getElementById('productCount').textContent = `0 produk`;
                return;
            }
            
            const sortedProducts = Object.keys(productGroups).sort();
            
            sortedProducts.forEach(product => {
                const sortedNik = Object.keys(productGroups[product])
                    .sort((a, b) => {
                        const nameA = getEmployeeName(a).toLowerCase();
                        const nameB = getEmployeeName(b).toLowerCase();
                        return nameA.localeCompare(nameB);
                    });
                
                const nikToDisplay = sortedNik.filter(nik => {
                    const data = productGroups[product][nik];
                    const actual = data.actual || 0;
                    const target = data.target || 0;
                    const gap = actual - target;
                    
                    if (showGapOnly && gap >= 0) return false;
                    if (!showAllNik && gap >= 0) return false;
                    return true;
                });
                
                if (nikToDisplay.length > 0) {
                    totalProducts++;
                    
                    // Header produk
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'bg-blue-50 border-t border-blue-100';
                    headerRow.innerHTML = `
                        <td colspan="5" class="px-6 py-3">
                            <div class="flex items-center">
                                <i class="bi bi-box text-secondary mr-2"></i>
                                <strong class="text-gray-800">${product}</strong>
                                <span class="ml-2 bg-gray-600 text-white text-xs font-semibold px-2 py-0.5 rounded-full">${nikToDisplay.length} personil</span>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(headerRow);
                    
                    // Data personil
                    nikToDisplay.forEach(nik => {
                        const data = productGroups[product][nik];
                        const actual = data.actual || 0;
                        const target = data.target || 0;
                        const achievement = target > 0 ? Math.round((actual / target) * 100) : 0;
                        const gap = actual - target;
                        
                        // Hitung apakah mencapai target
                        if (achievement >= 100) {
                            achievedCount++;
                        }
                        
                        let gapClass = 'text-gray-600';
                        let gapSign = '';
                        
                        if (gap > 0) {
                            gapClass = 'text-success';
                            gapSign = '+';
                        } else if (gap < 0) {
                            gapClass = 'text-danger';
                        }
                        
                        let progressBarClass = 'bg-danger';
                        if (achievement >= 100) progressBarClass = 'bg-success';
                        else if (achievement >= 70) progressBarClass = 'bg-warning';
                        else if (achievement === 0) progressBarClass = 'bg-secondary';
                        
                        const employeeName = getEmployeeName(nik);
                        
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-blue-50 transition duration-150';
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex flex-col">
                                    <div class="font-medium text-gray-900">${employeeName}</div>
                                    <div class="text-gray-500 text-xs mt-1">
                                        <span class="bg-gray-100 px-2 py-0.5 rounded">NIK: ${nik}</span>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-gray-900 font-medium">${formatNumber(target)}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-gray-900 font-medium">${formatNumber(actual)}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="w-full bg-gray-200 rounded-full h-2.5 mr-3">
                                        <div class="${progressBarClass} h-2.5 rounded-full" style="width: ${Math.min(achievement, 100)}%"></div>
                                    </div>
                                    <div class="text-gray-700 font-medium min-w-[45px]">${achievement}%</div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="${gapClass} font-bold">${gapSign}${formatNumber(gap)}</div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                        totalRows++;
                    });
                }
            });
            
            document.getElementById('rowCount').textContent = `${totalRows} baris`;
            document.getElementById('productCount').textContent = `${totalProducts} produk`;
            
            if (totalRows === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 inline-block">
                                <div class="flex items-center">
                                    <i class="bi bi-exclamation-triangle text-yellow-500 mr-2"></i>
                                    <strong class="text-yellow-800">Tidak ada data yang ditampilkan</strong>
                                </div>
                                <div class="mt-2 text-sm text-yellow-700">
                                    <p class="mb-1">Coba:</p>
                                    <ul class="list-disc pl-5 text-left">
                                        <li>Centang "Tampilkan semua personil"</li>
                                        <li>Hapus centang "Hanya tampilkan GAP negatif"</li>
                                        <li>Perluas periode tanggal</li>
                                        <li>Pilih filter yang lebih umum</li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
        
        // ==============================================
        // FUNGSI HELPER
        // ==============================================
        
        function formatNumber(num) {
            if (num === undefined || num === null) return '0';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }
        
        function showLoading(show, message = 'Memuat...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            if (show) {
                loadingText.textContent = message;
                overlay.style.display = 'flex';
            } else {
                overlay.style.display = 'none';
            }
        }
        
        function showError(message) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-8 text-center text-danger">
                        <i class="bi bi-x-circle mr-2"></i>
                        ${message}
                    </td>
                </tr>
            `;
        }
        
        function exportToCSV() {
            alert('Fitur export akan diimplementasikan');
        }
        
        // ==============================================
        // EVENT LISTENERS
        // ==============================================
        
        function setupEventListeners() {
            document.getElementById('applyFilter').addEventListener('click', applyFilters);
            
            document.getElementById('resetFilter').addEventListener('click', function() {
                setupDefaultDates();
                document.getElementById('shiftFilter').value = 'all';
                document.getElementById('productFilter').value = 'all';
                document.getElementById('nikFilter').value = 'all';
                document.getElementById('showAllNik').checked = true;
                document.getElementById('showGapOnly').checked = false;
                applyFilters();
            });
            
            document.getElementById('showAllNik').addEventListener('change', applyFilters);
            document.getElementById('showGapOnly').addEventListener('change', applyFilters);
            document.getElementById('exportData').addEventListener('click', exportToCSV);
            
            document.getElementById('startDate').addEventListener('change', applyFilters);
            document.getElementById('endDate').addEventListener('change', applyFilters);
            document.getElementById('shiftFilter').addEventListener('change', applyFilters);
            document.getElementById('productFilter').addEventListener('change', applyFilters);
            document.getElementById('nikFilter').addEventListener('change', applyFilters);
        }
        
        // ==============================================
        // INISIALISASI
        // ==============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 Halaman PSM per Personil dimuat');
            
            // Setup event listeners
            setupEventListeners();
            
            // Load data
            loadData();
            
            // Debug tools
            window.debugPSM = {
                loadData: loadData,
                applyFilters: applyFilters,
                getData: () => allData,
                parseDateUTC: parseDateUTC,
                formatDateToDDMMYYYY: formatDateToDDMMYYYY,
                formatDateToYYYYMMDD: formatDateToYYYYMMDD
            };
        });
    </script>
</body>
</html>
