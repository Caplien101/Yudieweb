<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSM per Personil - Dashboard Toko</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
        }
        
        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .filter-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .data-card {
            background-color: white;
            border-radius: 10px;
            padding: 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid #eee;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .gap-positive {
            color: var(--success-color);
            font-weight: 600;
        }
        
        .gap-negative {
            color: var(--danger-color);
            font-weight: 600;
        }
        
        .gap-neutral {
            color: var(--warning-color);
            font-weight: 600;
        }
        
        .progress-sm {
            height: 8px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .product-section {
            border-bottom: 1px solid #eee;
        }
        
        .product-header {
            background-color: #f8f9fa;
            font-weight: bold;
            padding: 12px 20px;
            border-bottom: 1px solid #dee2e6;
            border-top: 2px solid #3498db;
            font-size: 1.1em;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .achievement-cell {
            min-width: 120px;
        }
        
        .employee-nik {
            color: #666;
            font-size: 0.85em;
            font-family: monospace;
        }
        
        .employee-info {
            display: flex;
            flex-direction: column;
        }
        
        .employee-badge {
            background-color: #e9ecef;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.75em;
            display: inline-block;
            margin-top: 3px;
        }
        
        .stats-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .stats-section {
            border-left: 4px solid var(--secondary-color);
            padding-left: 15px;
            margin-bottom: 15px;
        }
        
        .stats-list {
            list-style-type: none;
            padding-left: 0;
            margin-bottom: 0;
        }
        
        .stats-list li {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .stats-list li:last-child {
            border-bottom: none;
        }
        
        .success-item {
            color: var(--success-color);
        }
        
        .warning-item {
            color: var(--warning-color);
        }
        
        .danger-item {
            color: var(--danger-color);
        }
        
        .info-badge {
            font-size: 0.8em;
            padding: 2px 6px;
            margin-left: 5px;
        }
        
        .percentage-badge {
            font-size: 0.75em;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .target-summary {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin-top: 5px;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="header">
            <h1><i class="bi bi-people me-2"></i>PSM Personil Toko</h1>
            <p class="mb-0">Monitoring Pencapaian Produk PSM per Personil</p>
        </div>
        
        <!-- Filter Section -->
        <div class="filter-card">
            <h5 class="mb-3"><i class="bi bi-funnel me-2"></i>Filter Data</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="startDate" class="form-label">Tanggal Awal</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div class="col-md-3">
                    <label for="endDate" class="form-label">Tanggal Akhir</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div class="col-md-2">
                    <label for="shiftFilter" class="form-label">Shift</label>
                    <select class="form-select" id="shiftFilter">
                        <option value="all">Semua</option>
                        <option value="1">Shift 1</option>
                        <option value="2">Shift 2</option>
                        <option value="3">Shift 3</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="productFilter" class="form-label">Produk</label>
                    <select class="form-select" id="productFilter">
                        <option value="all">Semua</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="nikFilter" class="form-label">Personil</label>
                    <select class="form-select" id="nikFilter">
                        <option value="all">Semua</option>
                    </select>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showAllNik" checked>
                        <label class="form-check-label" for="showAllNik">
                            <i class="bi bi-eye me-1"></i>Tampilkan semua personil
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showGapOnly">
                        <label class="form-check-label" for="showGapOnly">
                            <i class="bi bi-filter-circle me-1"></i>Hanya tampilkan GAP negatif
                        </label>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-primary me-2" id="applyFilter">
                        <i class="bi bi-filter-circle me-2"></i>Terapkan Filter
                    </button>
                    <button class="btn btn-outline-secondary" id="resetFilter">
                        <i class="bi bi-arrow-clockwise me-2"></i>Reset
                    </button>
                </div>
            </div>
            
            <div class="mt-3">
                <span id="dataPeriod" class="text-muted">Periode: Loading...</span>
                <span id="employeeCount" class="badge bg-info ms-2">0 personil</span>
                <span id="totalTargetBadge" class="badge bg-secondary ms-1">Target: 0</span>
            </div>
        </div>
        
        <!-- Stats Information -->
        <div class="stats-card">
            <h5 class="mb-3"><i class="bi bi-graph-up me-2"></i>Informasi Performa</h5>
            <div class="row">
                <div class="col-md-4">
                    <div class="stats-section">
                        <h6><i class="bi bi-trophy-fill text-warning me-2"></i>Top 3 Pencapaian Tertinggi</h6>
                        <div class="target-summary">
                            <small>Target Total: <span id="totalTargetValue">0</span></small>
                        </div>
                        <ul class="stats-list" id="topPerformers">
                            <li>Loading...</li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-section">
                        <h6><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Pencapaian Terendah</h6>
                        <div class="target-summary">
                            <small>Target Total: <span id="totalTargetValue2">0</span></small>
                        </div>
                        <ul class="stats-list" id="lowestPerformer">
                            <li>Loading...</li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-section">
                        <h6><i class="bi bi-check-circle-fill text-success me-2"></i>Mencapai Target per Produk</h6>
                        <div class="target-summary">
                            <small>Hanya yang mencapai 100% per produk</small>
                        </div>
                        <ul class="stats-list" id="achievedTarget">
                            <li>Loading...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Section -->
        <div class="data-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-table me-2"></i>Data PSM per Personil
                    <span class="badge bg-primary ms-2" id="rowCount">0 baris</span>
                    <span class="badge bg-secondary ms-1" id="productCount">0 produk</span>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary" id="exportData">
                        <i class="bi bi-download me-1"></i>Export CSV
                    </button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="psmTable">
                    <thead class="table-light">
                        <tr>
                            <th>Personil</th>
                            <th>Target per Personil</th>
                            <th>Actual per Personil</th>
                            <th class="achievement-cell">Pencapaian</th>
                            <th>GAP</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Info Panel -->
        <div class="alert alert-info mt-3">
            <h6><i class="bi bi-info-circle me-2"></i>Informasi</h6>
            <ul class="mb-0">
                <li>Data diambil dari Google Apps Script API</li>
                <li>Target dihitung secara proporsional berdasarkan periode yang dipilih</li>
                <li>GAP = Actual - Target (positif = melebihi target, negatif = di bawah target)</li>
                <li><strong>Target total sama untuk semua personil</strong> - perbandingan berdasarkan actual penjualan</li>
            </ul>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5>Memuat data dari server...</h5>
            <p class="text-muted" id="loadingText">Mengambil data PSM dan target</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ==============================================
    // KONFIGURASI
    // ==============================================
    const API_URL = 'https://script.google.com/macros/s/AKfycby_L_vmTHUtl7NUr3qHI-upGlPNUWKJ1uRgPFOPWgWofMDU8siS1Ex_YHR-y0P69E-cGA/exec';
    
    // Variabel global
    let allData = {};
    let currentStartDate, currentEndDate;
    let nikToNameMap = {};
    let currentProductGroupsWithTarget = {};
    let totalTargetForAll = 0;
    
    // ==============================================
    // FUNGSI PARSING TANGGAL - SOLUSI UTAMA
    // ==============================================
    
    // Fungsi utama untuk parsing tanggal dengan timezone UTC
    function parseDateUTC(dateString) {
        if (!dateString || dateString.trim() === '') {
            console.warn('Tanggal kosong atau null:', dateString);
            return null;
        }
        
        // Debug info
        console.log(`ðŸ“… Parsing: "${dateString}"`);
        
        // 1. Jika sudah Date object
        if (dateString instanceof Date) {
            return dateString;
        }
        
        // 2. Coba format ISO: "2026-01-01"
        if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
            // Parsing sebagai UTC (bukan local time)
            const parts = dateString.split('-');
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const day = parseInt(parts[2], 10);
            
            // Buat tanggal di UTC (midnight UTC)
            const date = new Date(Date.UTC(year, month, day, 0, 0, 0));
            console.log(`   âœ… Format ISO -> UTC: ${date.toISOString()}`);
            return date;
        }
        
        // 3. Coba format Indonesia: "01/01/2026"
        if (dateString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
            // Parsing sebagai UTC
            const parts = dateString.split('/');
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const year = parseInt(parts[2], 10);
            
            // Buat tanggal di UTC (midnight UTC)
            const date = new Date(Date.UTC(year, month, day, 0, 0, 0));
            console.log(`   âœ… Format DD/MM/YYYY -> UTC: ${date.toISOString()}`);
            return date;
        }
        
        // 4. Coba format D/M/YYYY: "1/1/2026"
        if (dateString.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
            const parts = dateString.split('/');
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const year = parseInt(parts[2], 10);
            
            const date = new Date(Date.UTC(year, month, day, 0, 0, 0));
            console.log(`   âœ… Format D/M/YYYY -> UTC: ${date.toISOString()}`);
            return date;
        }
        
        // 5. Coba parsing langsung (fallback)
        const date = new Date(dateString);
        if (!isNaN(date.getTime())) {
            console.log(`   âš ï¸  Direct parse -> ${date.toISOString()}`);
            return date;
        }
        
        console.error(`   âŒ Gagal parsing: "${dateString}"`);
        return null;
    }
    
    // Fungsi untuk konversi date object ke string YYYY-MM-DD
    function formatDateToYYYYMMDD(date) {
        if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
            return '';
        }
        
        const year = date.getUTCFullYear();
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const day = String(date.getUTCDate()).padStart(2, '0');
        
        return `${year}-${month}-${day}`;
    }
    
    // Fungsi untuk konversi ke format Indonesia
    function formatDateToDDMMYYYY(date) {
        if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
            return 'Invalid Date';
        }
        
        const day = String(date.getUTCDate()).padStart(2, '0');
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const year = date.getUTCFullYear();
        
        return `${day}/${month}/${year}`;
    }
    
    // ==============================================
    // FUNGSI NORMALISASI DATA
    // ==============================================
    
    function normalizeData(rawData) {
        console.log('=== NORMALISASI DATA ===');
        
        const normalizedData = {
            data_psm: [],
            target_psm: [],
            data_nik: [],
            _meta: {
                data_psm_count: 0,
                target_psm_count: 0
            }
        };
        
        // 1. Normalisasi Data PSM
        if (rawData.data_psm && Array.isArray(rawData.data_psm)) {
            console.log(`ðŸ“Š Processing ${rawData.data_psm.length} PSM records`);
            
            rawData.data_psm.forEach((record, index) => {
                const normalized = { ...record };
                
                // Parse tanggal dengan UTC
                if (record.tanggal) {
                    const parsedDate = parseDateUTC(record.tanggal);
                    if (parsedDate) {
                        normalized.tanggal_utc = parsedDate;
                        normalized.tanggal_iso = parsedDate.toISOString().split('T')[0];
                        normalized.tanggal_display = formatDateToDDMMYYYY(parsedDate);
                    }
                }
                
                // Normalisasi angka
                normalized.qty_numeric = parseInt(record.qty) || 0;
                normalized.shift_numeric = parseInt(record.shift) || 0;
                normalized.nik_string = record.nik ? record.nik.toString() : 'unknown';
                
                normalizedData.data_psm.push(normalized);
                
                // Debug beberapa record pertama
                if (index < 3) {
                    console.log(`   Sample ${index + 1}: ${record.tanggal} -> ${normalized.tanggal_iso}`);
                }
            });
            
            normalizedData._meta.data_psm_count = normalizedData.data_psm.length;
        }
        
        // 2. Normalisasi Target PSM
        if (rawData.target_psm && Array.isArray(rawData.target_psm)) {
            console.log(`ðŸŽ¯ Processing ${rawData.target_psm.length} target records`);
            
            rawData.target_psm.forEach((record, index) => {
                const normalized = { ...record };
                
                // Parse tanggal start
                if (record.start_date) {
                    const parsedStart = parseDateUTC(record.start_date);
                    if (parsedStart) {
                        normalized.start_date_utc = parsedStart;
                        normalized.start_date_iso = parsedStart.toISOString().split('T')[0];
                    }
                }
                
                // Parse tanggal end
                if (record.end_date) {
                    const parsedEnd = parseDateUTC(record.end_date);
                    if (parsedEnd) {
                        normalized.end_date_utc = parsedEnd;
                        normalized.end_date_iso = parsedEnd.toISOString().split('T')[0];
                    }
                }
                
                // Normalisasi target
                normalized.target_pernik_numeric = parseInt(record.target_pernik) || 0;
                
                normalizedData.target_psm.push(normalized);
                
                // Debug beberapa record pertama
                if (index < 3) {
                    console.log(`   Target ${index + 1}: ${record.start_date}-${record.end_date} -> ${normalized.start_date_iso}-${normalized.end_date_iso}`);
                }
            });
            
            normalizedData._meta.target_psm_count = normalizedData.target_psm.length;
        }
        
        // 3. Data NIK
        if (rawData.data_nik) {
            normalizedData.data_nik = rawData.data_nik;
        }
        
        console.log('âœ… Normalisasi selesai');
        return normalizedData;
    }
    
    // ==============================================
    // FUNGSI UTAMA
    // ==============================================
    
    async function loadData() {
        try {
            showLoading(true, 'Menghubungkan ke server...');
            
            console.log('ðŸ“¡ Mengambil data dari API...');
            const response = await fetch(API_URL);
            const rawData = await response.json();
            
            console.log('âœ… Data mentah diterima');
            console.log('ðŸ“Š Struktur data:', {
                data_psm_count: rawData.data_psm?.length || 0,
                target_psm_count: rawData.target_psm?.length || 0,
                data_nik_count: rawData.data_nik?.length || 0
            });
            
            // Debug: tampilkan beberapa data sample
            if (rawData.data_psm && rawData.data_psm.length > 0) {
                console.log('ðŸ” SAMPLE DATA PSM (5 pertama):');
                rawData.data_psm.slice(0, 5).forEach((item, i) => {
                    console.log(`${i + 1}. Tanggal: "${item.tanggal}", NIK: ${item.nik}, Produk: ${item.nama_produk}, Qty: ${item.qty}`);
                });
            }
            
            // Normalisasi data
            allData = normalizeData(rawData);
            
            // Proses mapping NIK
            processNIKData();
            
            // Setup UI
            setupDefaultDates();
            populateFilters();
            
            // Terapkan filter awal
            applyFilters();
            
            showLoading(false);
            
        } catch (error) {
            console.error('âŒ Error loading data:', error);
            showLoading(false);
            alert('Gagal memuat data. Silakan refresh halaman.');
        }
    }
    
    function processNIKData() {
        const nikRecords = allData.data_nik || [];
        nikToNameMap = {};
        
        nikRecords.forEach(record => {
            if (record.nik) {
                const nikStr = record.nik.toString();
                nikToNameMap[nikStr] = record.nama || `Personil ${nikStr}`;
            }
        });
        
        // Backup dari data PSM
        const psmData = allData.data_psm || [];
        psmData.forEach(record => {
            if (record.nik_string && record.nik_string !== 'unknown' && !nikToNameMap[record.nik_string]) {
                nikToNameMap[record.nik_string] = `Personil ${record.nik_string}`;
            }
        });
        
        console.log(`âœ… Mapping NIK: ${Object.keys(nikToNameMap).length} personil`);
        document.getElementById('employeeCount').textContent = `${Object.keys(nikToNameMap).length} personil`;
    }
    
    function getEmployeeName(nik) {
        if (!nik) return 'Tidak diketahui';
        const nikStr = nik.toString();
        return nikToNameMap[nikStr] || `Personil ${nikStr}`;
    }
    
    function setupDefaultDates() {
        // Default: 7 hari terakhir
        const today = new Date();
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(today.getDate() - 6); // 7 hari termasuk hari ini
        
        // Format untuk input date (YYYY-MM-DD)
        document.getElementById('startDate').value = formatDateToYYYYMMDD(sevenDaysAgo);
        document.getElementById('endDate').value = formatDateToYYYYMMDD(today);
        
        currentStartDate = formatDateToYYYYMMDD(sevenDaysAgo);
        currentEndDate = formatDateToYYYYMMDD(today);
        
        updatePeriodText();
    }
    
    function updatePeriodText() {
        const start = parseDateUTC(currentStartDate);
        const end = parseDateUTC(currentEndDate);
        
        if (!start || !end) {
            document.getElementById('dataPeriod').textContent = 'Periode: Tanggal tidak valid';
            return;
        }
        
        const formattedStart = formatDateToDDMMYYYY(start);
        const formattedEnd = formatDateToDDMMYYYY(end);
        
        document.getElementById('dataPeriod').innerHTML = 
            `<i class="bi bi-calendar me-1"></i>Periode: ${formattedStart} - ${formattedEnd}`;
    }
    
    function populateFilters() {
        const psmData = allData.data_psm || [];
        
        // Produk
        const products = [...new Set(psmData.map(item => item.nama_produk).filter(Boolean))].sort();
        const productFilter = document.getElementById('productFilter');
        
        while (productFilter.options.length > 1) {
            productFilter.remove(1);
        }
        
        products.forEach(product => {
            const option = document.createElement('option');
            option.value = product;
            option.textContent = product;
            productFilter.appendChild(option);
        });
        
        // Personil
        const nikList = [...new Set(psmData.map(item => item.nik_string).filter(nik => nik && nik !== 'unknown'))].sort();
        const nikFilter = document.getElementById('nikFilter');
        
        while (nikFilter.options.length > 1) {
            nikFilter.remove(1);
        }
        
        nikList.forEach(nik => {
            const option = document.createElement('option');
            option.value = nik;
            const employeeName = getEmployeeName(nik);
            option.textContent = `${employeeName} (${nik})`;
            nikFilter.appendChild(option);
        });
        
        console.log(`ðŸ“¦ Produk: ${products.length}, ðŸ‘¤ Personil: ${nikList.length}`);
    }
    
    function applyFilters() {
        console.log('ðŸ”§ Menerapkan filter...');
        
        // Ambil nilai filter
        const startDateStr = document.getElementById('startDate').value;
        const endDateStr = document.getElementById('endDate').value;
        const shiftFilter = document.getElementById('shiftFilter').value;
        const productFilter = document.getElementById('productFilter').value;
        const nikFilter = document.getElementById('nikFilter').value;
        const showAllNik = document.getElementById('showAllNik').checked;
        const showGapOnly = document.getElementById('showGapOnly').checked;
        
        // Parse tanggal filter (dari input user, format YYYY-MM-DD)
        const startDate = parseDateUTC(startDateStr);
        let endDate = parseDateUTC(endDateStr);
        
        if (!startDate || !endDate) {
            showError('Tanggal filter tidak valid');
            return;
        }
        
        // Set endDate ke akhir hari (23:59:59.999)
        endDate.setUTCHours(23, 59, 59, 999);
        
        console.log(`ðŸ“… Filter periode: ${startDate.toISOString()} - ${endDate.toISOString()}`);
        console.log(`âš™ï¸ Filter: Shift=${shiftFilter}, Produk=${productFilter}, NIK=${nikFilter}`);
        
        // Proses data
        processAndDisplayData(startDate, endDate, {
            shiftFilter,
            productFilter,
            nikFilter,
            showAllNik,
            showGapOnly
        });
    }
    
    function processAndDisplayData(filterStartDate, filterEndDate, filters) {
        try {
            const psmData = allData.data_psm || [];
            const targetPSM = allData.target_psm || [];
            
            console.log(`ðŸ” Filtering ${psmData.length} records...`);
            
            // 1. Filter berdasarkan tanggal (UTC)
            let filteredPsmData = psmData.filter(item => {
                if (!item.tanggal_utc) return false;
                
                // Bandingkan dengan filter range
                return item.tanggal_utc >= filterStartDate && item.tanggal_utc <= filterEndDate;
            });
            
            console.log(`ðŸ“Š Setelah filter tanggal: ${filteredPsmData.length} records`);
            
            // 2. Filter shift
            if (filters.shiftFilter !== 'all') {
                const shift = parseInt(filters.shiftFilter);
                filteredPsmData = filteredPsmData.filter(item => item.shift_numeric === shift);
                console.log(`ðŸ“Š Setelah filter shift: ${filteredPsmData.length} records`);
            }
            
            // 3. Filter produk
            if (filters.productFilter !== 'all') {
                filteredPsmData = filteredPsmData.filter(item => item.nama_produk === filters.productFilter);
                console.log(`ðŸ“Š Setelah filter produk: ${filteredPsmData.length} records`);
            }
            
            // 4. Filter NIK
            if (filters.nikFilter !== 'all') {
                filteredPsmData = filteredPsmData.filter(item => item.nik_string === filters.nikFilter);
                console.log(`ðŸ“Š Setelah filter NIK: ${filteredPsmData.length} records`);
            }
            
            // Debug: tampilkan sample data yang lolos filter
            if (filteredPsmData.length > 0) {
                console.log('ðŸ“ Data yang lolos filter (3 pertama):');
                filteredPsmData.slice(0, 3).forEach((item, i) => {
                    console.log(`${i+1}. ${item.tanggal_display} | ${item.nik_string} | ${item.nama_produk} | Qty: ${item.qty_numeric}`);
                });
            }
            
            // 5. Kelompokkan data: Produk -> NIK -> Total Qty
            const productGroups = {};
            
            filteredPsmData.forEach(item => {
                const product = item.nama_produk;
                const nik = item.nik_string;
                const qty = item.qty_numeric;
                
                if (!productGroups[product]) {
                    productGroups[product] = {};
                }
                
                if (!productGroups[product][nik]) {
                    productGroups[product][nik] = 0;
                }
                
                productGroups[product][nik] += qty;
            });
            
            console.log(`ðŸ“¦ Produk yang ditemukan: ${Object.keys(productGroups).length}`);
            
            // 6. Hitung target total
            totalTargetForAll = 0;
            
            targetPSM.forEach(targetItem => {
                const targetStart = targetItem.start_date_utc;
                const targetEnd = targetItem.end_date_utc;
                
                if (!targetStart || !targetEnd) return;
                
                // Cek overlap periode (UTC)
                if (filterStartDate <= targetEnd && filterEndDate >= targetStart) {
                    const overlapStart = new Date(Math.max(filterStartDate.getTime(), targetStart.getTime()));
                    const overlapEnd = new Date(Math.min(filterEndDate.getTime(), targetEnd.getTime()));
                    const overlapDays = Math.max(0, Math.floor((overlapEnd - overlapStart) / (1000 * 60 * 60 * 24)) + 1);
                    
                    const targetTotalDays = Math.floor((targetEnd - targetStart) / (1000 * 60 * 60 * 24)) + 1;
                    
                    if (targetTotalDays > 0) {
                        const proportion = overlapDays / targetTotalDays;
                        const targetPerNik = Math.round(targetItem.target_pernik_numeric * proportion);
                        totalTargetForAll += targetPerNik;
                    }
                }
            });
            
            console.log(`ðŸŽ¯ Total target: ${totalTargetForAll}`);
            
            // Update UI target
            document.getElementById('totalTargetBadge').textContent = `Target: ${formatNumber(totalTargetForAll)}`;
            document.getElementById('totalTargetValue').textContent = formatNumber(totalTargetForAll);
            document.getElementById('totalTargetValue2').textContent = formatNumber(totalTargetForAll);
            
            // 7. Hitung target per produk per NIK
            currentProductGroupsWithTarget = {};
            
            Object.keys(productGroups).forEach(product => {
                currentProductGroupsWithTarget[product] = {};
                Object.keys(productGroups[product]).forEach(nik => {
                    currentProductGroupsWithTarget[product][nik] = {
                        actual: productGroups[product][nik],
                        target: 0
                    };
                });
            });
            
            // Hitung target per produk
            targetPSM.forEach(targetItem => {
                const targetStart = targetItem.start_date_utc;
                const targetEnd = targetItem.end_date_utc;
                
                if (!targetStart || !targetEnd) return;
                
                const product = targetItem.nama_produk;
                
                // Cek overlap periode
                if (filterStartDate <= targetEnd && filterEndDate >= targetStart) {
                    const overlapStart = new Date(Math.max(filterStartDate.getTime(), targetStart.getTime()));
                    const overlapEnd = new Date(Math.min(filterEndDate.getTime(), targetEnd.getTime()));
                    const overlapDays = Math.max(0, Math.floor((overlapEnd - overlapStart) / (1000 * 60 * 60 * 24)) + 1);
                    
                    const targetTotalDays = Math.floor((targetEnd - targetStart) / (1000 * 60 * 60 * 24)) + 1;
                    
                    if (targetTotalDays > 0) {
                        const proportion = overlapDays / targetTotalDays;
                        const targetPerNik = Math.round(targetItem.target_pernik_numeric * proportion);
                        
                        // Distribusikan ke NIK yang menjual produk ini
                        if (currentProductGroupsWithTarget[product]) {
                            Object.keys(currentProductGroupsWithTarget[product]).forEach(nik => {
                                currentProductGroupsWithTarget[product][nik].target += targetPerNik;
                            });
                        }
                    }
                }
            });
            
            // 8. Hitung statistik
            calculateAndDisplayStats();
            
            // 9. Tampilkan tabel
            displayGroupedTableData(currentProductGroupsWithTarget, filters.showAllNik, filters.showGapOnly);
            
        } catch (error) {
            console.error('âŒ Error processing data:', error);
            showError('Terjadi kesalahan dalam memproses data');
        }
    }
    
    function calculateAndDisplayStats() {
        try {
            // Hitung total actual per personil
            const employeeActualTotals = {};
            
            Object.keys(currentProductGroupsWithTarget).forEach(product => {
                Object.keys(currentProductGroupsWithTarget[product]).forEach(nik => {
                    const data = currentProductGroupsWithTarget[product][nik];
                    const actual = data.actual || 0;
                    
                    if (!employeeActualTotals[nik]) {
                        employeeActualTotals[nik] = {
                            totalActual: 0,
                            achievements: []
                        };
                    }
                    
                    employeeActualTotals[nik].totalActual += actual;
                    
                    const targetPerProduct = data.target || 0;
                    const achievementPerProduct = targetPerProduct > 0 ? Math.round((actual / targetPerProduct) * 100) : 0;
                    employeeActualTotals[nik].achievements.push({
                        product: product,
                        achievement: achievementPerProduct,
                        actual: actual,
                        target: targetPerProduct
                    });
                });
            });
            
            // Hitung persentase per personil
            const employeePercentages = [];
            
            Object.keys(employeeActualTotals).forEach(nik => {
                const totals = employeeActualTotals[nik];
                const percentage = totalTargetForAll > 0 ? 
                    Math.round((totals.totalActual / totalTargetForAll) * 100) : 0;
                
                employeePercentages.push({
                    nik: nik,
                    employeeName: getEmployeeName(nik),
                    percentage: percentage,
                    totalActual: totals.totalActual,
                    totalTarget: totalTargetForAll,
                    achievements: totals.achievements
                });
            });
            
            // Top 3 Performers
            const topPerformers = [...employeePercentages]
                .filter(item => totalTargetForAll > 0)
                .sort((a, b) => b.percentage - a.percentage)
                .slice(0, 3);
            
            const topPerformersList = document.getElementById('topPerformers');
            if (topPerformers.length > 0) {
                topPerformersList.innerHTML = '';
                topPerformers.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'success-item';
                    
                    let badgeClass = 'bg-success';
                    if (item.percentage >= 200) badgeClass = 'bg-primary';
                    else if (item.percentage >= 150) badgeClass = 'bg-success';
                    else if (item.percentage >= 100) badgeClass = 'bg-warning';
                    else badgeClass = 'bg-info';
                    
                    li.innerHTML = `
                        <strong>${item.employeeName}</strong>
                        <br>
                        <small>Actual ${formatNumber(item.totalActual)} / Target ${formatNumber(item.totalTarget)}</small>
                        <span class="badge ${badgeClass} percentage-badge">${item.percentage}%</span>
                        <span class="badge bg-warning info-badge">${index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}</span>
                    `;
                    topPerformersList.appendChild(li);
                });
            } else {
                topPerformersList.innerHTML = '<li class="text-muted">Tidak ada data</li>';
            }
            
            // Lowest Performer
            const lowestPerformer = [...employeePercentages]
                .filter(item => totalTargetForAll > 0 && item.totalActual > 0)
                .sort((a, b) => a.percentage - b.percentage)[0];
            
            const lowestPerformerList = document.getElementById('lowestPerformer');
            if (lowestPerformer) {
                let textClass = 'danger-item';
                if (lowestPerformer.percentage >= 100) textClass = 'success-item';
                else if (lowestPerformer.percentage >= 70) textClass = 'warning-item';
                
                lowestPerformerList.innerHTML = `
                    <li class="${textClass}">
                        <strong>${lowestPerformer.employeeName}</strong>
                        <br>
                        <small>Actual ${formatNumber(lowestPerformer.totalActual)} / Target ${formatNumber(lowestPerformer.totalTarget)}</small>
                        <span class="badge ${lowestPerformer.percentage >= 100 ? 'bg-success' : 'bg-danger'} percentage-badge">${lowestPerformer.percentage}%</span>
                    </li>
                `;
            } else {
                lowestPerformerList.innerHTML = '<li class="text-muted">Tidak ada data</li>';
            }
            
            // Achieved Target per Product
            const achievedTargetPerProduct = [];
            
            employeePercentages.forEach(employee => {
                const productsAchieved = employee.achievements
                    .filter(achievement => achievement.achievement >= 100)
                    .map(achievement => achievement.product);
                
                if (productsAchieved.length > 0) {
                    achievedTargetPerProduct.push({
                        nik: employee.nik,
                        employeeName: employee.employeeName,
                        products: productsAchieved,
                        count: productsAchieved.length,
                        totalProducts: employee.achievements.length
                    });
                }
            });
            
            achievedTargetPerProduct.sort((a, b) => b.count - a.count);
            
            const achievedTargetList = document.getElementById('achievedTarget');
            if (achievedTargetPerProduct.length > 0) {
                achievedTargetList.innerHTML = '';
                const displayItems = achievedTargetPerProduct.slice(0, 5);
                displayItems.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'success-item';
                    
                    const productsText = item.products.length <= 2 ? 
                        item.products.join(', ') : 
                        `${item.products[0]}, ${item.products[1]} +${item.products.length - 2}`;
                    
                    li.innerHTML = `
                        <strong>${item.employeeName}</strong>
                        <br>
                        <small>${productsText}</small>
                        <span class="badge bg-success info-badge">${item.count}/${item.totalProducts}</span>
                    `;
                    achievedTargetList.appendChild(li);
                });
                
                if (achievedTargetPerProduct.length > 5) {
                    const li = document.createElement('li');
                    li.className = 'text-muted';
                    li.innerHTML = `<small>dan ${achievedTargetPerProduct.length - 5} lainnya...</small>`;
                    achievedTargetList.appendChild(li);
                }
            } else {
                achievedTargetList.innerHTML = '<li class="text-muted">Belum ada yang mencapai target per produk</li>';
            }
            
        } catch (error) {
            console.error('Error calculating stats:', error);
            document.getElementById('topPerformers').innerHTML = '<li class="text-muted">Error menghitung data</li>';
            document.getElementById('lowestPerformer').innerHTML = '<li class="text-muted">Error menghitung data</li>';
            document.getElementById('achievedTarget').innerHTML = '<li class="text-muted">Error menghitung data</li>';
        }
    }
    
    function displayGroupedTableData(productGroups, showAllNik, showGapOnly) {
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';
        
        let totalRows = 0;
        let totalProducts = 0;
        
        if (Object.keys(productGroups).length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-5">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Tidak ada data yang ditampilkan</strong>
                            <div class="mt-2">
                                <small>
                                    Coba:
                                    1. Centang "Tampilkan semua personil"
                                    2. Hapus centang "Hanya tampilkan GAP negatif"
                                    3. Perluas periode tanggal
                                    4. Pilih filter yang lebih umum
                                </small>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
            document.getElementById('rowCount').textContent = `0 baris`;
            document.getElementById('productCount').textContent = `0 produk`;
            return;
        }
        
        const sortedProducts = Object.keys(productGroups).sort();
        
        sortedProducts.forEach(product => {
            const sortedNik = Object.keys(productGroups[product])
                .sort((a, b) => {
                    const nameA = getEmployeeName(a).toLowerCase();
                    const nameB = getEmployeeName(b).toLowerCase();
                    return nameA.localeCompare(nameB);
                });
            
            const nikToDisplay = sortedNik.filter(nik => {
                const data = productGroups[product][nik];
                const actual = data.actual || 0;
                const target = data.target || 0;
                const gap = actual - target;
                
                if (showGapOnly && gap >= 0) return false;
                if (!showAllNik && gap >= 0) return false;
                return true;
            });
            
            if (nikToDisplay.length > 0) {
                totalProducts++;
                
                const headerRow = document.createElement('tr');
                headerRow.className = 'product-header';
                headerRow.innerHTML = `
                    <td colspan="5">
                        <i class="bi bi-box me-2"></i>
                        <strong>${product}</strong>
                        <span class="badge bg-secondary ms-2">${nikToDisplay.length} personil</span>
                    </td>
                `;
                tableBody.appendChild(headerRow);
                
                nikToDisplay.forEach(nik => {
                    const data = productGroups[product][nik];
                    const actual = data.actual || 0;
                    const target = data.target || 0;
                    const achievement = target > 0 ? Math.round((actual / target) * 100) : 0;
                    const gap = actual - target;
                    
                    let gapClass = 'gap-neutral';
                    let gapSign = '';
                    
                    if (gap > 0) {
                        gapClass = 'gap-positive';
                        gapSign = '+';
                    } else if (gap < 0) {
                        gapClass = 'gap-negative';
                    }
                    
                    let progressBarClass = 'bg-danger';
                    if (achievement >= 100) progressBarClass = 'bg-success';
                    else if (achievement >= 70) progressBarClass = 'bg-warning';
                    
                    const employeeName = getEmployeeName(nik);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="employee-info">
                                <strong>${employeeName}</strong>
                                <div class="employee-nik">
                                    <span class="employee-badge">NIK: ${nik}</span>
                                </div>
                            </div>
                        </td>
                        <td>${formatNumber(target)}</td>
                        <td>${formatNumber(actual)}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2 progress-sm">
                                    <div class="progress-bar ${progressBarClass}" 
                                         style="width: ${Math.min(achievement, 100)}%"></div>
                                </div>
                                <span class="ms-1" style="min-width: 40px;">${achievement}%</span>
                            </div>
                        </td>
                        <td class="${gapClass}">${gapSign}${formatNumber(gap)}</td>
                    `;
                    tableBody.appendChild(row);
                    totalRows++;
                });
            }
        });
        
        document.getElementById('rowCount').textContent = `${totalRows} baris`;
        document.getElementById('productCount').textContent = `${totalProducts} produk`;
        
        if (totalRows === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-5">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Tidak ada data yang ditampilkan</strong>
                            <div class="mt-2">
                                <small>
                                    Coba:
                                    1. Centang "Tampilkan semua personil"
                                    2. Hapus centang "Hanya tampilkan GAP negatif"
                                    3. Perluas periode tanggal
                                    4. Pilih filter yang lebih umum
                                </small>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        console.log(`âœ… Tampilkan data: ${totalProducts} produk, ${totalRows} baris`);
    }
    
    // ==============================================
    // FUNGSI HELPER
    // ==============================================
    
    function formatNumber(num) {
        if (num === undefined || num === null) return '0';
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
    
    function showLoading(show, message = 'Memuat...') {
        const overlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        
        if (show) {
            loadingText.textContent = message;
            overlay.style.display = 'flex';
        } else {
            overlay.style.display = 'none';
        }
    }
    
    function showError(message) {
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-danger py-5">
                    <i class="bi bi-x-circle me-2"></i>
                    ${message}
                </td>
            </tr>
        `;
    }
    
    function exportToCSV() {
        alert('Fitur export akan diimplementasikan');
    }
    
    // ==============================================
    // EVENT LISTENERS
    // ==============================================
    
    function setupEventListeners() {
        document.getElementById('applyFilter').addEventListener('click', applyFilters);
        
        document.getElementById('resetFilter').addEventListener('click', function() {
            setupDefaultDates();
            document.getElementById('shiftFilter').value = 'all';
            document.getElementById('productFilter').value = 'all';
            document.getElementById('nikFilter').value = 'all';
            document.getElementById('showAllNik').checked = true;
            document.getElementById('showGapOnly').checked = false;
            console.log('ðŸ”„ Filter direset');
            applyFilters();
        });
        
        document.getElementById('showAllNik').addEventListener('change', applyFilters);
        document.getElementById('showGapOnly').addEventListener('change', applyFilters);
        document.getElementById('exportData').addEventListener('click', exportToCSV);
        
        document.getElementById('startDate').addEventListener('change', applyFilters);
        document.getElementById('endDate').addEventListener('change', applyFilters);
        document.getElementById('shiftFilter').addEventListener('change', applyFilters);
        document.getElementById('productFilter').addEventListener('change', applyFilters);
        document.getElementById('nikFilter').addEventListener('change', applyFilters);
    }
    
    // ==============================================
    // INISIALISASI
    // ==============================================
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ðŸ“„ Halaman PSM per Personil dimuat');
        
        // Setup event listeners
        setupEventListeners();
        
        // Load data
        loadData();
        
        // Debug tools
        window.debugPSM = {
            loadData: loadData,
            applyFilters: applyFilters,
            getData: () => allData,
            parseDateUTC: parseDateUTC,
            formatDateToDDMMYYYY: formatDateToDDMMYYYY,
            formatDateToYYYYMMDD: formatDateToYYYYMMDD,
            
            // Test parsing
            testParsing: function() {
                const testDates = [
                    '2026-01-01',
                    '01/01/2026',
                    '31/12/2025',
                    '2026-01-31'
                ];
                
                console.log('ðŸ§ª Testing date parsing:');
                testDates.forEach(dateStr => {
                    const parsed = parseDateUTC(dateStr);
                    console.log(`"${dateStr}" -> ${parsed ? parsed.toISOString() : 'null'}`);
                });
            }
        };
    });
</script>
</body>
</html>
