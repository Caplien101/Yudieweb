<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Database 100K+ Rows - FINAL NO ERROR</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/minisearch@6.3.0/dist/umd/index.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; max-width: 1000px; margin: 0 auto; padding: 12px; background: #f5f5f5; color: #1f1f1f; }
    h1 { font-size: 1.6rem; margin-bottom: 16px; text-align: center; color: #6200ea; }
    .search-container { position: sticky; top: 0; background: #f5f5f5; padding: 12px 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; border-radius: 12px; }
    .search-wrapper { position: relative; }
    input[type="text"] { width: 100%; padding: 14px 44px 14px 16px; font-size: 16px; border: 2px solid #ddd; border-radius: 12px; outline: none; transition: all 0.2s; }
    input[type="text"]:focus { border-color: #6200ea; box-shadow: 0 0 0 4px rgba(98,0,234,0.15); }
    .clear-btn { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #888; font-size: 20px; }
    .refresh-btn { margin-top: 10px; width: 100%; padding: 12px; background: #6200ea; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; }
    .refresh-btn:hover { background: #3700b3; }
    .stats { text-align: center; color: #555; font-size: 0.9rem; margin: 10px 0; font-weight: 600; }
    .virtual-list { height: calc(100vh - 280px); position: relative; overflow-y: auto; border: 1px solid #ddd; border-radius: 12px; background: white; }
    .card { background: white; margin: 8px 4px; padding: 16px; border-radius: 12px; box-shadow: 0 1px 6px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .card h3 { margin: 0 0 8px; font-size: 0.8rem; color: #666; text-transform: uppercase; }
    .card p { margin: 6px 0; font-size: 14px; line-height: 1.5; }
    .card p.question { color: #1a73e8; font-weight: 600; }
    .card p.answer { color: #d81b60; }
    .highlight { background: #ffeb3b; padding: 0 3px; border-radius: 3px; font-weight: 600; }
    .loading, .error, .no-results { text-align: center; padding: 20px; border-radius: 12px; margin: 20px 0; display: none; font-weight: 500; }
    .loading { background: #e3f2fd; color: #1976d2; }
    .error { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
    .no-results { background: #f8f9fa; color: #666; }
    .debug { background: #fff3e0; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 200px; overflow: auto; display: block; margin: 10px 0; border: 1px solid #ffcc80; }
    @media (max-width: 600px) { .virtual-list { height: calc(100vh - 260px); } }
  </style>
</head>
<body>
  <h1>Database Functional Test</h1>
  <div class="search-container">
    <div class="search-wrapper">
      <input type="text" id="searchInput" placeholder="Ketik kategori / pertanyaan / jawaban…" autocomplete="off">
      <button class="clear-btn" id="clearBtn" aria-label="Clear">X</button>
    </div>
    <button class="refresh-btn" id="refreshBtn">Refresh Data</button>
  </div>

  <div class="stats" id="stats">Memuat data…</div>
  <div class="loading" id="loading">Sedang mengunduh dari Google Sheets…</div>
  <div class="error" id="error"></div>
  <div class="no-results" id="noResults">Tidak ada hasil ditemukan.</div>
  <pre class="debug" id="debug">Log akan muncul di sini...</pre>
  <div class="virtual-list" id="virtualList"></div>

  <script>
    // GANTI INI SAJA!
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxRRmp9wYJi6ckuinfc6DznbGZ3KVke_O4jJd1eix1ZnSEGW29nUBL979OHIyQCluYe/exec';
    
    const PAGE_SIZE = 2000;
    const DB_NAME = 'SheetDB_Ultimate';
    const STORE_NAME = 'rows';

    // IndexedDB - Compatible semua browser
    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 3);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (db.objectStoreNames.contains(STORE_NAME)) db.deleteObjectStore(STORE_NAME);
          db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function getAllData() {
      const db = await openDB();
      const tx = db.transaction(STORE_NAME, 'readonly');
      const store = tx.objectStore(STORE_NAME);
      return new Promise((resolve) => {
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result.map(r => r.data));
      });
    }

    async function saveChunk(chunk) {
      const db = await openDB();
 (await openDB());
      const tx = db.transaction(STORE_NAME, 'readwrite');
      const store = tx.objectStore(STORE_NAME);
      chunk.forEach(item => store.add({ data: item }));
      return new Promise((resolve) => tx.oncomplete = resolve);
    }

    async function clearDB() {
      const db = await openDB();
      const tx = db.transaction(STORE_NAME, 'readwrite');
      const store = tx.objectStore(STORE_NAME);
      store.clear();
      return new Promise((resolve) => tx.oncomplete = resolve);
    }

    // Virtual Scroller
    class VirtualScroller {
      constructor(container, rowHeight = 128) {
        this.container = container;
        this.rowHeight = rowHeight;
        this.items = [];
        this.visibleCount = Math.ceil(innerHeight / rowHeight) + 20;
        this.render = this.render.bind(this);
        container.addEventListener('scroll', this.render);
        addEventListener('resize', this.render);
      }
      setItems(items) {
        this.items = items;
        this.container.innerHTML = `<div style="height:${items.length * this.rowHeight}px"></div>`;
        this.render();
      }
      render() {
        const scrollTop = this.container.scrollTop;
        const start = Math.max(0, Math.floor(scrollTop / this.rowHeight) - 10);
        const end = Math.min(this.items.length, start + this.visibleCount);
        const fragment = document.createDocumentFragment();
        for (let i = start; i < end; i++) {
          const item = this.items[i];
          if (!item) continue;
          const div = document.createElement('div');
          div.className = 'card';
          div.style.cssText = `position:absolute;top:${i * this.rowHeight}px;width:100%;left:0;right:0;`;
          div.innerHTML = `
            <h3>${item.category || '—'}</h3>
            <p class="question">Q: ${item.pertanyaan || '—'}</p>
            <p class="answer">A: ${item.jawaban || '—'}</p>
          `;
          fragment.appendChild(div);
        }
        const placeholder = this.container.firstChild || document.createElement('div');
        placeholder.style.height = `${this.items.length * this.rowHeight}px`;
        this.container.innerHTML = '';
        this.container.appendChild(placeholder);
        this.container.appendChild(fragment);
      }
    }

    // Main App
    const els = {
      searchInput: document.getElementById('searchInput'),
      clearBtn: document.getElementById('clearBtn'),
      refreshBtn: document.getElementById('refreshBtn'),
      stats: document.getElementById('stats'),
      loading: document.getElementById('loading'),
      error: document.getElementById('error'),
      noResults: document.getElementById('noResults'),
      debug: document.getElementById('debug'),
      virtualList: document.getElementById('virtualList')
    };

    let allData = [], searchEngine = null, scroller = null;

    function highlight(text, term) {
      if (!term) return text;
      const words = term.trim().split(/\s+/);
      let result = text;
      words.forEach(w => {
        const regex = new RegExp(`(${w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        result = result.replace(regex, '<span class="highlight">$1</span>');
      });
      return result;
    }

    function renderResults(results, term = '') {
      els.noResults.style.display = results.length === 0 ? 'block' : 'none';
      if (results.length === 0) return;
      const display = results.map(r => ({
        id: r.id,
        category: highlight(r.category || '—', term),
        pertanyaan: highlight(r.pertanyaan || '—', term),
        jawaban: highlight(r.jawaban || '—', term)
      }));
      if (!scroller) scroller = new VirtualScroller(els.virtualList);
      scroller.setItems(display);
    }

    const debouncedSearch = debounce(() => {
      const term = els.searchInput.value.trim().toLowerCase();
      if (!searchEngine) return;
      if (!term) {
        renderResults(allData);
        els.stats.textContent = `Total: ${allData.length.toLocaleString()} data`;
        return;
      }
      const results = searchEngine.search(term, { fuzzy: 0.2, prefix: true });
      renderResults(results, term);
      els.stats.textContent = `${results.length} hasil ditemukan`;
    }, 300);

    async function fetchAllData(force = false) {
      els.loading.style.display = 'block';
      els.error.style.display = 'none';
      els.debug.textContent = 'Memulai pengunduhan...\n';

      if (!force) {
        try {
          const cached = await getAllData();
          if (cached && cached.length > 0) {
            allData = cached.flat().map((item, index) => ({ ...item, id: index + 1 }));
            initSearch();
            els.loading.style.display = 'none';
            els.stats.textContent = `Dari cache: ${allData.length.toLocaleString()} baris`;
            els.debug.textContent += 'Cache berhasil dimuat!\n';
            return;
          }
        } catch (e) { console.warn('Cache gagal:', e); }
      }

      try {
        await clearDB();
        let page = 1, fetched = 0, globalIndex = 0;

        while (true) {
          const url = `${APPS_SCRIPT_URL}?page=${page}&limit=${PAGE_SIZE}`;
          els.debug.textContent += `→ GET halaman ${page}\n`;

          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const json = await res.json();

          if (!json.success || !Array.isArray(json.data)) {
            throw new Error('Format data salah dari server');
          }

          const chunk = json.data.map(row => ({
            id: ++globalIndex,
            category: String(row.category || row.Category || row.kategori || '').trim(),
            pertanyaan: String(row.pertanyaan || row.Pertanyaan || row.question || '').trim(),
            jawaban: String(row.jawaban || row.Jawaban || row.answer || '').trim()
          })).filter(r => r.category || r.pertanyaan || r.jawaban);

          if (chunk.length === 0) break;

          await saveChunk(chunk.map(c => ({ data: c }))); // simpan dengan wrapper
          fetched += chunk.length;
          els.stats.textContent = `Downloaded: ${fetched.toLocaleString()} baris...`;

          if (json.data.length < PAGE_SIZE) break;
          page++;
          await new Promise(r => setTimeout(r, 150));
        }

        allData = (await getAllData()).flat().map(d => d.data);
        initSearch();
        els.stats.textContent = `SUCCESS! ${allData.length.toLocaleString()} data siap!`;
        els.debug.textContent += `SELESAI! Total: ${allData.length} baris\n`;
      } catch (err) {
        els.error.textContent = 'ERROR: ' + err.message;
        els.error.style.display = 'block';
        els.debug.textContent += 'ERROR: ' + err.message + '\n';
        console.error(err);
      } finally {
        els.loading.style.display = 'none';
      }
    }

    function initSearch() {
      searchEngine = new MiniSearch({
        idField: 'id',
        fields: ['category', 'pertanyaan', 'jawaban'],
        storeFields: ['id', 'category', 'pertanyaan', 'jawaban'],
        searchOptions: { fuzzy: 0.2, prefix: true }
      });
      searchEngine.addAll(allData);
      renderResults(allData);
    }

    function debounce(func, wait) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => func(...args), wait);
      };
    }

    // Events
    els.searchInput.addEventListener('input', () => {
      els.clearBtn.style.display = els.searchInput.value ? 'block' : 'none';
      debouncedSearch();
    });
    els.clearBtn.addEventListener('click', () => {
      els.searchInput.value = '';
      els.clearBtn.style.display = 'none';
      debouncedSearch();
      els.searchInput.focus();
    });
    els.refreshBtn.addEventListener('click', () => {
      if (confirm('Refresh semua data? (bisa lama)')) fetchAllData(true);
    });

    // START
    fetchAllData();
  </script>
</body>
</html>
