<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Database Search with Google Sheets</title>
  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    /* Global box-sizing */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      max-width: 900px;
      margin: 10px auto;
      padding: 10px;
      background-color: #f0f2f5;
      color: #202124;
    }

    h1 {
      margin-bottom: 20px;
      font-weight: 600;
      font-size: 1.75rem;
    }

    .search-container {
      position: sticky;
      top: 0;
      background-color: #f0f2f5;
      padding: 10px 10px 10px 10px;
      z-index: 1000;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      width: 100%;
    }

    .search-wrapper {
      position: relative;
      width: 100%;
      margin-bottom: 12px;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px 40px 10px 12px; /* ruang kiri & kanan */
      font-size: 14px;
      border: 2px solid #dfe1e5;
      border-radius: 8px;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      font-family: inherit;
      max-width: 100%;
    }

    input[type="text"]:focus {
      border-color: #6200ea;
      box-shadow: 0 0 6px rgba(98, 0, 234, 0.25);
    }

    input[type="text"]::placeholder {
      color: #9aa0a6;
    }

    .clear-button {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: #9aa0a6;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .clear-button:hover,
    .clear-button:focus {
      color: #d32f2f;
      background-color: rgba(211, 47, 47, 0.08);
      outline: none;
    }

    .clear-button svg {
      stroke: currentColor;
      stroke-width: 2.5;
      width: 16px;
      height: 16px;
    }

    .refresh-button {
      padding: 8px 16px;
      border-radius: 6px;
      background: #6200ea;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s ease;
      font-family: inherit;
      width: 100%;
      margin-top: 4px;
    }

    @media (min-width: 601px) {
      .refresh-button {
        width: auto;
        margin-top: 0;
      }
    }

    .refresh-button:hover {
      background: #4500a0;
    }

    .refresh-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .card-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .card {
      background-color: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    .card h3 {
      margin: 0 0 10px;
      font-size: 12px;
      color: #5f6368;
      font-weight: 600;
      text-transform: uppercase;
    }

    .card p.question {
      margin: 8px 0;
      font-size: 14px;
      color: #1a73e8;
      font-weight: 500;
    }

    .card p.answer {
      margin: 8px 0;
      font-size: 13px;
      color: #d81b60;
    }

    .highlight {
      background: linear-gradient(90deg, #ffeb3b, #ffd700);
      padding: 1px 4px;
      border-radius: 3px;
      color: #333;
      font-weight: 600;
    }

    .loading {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #6200ea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 2000;
    }

    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .error, .no-results {
      text-align: center;
      margin: 24px 0;
      padding: 12px;
      border-radius: 8px;
      display: none;
      font-weight: 500;
    }

    .error {
      color: #d32f2f;
      background-color: #ffebee;
    }

    .no-results {
      color: #5f6368;
      background-color: #f8f9fa;
    }

    @media (max-width: 600px) {
      body { padding: 8px; margin: 8px; }
      h1 { font-size: 1.5rem; margin-bottom: 16px; }
      input[type="text"] { padding: 9px 36px 9px 10px; font-size: 14px; }
      .refresh-button { font-size: 14px; padding: 8px 14px; }
      .card-container { grid-template-columns: 1fr; gap: 12px; }
      .card { padding: 14px; }
    }
  </style>
</head>
<body>
  <h1>Database Functional Test</h1>
  <div class="search-container">
    <div class="search-wrapper">
      <input
        type="text"
        id="searchInput"
        placeholder="Search by category, question, or answer…"
        aria-label="Search database"
      />
      <button type="button" id="clearButton" class="clear-button" aria-label="Clear search">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <button id="refreshButton" class="refresh-button">Refresh Data</button>
  </div>

  <div class="loading" id="loadingSpinner" aria-live="polite" aria-busy="true"></div>
  <div class="error" id="errorMessage" aria-live="assertive"></div>
  <div class="no-results" id="noResultsMessage" aria-live="polite">No results found.</div>
  <div class="card-container" id="cardContainer"></div>

  <script>
    const STORAGE_KEY = 'sheetData';
    const STORAGE_EXPIRY = 24 * 60 * 60 * 1000; // 24 hours
    const APPS_SCRIPT_URL =
      'https://script.google.com/macros/s/AKfycbzO8vWceVFSdWXGBfIuclWR5mm_1TFSWnw03EYDVC1vCrFfgl78YoS1UAyfP2ebVsdc/exec';

    // DOM Elements
    const searchInput = document.getElementById('searchInput');
    const clearButton = document.getElementById('clearButton');
    const refreshButton = document.getElementById('refreshButton');
    const cardContainer = document.getElementById('cardContainer');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const errorMessage = document.getElementById('errorMessage');
    const noResultsMessage = document.getElementById('noResultsMessage');

    // Utility: escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Utility: escape regex
    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // Highlight per kata
    function highlightText(text, searchTerm) {
      if (!searchTerm || !text) return escapeHtml(text);
      const words = [...new Set(
        searchTerm.trim().toLowerCase().split(/\s+/).filter(w => w.length > 0)
      )];
      if (words.length === 0) return escapeHtml(text);
      let highlighted = escapeHtml(text);
      words
        .sort((a, b) => b.length - a.length)
        .forEach(word => {
          const regex = new RegExp(`(${escapeRegExp(word)})`, 'gi');
          highlighted = highlighted.replace(regex, '<span class="highlight">$1</span>');
        });
      return highlighted;
    }

    // Create card
    function createCard(item, searchTerm) {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <h3>${highlightText(item.category || '—', searchTerm)}</h3>
        <p class="question">Q: ${highlightText(item.pertanyaan || '—', searchTerm)}</p>
        <p class="answer">A: ${highlightText(item.jawaban || '—', searchTerm)}</p>
      `;
      return card;
    }

    // UI Helpers
    function toggleLoading(show) {
      loadingSpinner.style.display = show ? 'block' : 'none';
      refreshButton.disabled = show;
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      noResultsMessage.style.display = 'none';
    }

    function hideMessages() {
      errorMessage.style.display = 'none';
      noResultsMessage.style.display = 'none';
    }

    function showNoResults(show = true) {
      noResultsMessage.style.display = show ? 'block' : 'none';
    }

    // Populate cards with relevance scoring
    function populateCards(data, searchTerm = '') {
      hideMessages();
      cardContainer.innerHTML = '';

      if (!data || data.length === 0) {
        showNoResults(true);
        return;
      }

      const searchWords = searchTerm
        .trim()
        .toLowerCase()
        .split(/\s+/)
        .filter(word => word.length > 0);

      if (searchWords.length === 0) {
        const fragment = document.createDocumentFragment();
        data.forEach((item, index) => {
          const card = createCard(item, '');
          card.style.animationDelay = `${index * 0.03}s`;
          fragment.appendChild(card);
        });
        cardContainer.appendChild(fragment);
        return;
      }

      const scoredItems = data.map(item => {
        const fullText = [
          item.category || '',
          item.pertanyaan || '',
          item.jawaban || ''
        ].join(' ').toLowerCase();
        const matchedWords = searchWords.filter(word => fullText.includes(word));
        return { ...item, _score: matchedWords.length };
      });

      const filtered = scoredItems.filter(item => item._score > 0);
      if (filtered.length === 0) {
        showNoResults(true);
        return;
      }

      filtered.sort((a, b) => {
        if (b._score !== a._score) return b._score - a._score;
        return (a.pertanyaan || '').localeCompare(b.pertanyaan || '');
      });

      showNoResults(false);
      const fragment = document.createDocumentFragment();
      filtered.forEach((item, index) => {
        const { _score, ...cleanItem } = item;
        const card = createCard(cleanItem, searchTerm);
        card.style.animationDelay = `${index * 0.03}s`;
        fragment.appendChild(card);
      });
      cardContainer.appendChild(fragment);
    }

    // Debounce
    const debounce = (func, wait) => {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    };

    // Storage
    function getStoredData() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try {
          const { data, timestamp } = JSON.parse(stored);
          if (Date.now() - timestamp < STORAGE_EXPIRY) {
            return data;
          } else {
            localStorage.removeItem(STORAGE_KEY);
          }
        } catch (e) {
          localStorage.removeItem(STORAGE_KEY);
        }
      }
      return null;
    }

    function storeData(data) {
      try {
        const payload = JSON.stringify({ data, timestamp: Date.now() });
        if (payload.length <= 5 * 1024 * 1024) {
          localStorage.setItem(STORAGE_KEY, payload);
        }
      } catch (e) {
        console.warn('Failed to store data');
      }
    }

    // Fetch data
    async function fetchSheetData() {
      toggleLoading(true);
      hideMessages();

      try {
        const response = await fetch(APPS_SCRIPT_URL, { method: 'GET' });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const result = await response.json();
        if (!result?.success || !Array.isArray(result.data)) throw new Error('Invalid API response');

        const formatted = result.data
          .map(item => ({
            category: String(item.category || '').trim(),
            pertanyaan: String(item.pertanyaan || '').trim(),
            jawaban: String(item.jawaban || '').trim(),
          }))
          .filter(item => item.category || item.pertanyaan || item.jawaban);

        if (formatted.length === 0) throw new Error('No valid data found');

        storeData(formatted);
        populateCards(formatted);
      } catch (error) {
        console.error('Fetch error:', error);
        showError(`Failed to load data: ${error.message}`);
      } finally {
        toggleLoading(false);
      }
    }

    // 🔥 Clear button logic
    function toggleClearButton() {
      clearButton.style.display = searchInput.value.trim() ? 'flex' : 'none';
    }

    const handleSearch = debounce(() => {
      const term = searchInput.value;
      const stored = getStoredData();
      if (stored) {
        populateCards(stored, term);
      }
    }, 300);

    // Event listeners
    searchInput.addEventListener('input', () => {
      toggleClearButton();
      handleSearch();
    });

    searchInput.addEventListener('focus', toggleClearButton);

    clearButton.addEventListener('click', () => {
      searchInput.value = '';
      toggleClearButton();
      handleSearch();
      searchInput.focus();
    });

    refreshButton.addEventListener('click', () => {
      localStorage.removeItem(STORAGE_KEY);
      fetchSheetData();
    });

    // Init
    function init() {
      const cached = getStoredData();
      if (cached && cached.length > 0) {
        populateCards(cached);
      } else {
        fetchSheetData();
      }
    }

    init();
  </script>
</body>
</html>
