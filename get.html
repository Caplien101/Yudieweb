<!DOCTYPE html>
<html>
<head>
    <title>Cari Data Rak di Google Sheets</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        .search-box {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        input, button {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #4285f4;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #357abd;
        }
        .card-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
        }
        .card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .card h5 {
            margin-bottom: 8px;
            font-size: 16px;
        }
        .card p {
            margin-bottom: 4px;
            font-size: 14px;
        }
        .edit-input {
            width: 60px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .save-button {
            background: #28a745;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .save-button:hover {
            background: #218838;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="search-box">
        <h2>Cari Data Berdasarkan Rak</h2>
        <input type="text" id="searchRak" placeholder="Masukkan Rak..." class="form-control">
        <button id="searchButton" class="btn btn-primary mt-2" onclick="searchDataByRak()">
            <span id="loadingSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            Cari
        </button>
       
    </div>

    <!-- Search Box untuk Card View -->
    <div class="mt-3">
        <input type="text" id="cardSearch" placeholder="Cari data di card view..." class="form-control" oninput="filterCards()">
    </div>

    <div id="resultsContainer" class="card-view mt-4"></div>

    <button id="sendDataButton" class="btn btn-success mt-2">Cek Onhand</button>

    <script>
        let currentData = []; // Untuk menyimpan data saat ini

        // Fungsi untuk memuat data dari local storage saat halaman dimuat
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('editedData');
            if (savedData) {
                currentData = JSON.parse(savedData);
                console.log('Data loaded from local storage:', currentData);
                displayResults(currentData); // Tampilkan data dari local storage
            }
        }

        async function searchDataByRak() {
            const searchRak = document.getElementById('searchRak').value.trim();
            
            if (!searchRak) {
                alert('Masukkan nilai Rak terlebih dahulu!');
                return;
            }

            // Bersihkan local storage sebelum memuat data baru
            localStorage.removeItem('editedData');

            // Aktifkan spinner dan nonaktifkan tombol
            const searchButton = document.getElementById('searchButton');
            const loadingSpinner = document.getElementById('loadingSpinner');
            searchButton.disabled = true;
            loadingSpinner.classList.remove('d-none');

            try {
                // Ganti dengan URL Web App yang sudah dipublikasikan
                const webAppUrl = 'https://script.google.com/macros/s/AKfycbyE4355mIoiyUPeY4ZwkeQWiZkhNE4w9YrMilovaNFYtHmuVlkYtQKGNEOsYff3gycG/exec';
                
                // Panggil Web App dengan parameter rak
                const response = await fetch(`${webAppUrl}?rak=${encodeURIComponent(searchRak)}`);
                const data = await response.json();

                // Validasi respons JSON
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                if (!data.data || !Array.isArray(data.data)) {
                    alert('Data tidak ditemukan atau format tidak sesuai.');
                    return;
                }

                // Simpan data ke variabel global
                currentData = data.data;

                // Simpan semua data ke local storage
                localStorage.setItem('editedData', JSON.stringify(currentData));

                // Tampilkan hasil
                displayResults(currentData);
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat mengambil data');
            } finally {
                // Nonaktifkan spinner dan aktifkan kembali tombol
                searchButton.disabled = false;
                loadingSpinner.classList.add('d-none');
            }
        }

        function displayResults(results) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = ''; // Hapus hasil sebelumnya

            if (results.length === 0) {
                container.innerHTML = '<p class="text-center">Data tidak ditemukan</p>';
                return;
            }

            results.forEach((item, index) => {
                const card = `
                    <div class="card" data-plu="${item.plu}" data-desc="${item.desc}">
                        <h5>PLU: ${item.plu}</h5>
                        <p><strong>Deskripsi:</strong> ${item.desc}</p>
                        <p>
                            <strong>Qty:</strong>
                            <input type="number" class="edit-input" value="${item.qty}" oninput="updateLocalStorage(${index}, this.value)">
                        </p>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', card);
            });
        }

        function updateLocalStorage(index, qty) {
            // Pastikan index valid
            if (index >= 0 && index < currentData.length) {
                // Update qty di data lokal
                currentData[index].qty = Number(qty);

                // Simpan semua data ke local storage
                localStorage.setItem('editedData', JSON.stringify(currentData));
                console.log(`Qty untuk indeks ${index} diperbarui di local storage.`);
            }
        }

        // Filter cards berdasarkan input pencarian
        function filterCards() {
            const query = document.getElementById('cardSearch').value.trim().toLowerCase();
            const cards = document.querySelectorAll('#resultsContainer .card');

            cards.forEach(card => {
                const plu = card.getAttribute('data-plu').toLowerCase();
                const desc = card.getAttribute('data-desc').toLowerCase();
                const isVisible = plu.includes(query) || desc.includes(query);
                card.classList.toggle('hidden', !isVisible);
            });
        }

        // Navigasi ke halaman post.html dengan membawa data
        document.getElementById("sendDataButton").addEventListener("click", () => {
            // Simpan data terakhir ke local storage sebelum navigasi
            localStorage.setItem('editedData', JSON.stringify(currentData));

            // Redirect ke halaman post.html
            window.location.href = 'post.html';
        });

        // Muat data dari local storage saat halaman dimuat
        window.onload = loadFromLocalStorage;
    </script>
</body>
</html>
