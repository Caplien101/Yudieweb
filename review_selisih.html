<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step 3: Selisih & Revisi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .animate-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-slate-50 p-4 pb-28 font-sans">
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 z-[100] transition-all duration-300 opacity-0 pointer-events-none">
        <div class="bg-slate-800 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3">
            <span id="toastMsg" class="text-[10px] font-black uppercase"></span>
        </div>
    </div>

    <div class="max-w-2xl mx-auto space-y-4">
        <header class="bg-white p-6 rounded-[2rem] shadow-sm flex justify-between items-end border border-slate-100">
            <div>
                <h1 class="font-black text-slate-800 uppercase tracking-tighter text-2xl leading-none">Review Selisih</h1>
                <p class="text-[9px] font-bold text-indigo-500 uppercase tracking-widest mt-2">Filter Selisih & Data 0</p>
            </div>
            <span id="countItem" class="text-[10px] bg-slate-100 text-slate-600 px-3 py-1 rounded-full font-black uppercase italic">0 Items</span>
        </header>

        <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden">
            <table class="w-full text-left text-[11px]">
                <thead class="bg-slate-900 text-slate-400 font-black uppercase">
                    <tr>
                        <th class="p-4">Item</th>
                        <th class="p-4 text-center">Fisik</th>
                        <th class="p-4 text-center">Sistem</th>
                        <th class="p-4 text-center">Diff</th>
                        <th class="p-4 text-center">Revisi</th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="divide-y divide-slate-50"></tbody>
            </table>
        </div>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100 space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <select id="fShift" class="w-full p-4 bg-slate-50 rounded-2xl font-black text-xs border-none ring-1 ring-slate-100">
                    <option value="1">SHIFT 1</option><option value="2">SHIFT 2</option><option value="3">SHIFT 3</option>
                </select>
                <input type="text" id="fStaff" placeholder="PENYERAH" class="w-full p-4 bg-slate-50 rounded-2xl font-black text-xs ring-1 ring-slate-100 uppercase">
            </div>
            <input type="text" id="fManager" placeholder="PENERIMA" class="w-full p-4 bg-slate-50 rounded-2xl font-black text-xs ring-1 ring-slate-100 uppercase">
        </div>

        <button id="btnFinal" onclick="finalSubmit()" class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-2xl bg-slate-900 text-white py-5 rounded-[2rem] font-black uppercase shadow-2xl tracking-[0.2em] text-[11px] flex items-center justify-center gap-3">
            <i class="fa-solid fa-cloud-arrow-up"></i> Sinkronisasi Final
        </button>
    </div>

    <div id="modalRevisi" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-end justify-center z-50 p-4">
        <div class="bg-white rounded-t-[2.5rem] p-8 w-full max-w-md shadow-2xl animate-up">
            <div class="w-12 h-1 bg-slate-100 rounded-full mx-auto mb-6"></div>
            <h2 id="rTitle" class="text-lg font-black text-slate-800 mb-6 uppercase">Revisi Data</h2>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                        <label class="text-[9px] font-black text-blue-500 uppercase block mb-1">G_Toko</label>
                        <input type="number" id="rGtoko" class="w-full bg-transparent text-2xl font-black text-slate-800 outline-none">
                    </div>
                    <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
                        <label class="text-[9px] font-black text-emerald-500 uppercase block mb-1">Rak</label>
                        <input type="number" id="rRak" class="w-full bg-transparent text-2xl font-black text-slate-800 outline-none">
                    </div>
                </div>
                <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100">
                    <label class="text-[9px] font-black text-indigo-500 uppercase block mb-1">Onhand Sistem</label>
                    <input type="number" id="rSistem" class="w-full bg-transparent text-2xl font-black text-slate-800 outline-none">
                </div>
                <div class="bg-amber-50 p-4 rounded-2xl border-2 border-dashed border-amber-200">
                    <label class="text-[9px] font-black text-amber-600 uppercase block mb-1 uppercase">Alasan Perubahan</label>
                    <textarea id="rAlasan" class="w-full bg-transparent text-xs font-bold text-amber-900 outline-none" rows="2" placeholder="Contoh: Salah hitung di rak A..."></textarea>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button onclick="closeRevisi()" class="flex-1 py-4 text-[10px] font-black text-slate-400 uppercase">Batal</button>
                    <button onclick="saveRevisi()" class="flex-[2] bg-slate-900 text-white py-4 rounded-2xl text-[10px] font-black uppercase shadow-lg">Simpan Revisi</button>
                </div>
            </div>
            <input type="hidden" id="rActiveBc">
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwajGbKT3lhIdu5FjbQlqgtn1VDhw0Us5UYQzBIrqVjHd-_xYlF3ZYxcgnRMi3fknOu_A/exec";

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            toast.classList.replace('opacity-0', 'opacity-100');
            setTimeout(() => toast.classList.replace('opacity-100', 'opacity-0'), 2500);
        }

        function render() {
            const tb = document.getElementById('tableBody'); tb.innerHTML = '';
            const order = JSON.parse(localStorage.getItem('master_order') || "[]");
            let count = 0;

            order.forEach(bc => {
                const d = JSON.parse(localStorage.getItem('stok_' + bc));
                if(!d) return;
                const fisik = (Number(d.g_toko)||0) + (Number(d.rak)||0) + (Number(d.g_titipan)||0);
                const sistem = Number(d.onhand_sistem) || 0;
                const selisih = fisik - sistem;

                if (selisih !== 0 || (fisik === 0 && sistem === 0)) {
                    count++;
                    const color = selisih < 0 ? 'text-red-500' : (selisih > 0 ? 'text-emerald-500' : 'text-slate-300');
                    tb.innerHTML += `
                        <tr class="border-b">
                            <td class="p-4 font-bold text-slate-700">${d.desc}</td>
                            <td class="p-4 text-center font-black">${fisik}</td>
                            <td class="p-4 text-center font-bold text-slate-300">${sistem}</td>
                            <td class="p-4 text-center font-black ${color}">${selisih > 0 ? '+' : ''}${selisih}</td>
                            <td class="p-4 text-center">
                                <button onclick="openRevisi('${d.barcode}')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center mx-auto">
                                    <i class="fa-solid fa-pen text-[10px]"></i>
                                </button>
                            </td>
                        </tr>`;
                }
            });
            document.getElementById('countItem').innerText = count + " Items";
        }

        function openRevisi(bc) {
            const d = JSON.parse(localStorage.getItem('stok_' + bc));
            document.getElementById('rActiveBc').value = bc;
            document.getElementById('rTitle').innerText = d.desc;
            document.getElementById('rGtoko').value = d.g_toko || 0;
            document.getElementById('rRak').value = d.rak || 0;
            document.getElementById('rSistem').value = d.onhand_sistem || 0;
            document.getElementById('rAlasan').value = "";
            document.getElementById('modalRevisi').classList.remove('hidden');
        }

        function closeRevisi() { document.getElementById('modalRevisi').classList.add('hidden'); }

        function saveRevisi() {
            const bc = document.getElementById('rActiveBc').value;
            const alasan = document.getElementById('rAlasan').value;
            if(!alasan) return showToast("ALASAN WAJIB DIISI!");

            const d = JSON.parse(localStorage.getItem('stok_' + bc));
            // Log perubahan untuk Audit Trail
            const logs = JSON.parse(localStorage.getItem('audit_logs') || "[]");
            logs.push({
                time: new Date().toLocaleTimeString(),
                item: d.desc,
                note: alasan,
                fisik_val: Number(document.getElementById('rGtoko').value) + Number(document.getElementById('rRak').value) + (d.g_titipan||0),
                sistem_val: Number(document.getElementById('rSistem').value)
            });
            localStorage.setItem('audit_logs', JSON.stringify(logs));

            // Simpan data baru
            d.g_toko = Number(document.getElementById('rGtoko').value);
            d.rak = Number(document.getElementById('rRak').value);
            d.onhand_sistem = Number(document.getElementById('rSistem').value);
            localStorage.setItem('stok_' + bc, JSON.stringify(d));
            
            closeRevisi();
            render();
            showToast("DATA BERHASIL DIREVISI");
        }

        async function finalSubmit() {
            const btn = document.getElementById('btnFinal');
            if(!document.getElementById('fStaff').value || !document.getElementById('fManager').value) return showToast("LENGKAPI DATA!");
            
            btn.innerHTML = '<div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> SINKRONISASI...';
            btn.disabled = true;

            const payload = [];
            const order = JSON.parse(localStorage.getItem('master_order') || "[]");
            order.forEach(bc => {
                const d = JSON.parse(localStorage.getItem('stok_'+bc));
                d.shift = document.getElementById('fShift').value;
                d.penyerah = document.getElementById('fStaff').value;
                d.penerima = document.getElementById('fManager').value;
                payload.push(d);
            });

            try {
                await fetch(GAS_URL, { 
                    method:"POST", 
                    body: JSON.stringify({ action: "FINAL_SUBMIT", payload, logs: JSON.parse(localStorage.getItem('audit_logs')||"[]") })
                });
                showToast("SINKRONISASI BERHASIL!");
                localStorage.clear();
                setTimeout(() => window.location.href='entry_data.html', 2000);
            } catch(e) { showToast("GAGAL!"); btn.disabled = false; }
        }

        render();
    </script>
</body>
</html>
