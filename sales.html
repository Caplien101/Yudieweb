<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data Google Sheets</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Google Fonts - Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      padding: 20px;
      font-family: "Poppins", sans-serif;
    }
    .chart-container {
      margin-top: 20px;
    }
    /* CSS untuk tabel */
    .table-container table td {
      font-size: 13px; /* Ukuran font default untuk sel tabel */
    }
    /* CSS untuk header tabel */
    .table-container thead th {
      font-size: 14px; /* Ukuran font untuk header */
    }
    /* CSS untuk footer tabel */
    tfoot th,
    tfoot td {
      font-size: 13px; /* Ukuran font untuk footer */
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center">Report Sales 2025 [C940]</h1>
    <!-- Dropdown Bulan -->
    <div class="month-dropdown mb-4">
      <label for="month-select" class="form-label">Pilih Bulan:</label>
      <select id="month-select" class="form-select">
        <!-- Opsi bulan akan dimuat di sini secara dinamis -->
      </select>
    </div>
    <!-- Tabel Data -->
    <div class="table-container">
      <table class="table table-striped table-bordered">
        <thead class="table-dark">
          <tr>
            <th>TANGGAL</th>
            <th>TARGET</th>
            <th>ACTUAL</th>
            <th>%</th>
            <th>GAP</th> <!-- Kolom GAP -->
            <th>STD</th>
          </tr>
        </thead>
        <tbody id="data-table-body">
          <!-- Data akan dimuat di sini -->
        </tbody>
        <tfoot>
          <tr>
            <th colspan="6">Net Sales</th> <!-- Ubah colspan menjadi 6 -->
          </tr>
          <tr>
            <th></th>
            <th id="net-sales-target"></th>
            <th id="net-sales-actual"></th>
            <th id="net-sales-percentage"></th>
            <th id="net-sales-gap"></th> <!-- Footer untuk GAP -->
            <th id="net-sales-std"></th>
          </tr>
          <tr>
            <th colspan="6">Average</th> <!-- Ubah colspan menjadi 6 -->
          </tr>
          <tr>
            <th></th>
            <th id="average-target"></th>
            <th id="average-actual"></th>
            <th id="average-percentage"></th>
            <th id="average-gap"></th> <!-- Footer untuk GAP -->
            <th id="average-std"></th>
          </tr>
        </tfoot>
      </table>
    </div>
    <!-- Grafik Rata-Rata ACTUAL -->
    <div class="chart-container">
      <canvas id="averageActualChart"></canvas>
    </div>
    <!-- Grafik Rata-Rata STD -->
    <div class="chart-container">
      <canvas id="averageStdChart"></canvas>
    </div>
  </div>
  <!-- Bootstrap JS and dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // URL Web App Google Apps Script
    const googleSheetUrl =
      "https://script.google.com/macros/s/AKfycbwW3U_8jWbubdENCQ-NbrKZv1wVvZ76n4tO_rV7TYxVbJSfEwS1x-PqL13SPpxtG0Ib/exec";
    // Variabel global untuk menyimpan data JSON
    let allData = [];
    let groupedData = {};

    // Fungsi untuk memuat data dari Google Sheets
    async function fetchData() {
      try {
        const response = await fetch(googleSheetUrl);
        if (!response.ok) {
          throw new Error("Failed to fetch data");
        }
        allData = await response.json();
        // Kelompokkan data berdasarkan bulan
        groupedData = groupDataByMonth(allData);
        // Isi dropdown bulan
        populateMonthDropdown(Object.keys(groupedData));
        // Hitung rata-rata ACTUAL dan STD setiap bulan
        const monthlyAverages = calculateMonthlyAverages(groupedData);
        // Gambar grafik
        drawCharts(monthlyAverages);
        // Tampilkan data untuk bulan pertama secara default
        const firstMonth = Object.keys(groupedData)[0];
        displayDataForMonth(firstMonth);
      } catch (error) {
        console.error("Error fetching data:", error);
        alert("Gagal memuat data. Silakan coba lagi nanti.");
      }
    }

    // Fungsi untuk mengelompokkan data berdasarkan bulan
    function groupDataByMonth(data) {
      const grouped = {};
      data.forEach((row) => {
        const dateParts = row.TANGGAL.split("-");
        const year = dateParts[0];
        const month = dateParts[1];
        const monthKey = `${year}-${month}`; // Format YYYY-MM
        if (!grouped[monthKey]) {
          grouped[monthKey] = [];
        }
        grouped[monthKey].push(row);
      });
      return grouped;
    }

    // Fungsi untuk mengisi dropdown bulan
    function populateMonthDropdown(monthKeys) {
      const selectElement = document.getElementById("month-select");
      selectElement.innerHTML = ""; // Kosongkan dropdown sebelum memuat opsi baru
      monthKeys.forEach((monthKey) => {
        const option = document.createElement("option");
        option.value = monthKey;
        option.textContent = formatMonth(monthKey);
        selectElement.appendChild(option);
      });
      // Tambahkan event listener untuk dropdown
      selectElement.addEventListener("change", (event) => {
        const selectedMonth = event.target.value;
        displayDataForMonth(selectedMonth);
      });
    }

    // Fungsi untuk menampilkan data untuk bulan tertentu
    function displayDataForMonth(monthKey) {
      const rows = groupedData[monthKey];
      const tableBody = document.getElementById("data-table-body");
      tableBody.innerHTML = ""; // Kosongkan tabel sebelum memuat data baru

      // Filter data: Hanya baris dengan ACTUAL dan STD tidak kosong
      const filteredRows = rows.filter((row) => row.ACTUAL && row.STD);

      // Variabel untuk perhitungan total
      let totalTarget = 0; // Total SPD TARGET untuk semua baris
      let totalActual = 0; // Total ACTUAL untuk baris dengan nilai tidak kosong
      let totalStd = 0;    // Total STD untuk baris dengan nilai tidak kosong
      let totalGap = 0;    // Total GAP untuk baris dengan nilai tidak kosong

      // Proses semua baris untuk ditampilkan di tabel
      rows.forEach((row) => {
        const tr = document.createElement("tr");

        // TANGGAL
        const tanggalCell = document.createElement("td");
        tanggalCell.textContent = row.TANGGAL || "-";
        tr.appendChild(tanggalCell);

        // SPD TARGET
        const spdTargetCell = document.createElement("td");
        const spdTargetValue = row["  SPD TARGET"];
        spdTargetCell.textContent = spdTargetValue ? spdTargetValue.toLocaleString() : "-";
        tr.appendChild(spdTargetCell);

        // ACTUAL
        const actualCell = document.createElement("td");
        const actualValue = row.ACTUAL;
        actualCell.textContent = actualValue ? actualValue.toLocaleString() : "-";
        tr.appendChild(actualCell);

        // %
        const percentageCell = document.createElement("td");
        const percentageValue =
          spdTargetValue && actualValue ? ((actualValue / spdTargetValue) * 100).toFixed(2) : "-";
        percentageCell.textContent = percentageValue !== "-" ? `${percentageValue}%` : "-";
        if (percentageValue !== "-") {
          percentageCell.style.color = parseFloat(percentageValue) >= 100 ? "green" : "red";
        }
        tr.appendChild(percentageCell);

        // GAP
        const gapCell = document.createElement("td");
        const gapValue = actualValue && spdTargetValue ? actualValue - spdTargetValue : null;
        gapCell.textContent = gapValue !== null ? gapValue.toLocaleString() : "-";
        if (gapValue !== null) {
          gapCell.style.color = gapValue > 0 ? "green" : gapValue < 0 ? "red" : "black";
        }
        tr.appendChild(gapCell);

        // STD
        const stdCell = document.createElement("td");
        const stdValue = row.STD;
        stdCell.textContent = stdValue !== null ? stdValue : "-";
        tr.appendChild(stdCell);

        // Tambahkan nilai ke total
        totalTarget += spdTargetValue || 0;
        if (filteredRows.includes(row)) {
          totalActual += actualValue || 0;
          totalStd += stdValue || 0;
          totalGap += gapValue || 0; // Tambahkan GAP jika ada
        }

        tableBody.appendChild(tr);
      });

      // Hitung NET SALES
      const netSalesPercentage =
        totalTarget > 0 ? ((totalActual / totalTarget) * 100).toFixed(2) : "-";

      // Hitung AVERAGE
      const averageTarget = rows.length > 0 ? (totalTarget / rows.length).toFixed(0) : "-";
      const averageActual =
        filteredRows.length > 0 ? (totalActual / filteredRows.length).toFixed(0) : "-";
      const averagePercentage =
        averageTarget > 0 ? ((averageActual / averageTarget) * 100).toFixed(2) : "-";
      const averageStd =
        filteredRows.length > 0 ? (totalStd / filteredRows.length).toFixed(0) : "-";
      const averageGap =
        filteredRows.length > 0 ? (totalGap / filteredRows.length).toFixed(0) : "-";

      // Format angka dengan pemisah ribuan
      const formatNumber = (num) =>
        num !== "-" ? parseInt(num).toLocaleString("id-ID") : "-";

      // Update footer
      document.getElementById("net-sales-target").textContent = formatNumber(totalTarget);
      document.getElementById("net-sales-actual").textContent = formatNumber(totalActual);
      document.getElementById("net-sales-gap").textContent = formatNumber(totalGap); // Footer GAP
      document.getElementById("net-sales-gap").style.color =
        totalGap > 0 ? "green" : totalGap < 0 ? "red" : "black"; // Warna GAP
      document.getElementById("net-sales-std").textContent = formatNumber(totalStd);

      document.getElementById("average-target").textContent = formatNumber(averageTarget);
      document.getElementById("average-actual").textContent = formatNumber(averageActual);
      document.getElementById("average-gap").textContent = formatNumber(averageGap); // Footer GAP
      document.getElementById("average-gap").style.color =
        averageGap > 0 ? "green" : averageGap < 0 ? "red" : "black"; // Warna GAP
      document.getElementById("average-std").textContent = formatNumber(averageStd);

      // Warna untuk NET SALES Percentage
      const netSalesPercentageCell = document.getElementById("net-sales-percentage");
      netSalesPercentageCell.textContent =
        netSalesPercentage !== "-" ? `${netSalesPercentage}%` : "-";
      if (netSalesPercentage !== "-") {
        netSalesPercentageCell.style.color =
          parseFloat(netSalesPercentage) >= 100 ? "green" : "red";
      }

      // Warna untuk AVERAGE Percentage
      const averagePercentageCell = document.getElementById("average-percentage");
      averagePercentageCell.textContent =
        averagePercentage !== "-" ? `${averagePercentage}%` : "-";
      if (averagePercentage !== "-") {
        averagePercentageCell.style.color =
          parseFloat(averagePercentage) >= 100 ? "green" : "red";
      }
    }

    // Fungsi untuk memformat nama bulan dari YYYY-MM
    function formatMonth(monthKey) {
      const [year, month] = monthKey.split("-");
      const monthNames = [
        "Januari",
        "Februari",
        "Maret",
        "April",
        "Mei",
        "Juni",
        "Juli",
        "Agustus",
        "September",
        "Oktober",
        "November",
        "Desember",
      ];
      return `${monthNames[parseInt(month) - 1]} ${year}`;
    }

    // Fungsi untuk menghitung rata-rata ACTUAL dan STD setiap bulan
    function calculateMonthlyAverages(groupedData) {
      const monthlyAverages = {
        months: [],
        averageActuals: [],
        averageStds: [],
      };
      Object.keys(groupedData).forEach((monthKey) => {
        const rows = groupedData[monthKey];
        const filteredRows = rows.filter((row) => row.ACTUAL && row.STD);

        // Hitung rata-rata ACTUAL
        const totalActual = filteredRows.reduce((sum, row) => sum + (row.ACTUAL || 0), 0);
        const averageActual = filteredRows.length > 0 ? totalActual / filteredRows.length : 0;

        // Hitung rata-rata STD
        const totalStd = filteredRows.reduce((sum, row) => sum + (row.STD || 0), 0);
        const averageStd = filteredRows.length > 0 ? totalStd / filteredRows.length : 0;

        // Simpan hasil
        monthlyAverages.months.push(formatMonth(monthKey));
        monthlyAverages.averageActuals.push(averageActual.toFixed(2));
        monthlyAverages.averageStds.push(averageStd.toFixed(2));
      });
      return monthlyAverages;
    }

    // Fungsi untuk menggambar grafik
    function drawCharts(monthlyAverages) {
      // Grafik rata-rata ACTUAL
      const averageActualCtx = document.getElementById("averageActualChart").getContext("2d");
      new Chart(averageActualCtx, {
        type: "bar",
        data: {
          labels: monthlyAverages.months,
          datasets: [
            {
              label: "SPD 2025",
              data: monthlyAverages.averageActuals.map(Number),
              backgroundColor: "rgba(75, 192, 192, 0.6)",
              borderColor: "rgba(75, 192, 192, 1)",
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "top" },
            title: { display: true, text: "Average SPD C940" },
          },
          scales: {
            y: { beginAtZero: true },
          },
        },
      });

      // Grafik rata-rata STD
      const averageStdCtx = document.getElementById("averageStdChart").getContext("2d");
      new Chart(averageStdCtx, {
        type: "line",
        data: {
          labels: monthlyAverages.months,
          datasets: [
            {
              label: "STD 2025",
              data: monthlyAverages.averageStds.map(Number),
              borderColor: "rgba(255, 99, 132, 1)",
              backgroundColor: "rgba(255, 99, 132, 0.2)",
              borderWidth: 2,
              fill: true,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "top" },
            title: { display: true, text: "Average STD C940" },
          },
          scales: {
            y: { beginAtZero: true },
          },
        },
      });
    }

    // Panggil fungsi fetchData saat halaman dimuat
    document.addEventListener("DOMContentLoaded", fetchData);
  </script>
</body>
</html>
