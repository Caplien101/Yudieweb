<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Report Bulanan</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Google Fonts - Poppins -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        padding: 20px;
        font-family: "Poppins", sans-serif;
      }
      table td,
      table th {
        font-size: 14px;
      }
      tfoot th,
      tfoot td {
        font-weight: bold;
      }

      /* Gaya untuk badges */
      .custom-badge {
        font-size: 0.7rem; /* Ukuran font lebih kecil */
        padding: 0.2rem 0.4rem; /* Padding lebih kecil */
        margin-left: 0.2rem; /* Margin kecil antara badges */
        border-radius: 5px; /* Sudut melengkung lebih halus */
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="text-center">Report Bulanan Sales 2025 [C940]</h1>
      <!-- Tabel Data -->
      <div class="table-container">
        <table class="table table-striped table-bordered">
          <thead class="table-dark">
            <tr>
              <th>BULAN</th>
              <th>SPD TARGET</th>
              <th>ACTUAL</th>
              <th>%</th>
              <th>GAP</th>
              <th>STD</th>
            </tr>
          </thead>
          <tbody id="monthly-data-table-body">
            <!-- Data akan dimuat di sini -->
          </tbody>
          <tfoot>
            <tr>
              <th>Total</th>
              <th id="total-target"></th>
              <th id="total-actual"></th>
              <th id="total-percentage"></th>
              <th id="total-gap"></th>
              <th id="total-std"></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // URL Web App Google Apps Script
      const googleSheetUrl =
        "https://script.google.com/macros/s/AKfycbwW3U_8jWbubdENCQ-NbrKZv1wVvZ76n4tO_rV7TYxVbJSfEwS1x-PqL13SPpxtG0Ib/exec";

      // Variabel global untuk menyimpan data JSON
      let allData = [];
      let groupedData = {};

      // Fungsi untuk memuat data dari Google Sheets
      async function fetchData() {
        try {
          const response = await fetch(googleSheetUrl);
          if (!response.ok) {
            throw new Error("Failed to fetch data");
          }
          allData = await response.json();
          // Kelompokkan data berdasarkan bulan
          groupedData = groupDataByMonth(allData);
          // Tampilkan data bulanan
          displayMonthlyData();
        } catch (error) {
          console.error("Error fetching data:", error);
          alert("Gagal memuat data. Silakan coba lagi nanti.");
        }
      }

      // Fungsi untuk mengelompokkan data berdasarkan bulan
      function groupDataByMonth(data) {
        const grouped = {};
        data.forEach((row) => {
          const dateParts = row.TANGGAL.split("-");
          const year = dateParts[0];
          const month = dateParts[1];
          const monthKey = `${year}-${month}`; // Format YYYY-MM
          if (!grouped[monthKey]) {
            grouped[monthKey] = [];
          }
          grouped[monthKey].push(row);
        });
        return grouped;
      }

      function displayMonthlyData() {
        const tableBody = document.getElementById("monthly-data-table-body");
        tableBody.innerHTML = ""; // Kosongkan tabel sebelum memuat data baru

        // Variabel untuk total keseluruhan
        let totalTarget = 0;
        let totalActual = 0;
        let totalStd = 0;
        let totalGap = 0;

        // Data bulan sebelumnya untuk menghitung growth
        let previousMonthActual = null;
        let previousMonthStd = null;

        // Proses setiap bulan
        Object.keys(groupedData).forEach((monthKey, index) => {
          const rows = groupedData[monthKey];
          const filteredRows = rows.filter((row) => row.ACTUAL && row.STD);

          // Hitung total per bulan
          const monthlyTarget = rows.reduce(
            (sum, row) => sum + (row["  SPD TARGET"] || 0),
            0
          );
          const monthlyActual = filteredRows.reduce(
            (sum, row) => sum + (row.ACTUAL || 0),
            0
          );
          const monthlyStd = filteredRows.reduce(
            (sum, row) => sum + (row.STD || 0),
            0
          );
          const monthlyGap = monthlyActual - monthlyTarget;

          // Tambahkan ke total keseluruhan
          totalTarget += monthlyTarget;
          totalActual += monthlyActual;
          totalStd += monthlyStd;
          totalGap += monthlyGap;

          // Hitung persentase
          const percentage =
            monthlyTarget > 0
              ? ((monthlyActual / monthlyTarget) * 100).toFixed(2)
              : "-";

          // Format angka
          const formatNumber = (num) =>
            num !== "-" ? parseInt(num).toLocaleString("id-ID") : "-";

          // Buat baris tabel
          const tr = document.createElement("tr");

          // BULAN
          const monthCell = document.createElement("td");
          monthCell.textContent = formatMonth(monthKey);
          tr.appendChild(monthCell);

          // SPD TARGET
          const targetCell = document.createElement("td");
          targetCell.textContent = formatNumber(monthlyTarget);
          tr.appendChild(targetCell);

          // ACTUAL
          const actualCell = document.createElement("td");
          actualCell.textContent = formatNumber(monthlyActual);

          // Growth untuk ACTUAL
          if (previousMonthActual !== null) {
            const actualGrowth = monthlyActual - previousMonthActual;
            const actualGrowthPercentage = (
              (actualGrowth / previousMonthActual) *
              100
            ).toFixed(2);

            // Badge untuk nilai absolut
            const badgeAbsolute = document.createElement("span");
            badgeAbsolute.className = `badge ${
              actualGrowth >= 0 ? "bg-success" : "bg-danger"
            } fs-7 ms-2 custom-badge`;
            badgeAbsolute.textContent = `${
              actualGrowth >= 0 ? "+" : ""
            }${formatNumber(actualGrowth)}`;

            // Badge untuk persentase
            const badgePercentage = document.createElement("span");
            badgePercentage.className = `badge ${
              actualGrowth >= 0 ? "bg-success" : "bg-danger"
            } fs-7 ms-2 custom-badge`;
            badgePercentage.textContent = `(${actualGrowthPercentage}%)`;

            // Tambahkan badges ke sel
            actualCell.appendChild(badgeAbsolute);
            actualCell.appendChild(badgePercentage);
          }

          tr.appendChild(actualCell);

          // %
          const percentageCell = document.createElement("td");
          percentageCell.textContent =
            percentage !== "-" ? `${percentage}%` : "-";
          if (percentage !== "-") {
            percentageCell.style.color =
              parseFloat(percentage) >= 100 ? "green" : "red";
          }
          tr.appendChild(percentageCell);

          // GAP
          const gapCell = document.createElement("td");
          gapCell.textContent = formatNumber(monthlyGap);
          if (monthlyGap > 0) {
            gapCell.style.color = "green";
          } else if (monthlyGap < 0) {
            gapCell.style.color = "red";
          }
          tr.appendChild(gapCell);

          // STD
          const stdCell = document.createElement("td");
          stdCell.textContent = formatNumber(monthlyStd);

          // Growth untuk STD
          if (previousMonthStd !== null) {
            const stdGrowth = monthlyStd - previousMonthStd;
            const stdGrowthPercentage = (
              (stdGrowth / previousMonthStd) *
              100
            ).toFixed(2);

            // Badge untuk nilai absolut
            const badgeAbsolute = document.createElement("span");
            badgeAbsolute.className = `badge ${
              stdGrowth >= 0 ? "bg-success" : "bg-danger"
            } fs-7 ms-2 custom-badge`;
            badgeAbsolute.textContent = `${
              stdGrowth >= 0 ? "+" : ""
            }${formatNumber(stdGrowth)}`;

            // Badge untuk persentase
            const badgePercentage = document.createElement("span");
            badgePercentage.className = `badge ${
              stdGrowth >= 0 ? "bg-success" : "bg-danger"
            } fs-7 ms-2 custom-badge`;
            badgePercentage.textContent = `(${stdGrowthPercentage}%)`;

            // Tambahkan badges ke sel
            stdCell.appendChild(badgeAbsolute);
            stdCell.appendChild(badgePercentage);
          }

          tr.appendChild(stdCell);

          // Tambahkan baris ke tabel
          tableBody.appendChild(tr);

          // Simpan nilai bulan ini untuk digunakan sebagai bulan sebelumnya di iterasi berikutnya
          previousMonthActual = monthlyActual;
          previousMonthStd = monthlyStd;
        });

        // Update footer dengan total keseluruhan
        document.getElementById("total-target").textContent =
          totalTarget.toLocaleString("id-ID");
        document.getElementById("total-actual").textContent =
          totalActual.toLocaleString("id-ID");
        const totalPercentage =
          totalTarget > 0
            ? ((totalActual / totalTarget) * 100).toFixed(2)
            : "-";
        document.getElementById("total-percentage").textContent =
          totalPercentage !== "-" ? `${totalPercentage}%` : "-";
        document.getElementById("total-gap").textContent =
          totalGap.toLocaleString("id-ID");
        document.getElementById("total-std").textContent =
          totalStd.toLocaleString("id-ID");
      }

      // Fungsi untuk memformat nama bulan dari YYYY-MM
      function formatMonth(monthKey) {
        const [year, month] = monthKey.split("-");
        const monthNames = [
          "Januari",
          "Februari",
          "Maret",
          "April",
          "Mei",
          "Juni",
          "Juli",
          "Agustus",
          "September",
          "Oktober",
          "November",
          "Desember",
        ];
        return `${monthNames[parseInt(month) - 1]} ${year}`;
      }

      // Panggil fungsi fetchData saat halaman dimuat
      document.addEventListener("DOMContentLoaded", fetchData);
    </script>
  </body>
</html>
