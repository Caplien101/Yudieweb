<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Report Bulanan</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Google Fonts - Poppins -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
        body {
          padding: 20px;
          font-family: "Poppins", sans-serif;
        }
        table td,
        table th {
          font-size: 15px;
          padding: 8px 12px;
        }
        tfoot th,
        tfoot td {
          font-weight: bold;
        }
      
        /* Right alignment for all cells except first column */
        table td:not(:first-child),
        table th:not(:first-child),
        table tfoot th:not(:first-child),
        table tfoot td:not(:first-child) {
          text-align: right;
        }
      
        /* Badge styles */
        .badge-container {
          display: flex;
          flex-direction: column;
          gap: 4px;
          margin-top: 4px;
          align-items: flex-end; /* Rata kanan badge container */
        }
      
        .badge {
          display: inline-block;
          font-size: 0.7rem;
          padding: 0.2rem 0.4rem;
          border-radius: 5px;
        }
      
        @media (max-width: 768px) {
          .badge {
            font-size: 0.7rem;
            padding: 0.1rem 0.2rem;
          }
          table td, table th {
            font-size: 13px;
            padding: 0.3rem;
          }
        }

        @media (max-width: 768px) {
  table {
    min-width: 100%;
    display: block;
    white-space: normal; /* Mengizinkan wrap konten */
  }
  
  table td, table th {
    /*white-space: normal; /* Konten bisa wrap */
    font-size: 0.7rem;
    /*word-break: break-word; /* Memastikan kata panjang bisa dipotong */
  }
}
      </style>

      
  </head>
  <body>
    <div class="container">
      <h1 class="text-center">Sales Year To Date 2025 (C940)</h1>
      <!-- Tabel Data -->
      <div class="table-container ">
        <table class="table table-striped table-bordered">
          <thead class="table-dark">
            <tr>
              <th>BULAN</th>
              <th>SPD TARGET</th>
              <th>ACTUAL</th>
              <th>%</th>
              <th>GAP</th>
              <th>STD</th>
            </tr>
          </thead>
          <tbody id="monthly-data-table-body">
            <!-- Data akan dimuat di sini -->
          </tbody>
          <tfoot>
            <tr>
              <th>Total</th>
              <th id="total-target"></th>
              <th id="total-actual"></th>
              <th id="total-percentage"></th>
              <th id="total-gap"></th>
              <th id="total-std"></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // URL Web App Google Apps Script
      const googleSheetUrl =
        "https://script.google.com/macros/s/AKfycbwW3U_8jWbubdENCQ-NbrKZv1wVvZ76n4tO_rV7TYxVbJSfEwS1x-PqL13SPpxtG0Ib/exec";

      // Variabel global untuk menyimpan data JSON
      let allData = [];
      let groupedData = {};

      // Fungsi untuk memuat data dari Google Sheets
      async function fetchData() {
        try {
          const response = await fetch(googleSheetUrl);
          if (!response.ok) {
            throw new Error("Failed to fetch data");
          }
          allData = await response.json();
          // Kelompokkan data berdasarkan bulan
          groupedData = groupDataByMonth(allData);
          // Tampilkan data bulanan
          displayMonthlyData();
        } catch (error) {
          console.error("Error fetching data:", error);
          alert("Gagal memuat data. Silakan coba lagi nanti.");
        }
      }

      // Fungsi untuk mengelompokkan data berdasarkan bulan
      function groupDataByMonth(data) {
        const grouped = {};
        data.forEach((row) => {
          const dateParts = row.TANGGAL.split("-");
          const year = dateParts[0];
          const month = dateParts[1];
          const monthKey = `${year}-${month}`; // Format YYYY-MM
          if (!grouped[monthKey]) {
            grouped[monthKey] = [];
          }
          grouped[monthKey].push(row);
        });
        return grouped;
      }

      function displayMonthlyData() {
  const tableBody = document.getElementById("monthly-data-table-body");
  tableBody.innerHTML = "";

  let totalTarget = 0;
  let totalActual = 0;
  let totalStd = 0;
  let totalGap = 0;

  let previousMonthActual = null;
  let previousMonthStd = null;

  Object.keys(groupedData).forEach((monthKey, index) => {
    const rows = groupedData[monthKey];
    const filteredRows = rows.filter((row) => row.ACTUAL && row.STD);

    const monthlyTarget = rows.reduce((sum, row) => sum + (row["  SPD TARGET"] || 0), 0);
    const monthlyActual = filteredRows.reduce((sum, row) => sum + (row.ACTUAL || 0), 0);
    const monthlyStd = filteredRows.reduce((sum, row) => sum + (row.STD || 0), 0);
    const monthlyGap = monthlyActual - monthlyTarget;

    totalTarget += monthlyTarget;
    totalActual += monthlyActual;
    totalStd += monthlyStd;
    totalGap += monthlyGap;

    const percentage = monthlyTarget > 0 ? ((monthlyActual / monthlyTarget) * 100).toFixed(2) : "-";
    const formatNumber = (num) => num !== "-" ? parseInt(num).toLocaleString("id-ID") : "-";

    const tr = document.createElement("tr");

    // BULAN
    const monthCell = document.createElement("td");
    monthCell.textContent = formatMonth(monthKey);
    tr.appendChild(monthCell);

    // SPD TARGET
    const targetCell = document.createElement("td");
    targetCell.textContent = formatNumber(monthlyTarget);
    tr.appendChild(targetCell);

    // ACTUAL
    const actualCell = document.createElement("td");
    const actualMainDiv = document.createElement("div");
    actualMainDiv.textContent = formatNumber(monthlyActual);

    const actualBadgeContainer = document.createElement("div");
    actualBadgeContainer.className = "badge-container";

    if (previousMonthActual !== null) {
      const actualGrowth = monthlyActual - previousMonthActual;
      const actualGrowthPercentage = ((actualGrowth / previousMonthActual) * 100).toFixed(2);

      const badgeAbsolute = document.createElement("span");
      badgeAbsolute.className = `badge ${actualGrowth >= 0 ? "bg-success" : "bg-danger"}`;
      badgeAbsolute.textContent = `${actualGrowth >= 0 ? "+" : ""}${formatBadgeNumber(actualGrowth)}`;

      const badgePercentage = document.createElement("span");
      badgePercentage.className = `badge ${actualGrowth >= 0 ? "bg-success" : "bg-danger"}`;
      badgePercentage.textContent = `(${actualGrowthPercentage}%)`;

      actualBadgeContainer.appendChild(badgeAbsolute);
      actualBadgeContainer.appendChild(badgePercentage);
    }

    actualCell.appendChild(actualMainDiv);
    actualCell.appendChild(actualBadgeContainer);
    tr.appendChild(actualCell);

    // %
    const percentageCell = document.createElement("td");
    percentageCell.textContent = percentage !== "-" ? `${percentage}%` : "-";
    if (percentage !== "-") {
      percentageCell.style.color = parseFloat(percentage) >= 100 ? "green" : "red";
    }
    tr.appendChild(percentageCell);

    // GAP
    const gapCell = document.createElement("td");
    gapCell.textContent = formatNumber(monthlyGap);
    if (monthlyGap > 0) {
      gapCell.style.color = "green";
    } else if (monthlyGap < 0) {
      gapCell.style.color = "red";
    }
    tr.appendChild(gapCell);

    // STD
    const stdCell = document.createElement("td");
    const stdMainDiv = document.createElement("div");
    stdMainDiv.textContent = formatNumber(monthlyStd);

    const stdBadgeContainer = document.createElement("div");
    stdBadgeContainer.className = "badge-container";

    if (previousMonthStd !== null) {
      const stdGrowth = monthlyStd - previousMonthStd;
      const stdGrowthPercentage = ((stdGrowth / previousMonthStd) * 100).toFixed(2);

      const badgeAbsolute = document.createElement("span");
      badgeAbsolute.className = `badge ${stdGrowth >= 0 ? "bg-success" : "bg-danger"}`;
      badgeAbsolute.textContent = `${stdGrowth >= 0 ? "+" : ""}${formatBadgeNumber(stdGrowth)}`;

      const badgePercentage = document.createElement("span");
      badgePercentage.className = `badge ${stdGrowth >= 0 ? "bg-success" : "bg-danger"}`;
      badgePercentage.textContent = `(${stdGrowthPercentage}%)`;

      stdBadgeContainer.appendChild(badgeAbsolute);
      stdBadgeContainer.appendChild(badgePercentage);
    }

    stdCell.appendChild(stdMainDiv);
    stdCell.appendChild(stdBadgeContainer);
    tr.appendChild(stdCell);

    tableBody.appendChild(tr);

    previousMonthActual = monthlyActual;
    previousMonthStd = monthlyStd;
  });

  document.getElementById("total-target").textContent = totalTarget.toLocaleString("id-ID");
  document.getElementById("total-actual").textContent = totalActual.toLocaleString("id-ID");
  const totalPercentage = totalTarget > 0 ? ((totalActual / totalTarget) * 100).toFixed(2) : "-";
  document.getElementById("total-percentage").textContent = totalPercentage !== "-" ? `${totalPercentage}%` : "-";
  document.getElementById("total-gap").textContent = totalGap.toLocaleString("id-ID");
  document.getElementById("total-std").textContent = totalStd.toLocaleString("id-ID");
}

// Fungsi format khusus untuk badges
function formatBadgeNumber(num) {
  if (num === "-") return "-";
  num = parseInt(num);
  if (Math.abs(num) >= 1000000) {
    return (num / 1000000).toFixed(1) + 'Juta';
  }
  if (Math.abs(num) >= 1000) {
    return (num / 1000).toFixed(1) + 'Ribu';
  }
  return num.toString();
}

      // Fungsi untuk memformat nama bulan dari YYYY-MM
      function formatMonth(monthKey) {
        const [year, month] = monthKey.split("-");
        const monthNames = [
          "Januari",
          "Februari",
          "Maret",
          "April",
          "Mei",
          "Juni",
          "Juli",
          "Agustus",
          "September",
          "Oktober",
          "November",
          "Desember",
        ];
        return `${monthNames[parseInt(month) - 1]} ${year}`;
      }

      // Panggil fungsi fetchData saat halaman dimuat
      document.addEventListener("DOMContentLoaded", fetchData);
    </script>
  </body>
</html>
