<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Rincian Selisih Stok</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
      background-color: #f8fafc;
      line-height: 1.6;
    }
    @media screen and (-webkit-min-device-pixel-ratio:0) {
      select, textarea, input { font-size: 16px !important; }
    }
    .diff-card {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-bottom: 16px;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    .diff-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .diff-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(to bottom, #0d6efd, #0dcaf0);
      border-radius: 10px 0 0 10px;
      opacity: 0.7;
    }
    .diff-card.positive::before {
      background: linear-gradient(to bottom, #10b981, #34d399);
    }
    .diff-card.negative::before {
      background: linear-gradient(to bottom, #ef4444, #f87171);
    }
    .diff-card .plu-col {
      position: relative;
      z-index: 1;
      width: 15%; min-width: 70px; font-weight: 600; 
    }
    .diff-card .desc-col { 
      position: relative;
      z-index: 1;
      width: 45%; min-width: 120px; color: #475569; font-size: 0.95rem; 
    }
    .diff-card .diff-col { 
      position: relative;
      z-index: 1;
      width: 20%; min-width: 80px; text-align: right; font-weight: 700; font-size: 1.1rem; 
    }
    .diff-card .btn-col { 
      position: relative;
      z-index: 1;
      width: 20%; min-width: 80px; text-align: right; 
    }
    .diff-positive { color: #10b981; }
    .diff-negative { color: #ef4444; }
    .old-value {
      font-weight: 600;
      color: #64748b;
      background-color: #f1f5f9;
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 0.95rem;
    }
    .btn-sm { 
      padding: 0.3rem 0.6rem; 
      font-size: 0.85rem;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .btn-sm:hover {
      transform: scale(1.05);
    }
    #toastContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
    }
    .sticky-search {
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .progress-section {
      background: rgba(13, 110, 253, 0.1);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .progress-bar-custom {
      background: linear-gradient(to right, #0d6efd, #0dcaf0);
      border-radius: 10px;
    }
    .alert-custom {
      border-left: 4px solid #0d6efd;
      border-radius: 6px;
      background: rgba(13, 110, 253, 0.1);
      margin-bottom: 1rem;
    }
    footer {
      background: #1e293b;
      color: #cbd5e1;
    }
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #94a3b8;
    }
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #0d6efd;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .modal-content {
      border-radius: 16px;
      border: none;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    .modal-header {
      border-bottom: 1px solid #e2e8f0;
      padding: 1.5rem;
      background: #0d6efd;
      color: white;
    }
    .modal-body {
      padding: 1.5rem;
    }
    .modal-footer {
      border-top: 1px solid #e2e8f0;
      padding: 1rem 1.5rem;
    }
    .form-label {
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
    }
    /* Sembunyikan spinner arrows pada input number */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }
    @media (max-width: 575px) {
      .diff-card .plu-col { width: 20%; min-width: 60px; }
      .diff-card .desc-col { width: 40%; min-width: 100px; font-size: 0.85rem; }
      .diff-card .diff-col { width: 25%; min-width: 70px; font-size: 1rem; }
      .diff-card .btn-col { width: 15%; min-width: 60px; }
      .diff-card {
        padding: 0.75rem 1rem;
        margin-bottom: 16px;
      }
      .modal-dialog {
        margin: 0.5rem;
      }
      .modal-body {
        padding: 1rem;
      }
      .modal-header, .modal-footer {
        padding: 1rem;
      }
    }
  </style>
</head>
<body class="d-flex flex-column min-vh-100 bg-light">

<div class="container py-4">
  <h2 class="mb-4 text-center fw-bold text-primary">
    <i class="bi bi-graph-up-arrow me-2"></i>Selisih Stok
  </h2>
  
  <!-- Alert untuk instruksi singkat -->
  <div class="alert alert-info alert-custom d-flex align-items-center" role="alert">
    <i class="bi bi-info-circle-fill me-2"></i>
    <div>Periksa dan koreksi selisih antara stok sistem dan fisik. Total selisih: <span id="totalDiff" class="fw-bold">0</span></div>
  </div>
  
  <!-- Progress Section untuk UX -->
  <div class="progress-section">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <span class="text-muted small">Progres Koreksi Selisih</span>
      <span class="text-muted small" id="completedCount">0 / <span id="totalData">0</span></span>
    </div>
    <div class="progress" style="height: 6px;">
      <div class="progress-bar progress-bar-custom" id="progressBar" role="progressbar" style="width: 0%"></div>
    </div>
  </div>

  <div class="sticky-top bg-white py-3 shadow-sm sticky-search" style="margin-top: -1.5rem; margin-bottom: 1.5rem;">
    <div class="container">
      <div class="input-group">
        <span class="input-group-text bg-primary text-white"><i class="bi bi-search"></i></span>
        <input type="text" id="searchInput" class="form-control debounce-input" placeholder="Cari PLU atau Deskripsi...">
        <button class="btn btn-outline-secondary" type="button" id="clearSearch" title="Hapus pencarian">
          <i class="bi bi-x-circle"></i>
        </button>
      </div>
    </div>
  </div>

  <div id="diffCards" aria-live="polite"></div>
  <div id="noDiffMessage" class="text-center text-muted d-none empty-state">
    <i class="bi bi-check-circle"></i>
    <h5 class="fw-bold text-success">Tidak ada selisih stok.</h5>
    <p class="mb-0">Semua stok sesuai antara sistem dan fisik. Lanjutkan ke submit!</p>
  </div>

  <!-- Form Metadata -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h6 class="card-title fw-bold mb-3">
        <i class="bi bi-person-lines-fill me-2"></i>Metadata Serah Terima
      </h6>
      <div class="row g-3">
        <div class="col-md-4">
          <label for="namaPenerima" class="form-label">
            <i class="bi bi-person-plus me-1 text-primary"></i>Nama Penerima
          </label>
          <input type="text" id="namaPenerima" class="form-control" placeholder="Nama lengkap" aria-describedby="penerimaHelp">
          <div id="penerimaHelp" class="form-text">Penerima shift selanjutnya</div>
        </div>
        <div class="col-md-4">
          <label for="namaPenyerahan" class="form-label">
            <i class="bi bi-person-check me-1 text-primary"></i>Nama Penyerahan
          </label>
          <input type="text" id="namaPenyerahan" class="form-control" placeholder="Nama lengkap" aria-describedby="penyerahanHelp">
          <div id="penyerahanHelp" class="form-text">Penyerah shift saat ini</div>
        </div>
        <div class="col-md-4">
          <label for="shift" class="form-label">
            <i class="bi bi-clock me-1 text-primary"></i>Shift
          </label>
          <select id="shift" class="form-select" aria-describedby="shiftHelp">
            <option value="">Pilih Shift</option>
            <option value="Pagi">Pagi</option>
            <option value="Siang">Siang</option>
            <option value="Malam">Malam</option>
          </select>
          <div id="shiftHelp" class="form-text">Shift yang sedang berlangsung</div>
        </div>
      </div>
    </div>
  </div>

  <div class="text-center mt-4">
    <button id="submitBtn" class="btn btn-success btn-lg" aria-label="Kirim data ke Google Sheet">
      <span class="loading d-none" role="status" aria-hidden="true"></span>
      <i class="bi bi-cloud-upload me-2"></i>Kirim ke Google Sheet
    </button>
  </div>
</div>

<div id="toastContainer" aria-live="polite" aria-atomic="true"></div>

<!-- Modal Detail -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true" aria-labelledby="detailModalLabel">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title fw-bold" id="detailModalLabel">
          <i class="bi bi-gear me-2"></i>Detail Stok & Koreksi
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Tutup modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editIndex">
        <div class="mb-3">
          <label class="form-label fw-bold">
            <i class="bi bi-tag me-1 text-primary"></i>PLU
          </label>
          <input type="text" class="form-control" id="plu" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">
            <i class="bi bi-card-text me-1 text-primary"></i>Description
          </label>
          <input type="text" class="form-control" id="description" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">
            <i class="bi bi-building me-1 text-primary"></i>Qty Gudang
          </label>
          <div class="d-flex align-items-center mb-1">
            <span class="old-value me-2" id="gudangOld"></span>
          </div>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-pencil-square"></i></span>
            <input type="number" class="form-control" id="qtyGudang" min="0">
            <span class="input-group-text" id="gudangTimestamp"></span>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-6">
            <label class="form-label fw-bold">
              <i class="bi bi-archive me-1 text-primary"></i>Qty Rak
            </label>
            <div class="d-flex align-items-center mb-1">
              <span class="old-value me-2" id="rakOld"></span>
            </div>
            <input type="number" class="form-control" id="qtyRak" min="0" placeholder="Qty Rak (angka)">
          </div>
          <div class="col-6">
            <label class="form-label fw-bold">
              <i class="bi bi-shelf me-1 text-primary"></i>Qty Ambalan
            </label>
            <div class="d-flex align-items-center mb-1">
              <span class="old-value me-2" id="ambalanOld"></span>
            </div>
            <input type="number" class="form-control" id="qtyAmbalan" min="0" placeholder="Qty Ambalan (angka)">
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-6">
            <label class="form-label fw-bold">
              <i class="bi bi-shop me-1 text-primary"></i>Qty Gondola
            </label>
            <div class="d-flex align-items-center mb-1">
              <span class="old-value me-2" id="gondolaOld"></span>
            </div>
            <input type="number" class="form-control" id="qtyGondola" min="0" placeholder="Qty Gondola (angka)">
          </div>
          <div class="col-6">
            <label class="form-label fw-bold">
              <i class="bi bi-hand-thumbs-up me-1 text-primary"></i>On Hand
            </label>
            <div class="d-flex align-items-center mb-1">
              <span class="old-value me-2" id="onHandOld"></span>
            </div>
            <input type="number" class="form-control" id="onHand" min="0" placeholder="On Hand (angka)">
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">
            <i class="bi bi-calculator me-1 text-primary"></i>Qty Total
          </label>
          <div class="d-flex align-items-center mb-1">
            <span class="old-value me-2" id="totalOld"></span>
          </div>
          <input type="number" class="form-control bg-light" id="qtyTotal" readonly>
        </div>
        <!-- Alert di modal untuk peringatan input -->
        <div class="alert alert-warning alert-dismissible fade show" role="alert" id="inputAlert" style="display: none;">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          Pastikan input angka valid untuk menghindari kesalahan perhitungan.
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i>Batal
        </button>
        <button type="button" class="btn btn-primary" id="saveChanges" aria-label="Simpan perubahan detail stok">
          <i class="bi bi-check-circle me-1"></i>Simpan Perubahan
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Sticky Footer -->
<footer class="bg-dark text-light text-center py-2 mt-auto" style="position: sticky; bottom: 0; z-index: 100;">
  <small>© 2025 Stok Opname System • v1.1</small>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  if (sessionStorage.getItem('stokOpnameStep') !== '2') {
    window.location.replace('stok-opname.html');
  }

  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzGxxKfoQb-foVN3wrmSkdBQJD-vrID0FwHGRRoXQd6lOgz04C-jUTz2Jv7FyO-668i/exec';
  let stockData = JSON.parse(localStorage.getItem('stok_opname_session')) || [];
  const originalData = JSON.parse(JSON.stringify(stockData));

  stockData.forEach((item, i) => item.originalIndex = i);

  function calculateTotal(g, r, a, gond) {
    return (g || 0) + (r || 0) + (a || 0) + (gond || 0);
  }

  function showLoading(element, show = true) {
    const spinner = element.querySelector('.loading');
    if (spinner) {
      spinner.classList.toggle('d-none', !show);
    }
  }

  function updateProgress() {
    const totalDiff = stockData.filter(item => (item.qtyTotal || 0) - (item.onHand || 0) !== 0).length;
    const completed = stockData.filter(item => {
      const origSelisih = (originalData.find(o => o.plu === item.plu).qtyTotal || 0) - (originalData.find(o => o.plu === item.plu).onHand || 0);
      const newSelisih = (item.qtyTotal || 0) - (item.onHand || 0);
      return origSelisih !== 0 && newSelisih === 0;
    }).length;
    document.getElementById('completedCount').innerHTML = `${completed} / <span id="totalData">${totalDiff}</span>`;
    document.getElementById('totalDiff').textContent = totalDiff;
    const percentage = totalDiff > 0 ? (completed / totalDiff) * 100 : 100;
    document.getElementById('progressBar').style.width = `${percentage}%`;
  }

  function renderDiffCards(data = stockData) {
    const items = data.map(item => ({
      ...item,
      selisih: (item.qtyTotal || 0) - (item.onHand || 0)
    })).filter(item => item.selisih !== 0);

    const c = document.getElementById('diffCards');
    const n = document.getElementById('noDiffMessage');
    c.innerHTML = '';

    if (items.length === 0) {
      n.classList.remove('d-none');
    } else {
      n.classList.add('d-none');
      items.forEach(item => {
        const cls = item.selisih > 0 ? 'diff-positive positive' : 'diff-negative negative';
        const val = item.selisih > 0 ? `+${item.selisih}` : `${item.selisih}`;
        c.innerHTML += `
          <div class="diff-card ${cls}">
            <div class="plu-col">${item.plu}</div>
            <div class="desc-col">${item.description}</div>
            <div class="diff-col ${cls}">${val}</div>
            <div class="btn-col">
              <button class="btn btn-outline-primary btn-sm" onclick="openDetail(${item.originalIndex})" title="Lihat Detail">
                <i class="bi bi-eye"></i>
              </button>
            </div>
          </div>
        `;
      });
      // Keyboard navigation
      document.querySelectorAll('.diff-card').forEach((card, index) => {
        card.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openDetail(items[index].originalIndex);
          }
        });
      });
    }
    updateProgress();
  }

  window.openDetail = function(idx) {
    if (isNaN(idx) || idx < 0 || idx>= stockData.length || !stockData[idx]) {
      console.error('Invalid item index:', idx);
      showToast('Data item tidak valid. Silakan refresh halaman.', 'danger');
      return;
    }

    const old = originalData[idx];
    const cur = stockData[idx];

    document.getElementById('editIndex').value = idx;
    document.getElementById('plu').value = cur.plu;
    document.getElementById('description').value = cur.description;
    document.getElementById('gudangOld').textContent = `Old: ${old.qtyGudang || 0}`;
    document.getElementById('rakOld').textContent = `Old: ${old.qtyRak || 0}`;
    document.getElementById('ambalanOld').textContent = `Old: ${old.qtyAmbalan || 0}`;
    document.getElementById('gondolaOld').textContent = `Old: ${old.qtyGondola || 0}`;
    document.getElementById('onHandOld').textContent = `Old: ${old.onHand || 0}`;
    document.getElementById('totalOld').textContent = `Old: ${old.qtyTotal || 0}`;

    document.getElementById('qtyGudang').value = cur.qtyGudang || 0;
    document.getElementById('qtyRak').value = cur.qtyRak || 0;
    document.getElementById('qtyAmbalan').value = cur.qtyAmbalan || 0;
    document.getElementById('qtyGondola').value = cur.qtyGondola || 0;
    document.getElementById('onHand').value = cur.onHand || 0;
    document.getElementById('qtyTotal').value = cur.qtyTotal || 0;
    document.getElementById('gudangTimestamp').textContent = cur.gudangLastUpdate || '';

    const autoCalc = () => {
      const g = parseInt(document.getElementById('qtyGudang').value) || 0;
      const r = parseInt(document.getElementById('qtyRak').value) || 0;
      const a = parseInt(document.getElementById('qtyAmbalan').value) || 0;
      const gond = parseInt(document.getElementById('qtyGondola').value) || 0;
      const total = calculateTotal(g, r, a, gond);
      document.getElementById('qtyTotal').value = total;
      
      const alertEl = document.getElementById('inputAlert');
      if (total !== cur.qtyTotal) {
        alertEl.style.display = 'block';
        setTimeout(() => { alertEl.style.display = 'none'; }, 5000);
      }
    };

    // Event listeners
    document.getElementById('qtyGudang').oninput = () => {
      document.getElementById('gudangTimestamp').textContent = new Date().toISOString().split('T')[0];
      autoCalc();
    };
    document.getElementById('qtyRak').oninput = autoCalc;
    document.getElementById('qtyAmbalan').oninput = autoCalc;
    document.getElementById('qtyGondola').oninput = autoCalc;

    autoCalc();

    const saveChangesBtn = document.getElementById('saveChanges');
    const originalOnclick = saveChangesBtn.onclick;
    saveChangesBtn.onclick = () => {
      const item = stockData[idx];
      item.qtyGudang = parseInt(document.getElementById('qtyGudang').value) || 0;
      item.qtyRak = parseInt(document.getElementById('qtyRak').value) || 0;
      item.qtyAmbalan = parseInt(document.getElementById('qtyAmbalan').value) || 0;
      item.qtyGondola = parseInt(document.getElementById('qtyGondola').value) || 0;
      item.onHand = parseInt(document.getElementById('onHand').value) || 0;
      item.qtyTotal = parseInt(document.getElementById('qtyTotal').value) || 0;
      item.gudangLastUpdate = document.getElementById('gudangTimestamp').textContent;
      localStorage.setItem('stok_opname_session', JSON.stringify(stockData));
      renderDiffCards();
      bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();
      showToast('Perubahan berhasil disimpan!', 'success');
    };

    new bootstrap.Modal(document.getElementById('detailModal')).show();
  };

  function showToast(msg, type = 'success') {
    const c = document.getElementById('toastContainer');
    const color = type === 'success' ? 'bg-success' : 'bg-danger';
    const icon = type === 'success' ? 'bi bi-check-circle-fill' : 'bi bi-exclamation-triangle-fill';
    const el = document.createElement('div');
    el.className = `toast align-items-center text-white ${color} border-0 shadow-lg`;
    el.role = 'alert';
    el.ariaLive = 'assertive';
    el.ariaAtomic = 'true';
    el.innerHTML = `
      <div class="d-flex">
        <div class="toast-body d-flex align-items-center">
          <i class="${icon} me-2"></i>${msg}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Tutup"></button>
      </div>
    `;
    c.appendChild(el);
    const toast = new bootstrap.Toast(el, { autohide: true, delay: 4000 });
    toast.show();
    el.addEventListener('hidden.bs.toast', () => el.remove());
  }

  document.getElementById('submitBtn').onclick = () => {
    const btn = document.getElementById('submitBtn');
    const penerima = document.getElementById('namaPenerima').value.trim();
    const penyerahan = document.getElementById('namaPenyerahan').value.trim();
    const shift = document.getElementById('shift').value;

    if (!penerima || !penyerahan || !shift) {
      showToast('Harap lengkapi Nama Penerima, Penyerahan, dan Shift.', 'danger');
      return;
    }

    btn.disabled = true;
    showLoading(btn, true);

    // Kirim ke HISTORY
    const payload = stockData.map(item => {
      const orig = originalData.find(x => x.plu === item.plu);
      const gudangEdit = item.qtyGudang - orig.qtyGudang;
      const rakEdit = item.qtyRak - orig.qtyRak;
      const ambalanEdit = item.qtyAmbalan - orig.qtyAmbalan;
      const gondolaEdit = item.qtyGondola - orig.qtyGondola;
      const onHandEdit = item.onHand - orig.onHand;
      const selisihAwal = orig.qtyTotal - orig.onHand;
      const selisihUpdate = item.qtyTotal - item.onHand;

      return {
        tanggal: new Date().toISOString().split('T')[0],
        plu: item.plu,
        description: item.description,
        gudangAwal: orig.qtyGudang,
        rakAwal: orig.qtyRak,
        ambalanAwal: orig.qtyAmbalan,
        gondolaAwal: orig.qtyGondola,
        totalAwal: orig.qtyTotal,
        onHandAwal: orig.onHand,
        selisihAwal: selisihAwal,
        gudangEdit: gudangEdit,
        rakEdit: rakEdit,
        ambalanEdit: ambalanEdit,
        gondolaEdit: gondolaEdit,
        onHandEdit: onHandEdit,
        selisihUpdate: selisihUpdate,
        namaPenerima: penerima,
        namaPenyerahan: penyerahan,
        shift: shift
      };
    });

    fetch(SCRIPT_URL, {
      method: 'POST',
      
      body: JSON.stringify({ action: 'submitHistory', payload })
    })
    .then(res => {
      if (!res.ok) throw new Error('Gagal simpan ke HISTORY');
      return res.json();
    })
    .then(result => {
      if (result.status !== 'success') throw new Error('Gagal simpan ke HISTORY');

      // Update INVENTORY
      const updates = stockData.map(item => ({ plu: item.plu, qtyGudang: item.qtyGudang }));
      return fetch(SCRIPT_URL, {
        method: 'POST',
        
        body: JSON.stringify({ action: 'updateInventory', data: updates })
      });
    })
    .then(res => {
      if (!res.ok) throw new Error('Gagal memperbarui Inventory');
      return res.json();
    })
    .then(result => {
      if (result.status === 'success') {
        showToast('Data berhasil dikirim dan Inventory diperbarui!', 'success');
        localStorage.removeItem('stok_opname_session');
        sessionStorage.removeItem('stokOpnameStep');
        setTimeout(() => window.location.replace('stok-opname.html'), 2000);
      } else {
        throw new Error('Gagal memperbarui Inventory');
      }
    })
    .catch(err => {
      console.error(err);
      showToast('Terjadi kesalahan: ' + err.message, 'danger');
    })
    .finally(() => {
      btn.disabled = false;
      showLoading(btn, false);
    });
  };

  // Clear search button
  document.getElementById('clearSearch').onclick = () => {
    document.getElementById('searchInput').value = '';
    renderDiffCards();
  };

  // Debounced search
  let searchTimeout;
  document.getElementById('searchInput').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      const term = this.value.toLowerCase().trim();
      if (term === '') {
        renderDiffCards();
      } else {
        const filtered = stockData.filter(item =>
          item.plu.toString().includes(term) || 
          item.description.toLowerCase().includes(term)
        );
        renderDiffCards(filtered);
      }
    }, 300);
  });

  renderDiffCards();

  // Auto-focus search
  window.addEventListener('load', () => {
    document.getElementById('searchInput').focus();
  });
</script>
</body>
</html>
