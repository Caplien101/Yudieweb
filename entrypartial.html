<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Entry Data</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f3f4f6;
    }
    h1 {
      font-weight: bold;
      color: #333;
    }
    .card-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .data-card {
      width: 100%;
      max-width: 350px;
      padding: 1rem;
      border-radius: 10px;
      background-color: #ffffff;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }
    .data-card:hover {
      transform: translateY(-5px);
    }
    .card-title {
      font-size: 0.9rem;
      font-weight: 500;
      color: #007bff;
    }
    .card-content {
      font-size: 0.9rem;
      color: #666;
    }
    .btn-custom {
      background-color: #007bff;
      color: white;
      margin-top: 10px;
      width: 100%;
    }
    .btn-custom:hover {
      background-color: #0056b3;
    }
    .spinner-border {
      width: 1rem;
      height: 1rem;
    }
    .footer {
      background-color: #333;
      color: #fff;
      text-align: center;
      padding: 1rem;
      position: relative;
      bottom: 0;
      width: 100%;
    }
    .footer a {
      color: #007bff;
      text-decoration: none;
    }
    .footer a:hover {
      color: #0056b3;
    }
    @media (max-width: 576px) {
      .card-container {
        flex-direction: column;
        align-items: center;
      }
      .data-card {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>

<div class="container mt-5">
  <h1 class="text-center mb-4">SO MANUAL - ENTRY DATA</h1>
  
  <div id="alertContainer"></div>

  <div class="input-group mb-3">
    <input type="text" id="filterInput" class="form-control" placeholder="Masukkan Nomor Rak (dengan huruf capital)">
    <button class="btn btn-custom" id="loadButton" onclick="loadFilteredData()">
      <span id="loadSpinner" class="spinner-border spinner-border-sm d-none"></span> Ambil Data
    </button>
  </div>

  <div class="card-container" id="dataCardContainer">
    <!-- Cards will be added here dynamically -->
  </div>

  <button class="btn btn-custom" id="sendButton" onclick="saveData()">
    <span id="sendSpinner" class="spinner-border spinner-border-sm d-none"></span> Simpan Entry
  </button>
</div>

<footer class="footer mt-5">
  <p>&copy; 2024 Pramuka Apps. All rights reserved.</p>
</footer>

<script>
  const scriptURL = 'https://script.google.com/macros/s/AKfycbyXKWF8GrSjUi1NHIsFNEPj7XNe0WKkCO-TY_aGmvfheM7YerRtOuyS4pQvB9AuT4kCkg/exec';
  
  function showAlert(message, type) {
    const alertContainer = document.getElementById('alertContainer');
    const icon = type === 'success' ? 'fa-check-circle' : type === 'danger' ? 'fa-exclamation-circle' : 'fa-info-circle';
    
    alertContainer.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show d-flex align-items-center" role="alert">
        <i class="fas ${icon} me-2"></i>
        <span>${message}</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    `;
    
    setTimeout(() => {
      const alertElement = document.querySelector('.alert');
      if (alertElement) alertElement.classList.remove('show');
    }, 3000);
  }
  
  async function loadFilteredData() {
    const filterValue = document.getElementById('filterInput').value.trim();
    const loadButton = document.getElementById('loadButton');
    const loadSpinner = document.getElementById('loadSpinner');
  
    loadSpinner.classList.remove('d-none');
    loadButton.disabled = true;
  
    try {
      const response = await fetch(`${scriptURL}?rak=${encodeURIComponent(filterValue)}`);
      const result = await response.json();
  
      if (result.result === 'success' && result.data.length > 0) {
        localStorage.setItem('filteredData', JSON.stringify(result.data));
        displayData(result.data);
        showAlert('Data loaded successfully!', 'success');
      } else {
        showAlert('No data found for the specified Rak.', 'danger');
      }
    } catch (error) {
      console.error('Fetch error:', error);
      showAlert('Error loading data. Please try again.', 'danger');
    } finally {
      loadSpinner.classList.add('d-none');
      loadButton.disabled = false;
    }
  }
  
  function displayData(data) {
    const cardContainer = document.getElementById('dataCardContainer');
    cardContainer.innerHTML = '';
  
    data.forEach((row, index) => {
      const card = document.createElement('div');
      card.className = 'data-card';
      card.innerHTML = `
        <div class="card-title">Rak: ${row.rak}</div>
        <div class="card-content">Plu: ${row.plu}</div>
        <div class="card-content">Des: ${row.desc}</div>
        <div class="input-group mt-2">
          <span class="input-group-text">Qty</span>
          <input name="qty_${index}" class="form-control" value="${row.qty}" 
                 aria-label="Quantity" data-index="${index}" oninput="updateQty(${index}, this.value)">
        </div>
      `;
      cardContainer.appendChild(card);
    });
  }
  
  function updateQty(index, newQty) {
    let data = JSON.parse(localStorage.getItem('filteredData')) || [];
    if (data[index]) {
      data[index].qty = newQty;
      localStorage.setItem('filteredData', JSON.stringify(data));
    }
  }
  
  function saveData() {
    const data = JSON.parse(localStorage.getItem('filteredData'));
    if (data && data.length > 0) {
      localStorage.setItem('onHandData', JSON.stringify(data));
      showAlert('Data saved successfully!', 'success');
      window.location.href = 'OnHand.html';
    } else {
      showAlert('No data to save. Please load data first.', 'warning');
    }
  }
  
  document.addEventListener('DOMContentLoaded', () => {
    localStorage.removeItem('filteredData');
    localStorage.removeItem('onHandData');
    document.getElementById('dataCardContainer').innerHTML = '';

    const savedData = JSON.parse(localStorage.getItem('filteredData'));
    if (savedData && savedData.length > 0) {
      displayData(savedData);
      showAlert('Loaded data from previous session.', 'info');
    }
  });
</script>

</body>
</html>
